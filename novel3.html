<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š å°èªªç´ æåº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #a78bfa;
            --accent: #f472b6;
            --bg-dark: #0f172a;
            --bg-light: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-light) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ç™»å…¥é é¢ */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .password-input {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* å°èˆªæ¬„ */
        .navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: var(--primary);
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* é é¢æ¨™é¡Œ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .page-title {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        /* æ¨™ç±¤ */
        .tag {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            background: rgba(99, 102, 241, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(99, 102, 241, 0.3);
            transition: all 0.3s;
        }

        .tag:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: scale(1.05);
        }

        .tag.tag-hero { background: rgba(16, 185, 129, 0.2); color: #10b981; border-color: rgba(16, 185, 129, 0.3); }
        .tag.tag-villain { background: rgba(239, 68, 68, 0.2); color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
        .tag.tag-support { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }

        /* æŒ‰éˆ• */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* è¡¨å–® */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: rgba(15, 23, 42, 0.5);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* æœå°‹æ¬„ */
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        /* çµ±è¨ˆè³‡è¨Š */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(167, 139, 250, 0.1));
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(99, 102, 241, 0.3);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* ç·¨è¼¯é é¢ */
        .edit-page {
            max-width: 800px;
            margin: 0 auto;
        }

        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* AIåŠ©æ‰‹ */
        .ai-assistant {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.1), rgba(99, 102, 241, 0.1));
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(244, 114, 182, 0.3);
        }

        .material-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .material-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .material-item:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .material-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .nav-menu {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(15, 23, 42, 0.95);
                backdrop-filter: blur(10px);
                padding: 1rem;
                display: flex;
                justify-content: space-around;
                box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.3);
            }

            .nav-container {
                padding: 0;
            }

            .main-container {
                padding: 0 1rem;
                margin-bottom: 5rem;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* è¼‰å…¥å‹•ç•« */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* è­¦å‘Šæç¤º */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.5);
            color: var(--warning);
        }

        /* ç§˜å¯†è¨­å®šçš„ç‰¹æ®Šæ¨£å¼ */
        .secret-warning {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1));
            border: 2px solid rgba(239, 68, 68, 0.5);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* å¤šé¸ä¸‹æ‹‰æ¡† */
        .multi-select {
            position: relative;
        }

        .multi-select-input {
            cursor: pointer;
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid var(--border);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-primary);
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .multi-select-option:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .multi-select-option input {
            cursor: pointer;
        }

        /* å¿«é€Ÿåˆ†é¡åŠ©æ‰‹ */
        .quick-classifier {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(99, 102, 241, 0.1));
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .content-preview {
            background: rgba(15, 23, 42, 0.5);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .content-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, rgba(15, 23, 42, 0.5));
        }

        .ai-suggestion {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* å½©è‰²åœ–æ¨™ */
        .icon-character { color: #f472b6; }
        .icon-background { color: #60a5fa; }
        .icon-secret { color: #fb923c; }
        .icon-novel { color: #a78bfa; }
        .icon-ai { color: #34d399; }

        /* åœ¨æ‰€æœ‰CSSçš„æœ€å¾Œé¢æ·»åŠ é€™æ®µ */
        /* ç¢ºä¿è¼¸å…¥æ¡†å¯é»æ“Š */
        .form-input {
            pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
        }
        
        /* ä¿®å¾©å¯èƒ½çš„å±¤ç´šå•é¡Œ */
        .card .form-input {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>ğŸ“š å°èªªç´ æåº«</h1>
            <input type="password" class="password-input" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeypress="if(event.key==='Enter') login()">
            <button class="login-btn" onclick="login()">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ -->
    <div id="app" style="display: none;">
        <!-- å°èˆªæ¬„ -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">ğŸ“š å°èªªç´ æåº«</div>
                <div class="nav-menu">
                    <div class="nav-item" onclick="showPage('dashboard')">ğŸ“Š ç¸½è¦½</div>
                    <div class="nav-item" onclick="showPage('characters')">ğŸ‘¤ è§’è‰²</div>
                    <div class="nav-item" onclick="showPage('backgrounds')">ğŸŒ èƒŒæ™¯</div>
                    <div class="nav-item" onclick="showPage('secrets')">ğŸ” ç§˜å¯†</div>
                    <div class="nav-item" onclick="showPage('novels')">ğŸ“– å°èªª</div>
                    <div class="nav-item" onclick="showPage('ai')">ğŸ¤– AIåŠ©æ‰‹</div>
                    <div class="nav-item" onclick="showPage('settings')">âš™ï¸ è¨­å®š</div>
                    <div class="nav-item" onclick="logout()">ğŸšª ç™»å‡º</div>
                </div>
            </div>
        </nav>

        <!-- ä¸»å…§å®¹å€ -->
        <div class="main-container">
            <div id="pageContent"></div>
        </div>
    </div>

    <script>
        // è³‡æ–™çµæ§‹
        let data = {
            characters: [],
            backgrounds: [],
            secrets: [],
            novels: [],
            settings: {
                password: 'admin',
                autoBackup: true,
                googleDriveToken: null,
                options: {
                    characterTags: ['ä¸»è§’', 'é…è§’', 'åæ´¾', 'è·¯äºº', 'NPC'],
                    hairColors: ['é»‘è‰²', 'æ£•è‰²', 'é‡‘è‰²', 'ç´…è‰²', 'ç™½è‰²', 'è—è‰²', 'ç¶ è‰²', 'ç´«è‰²', 'éŠ€è‰²', 'å…¶ä»–'],
                    eyeColors: ['é»‘è‰²', 'æ£•è‰²', 'è—è‰²', 'ç¶ è‰²', 'ç°è‰²', 'ç´…è‰²', 'ç´«è‰²', 'é‡‘è‰²', 'ç•°è‰²ç³', 'å…¶ä»–'],
                    backgroundTypes: ['åœ°é»', 'æ™‚ä»£', 'ä¸–ç•Œè§€', 'æ–‡åŒ–', 'çµ„ç¹”', 'åœ‹å®¶', 'å…¶ä»–'],
                    secretCategories: ['åŠ‡æƒ…è½‰æŠ˜', 'è§’è‰²ç§˜å¯†', 'ä¸–ç•Œè¨­å®š', 'ä¼ç­†', 'çµå±€', 'é—œä¿‚ç§˜å¯†', 'å…¶ä»–'],
                    aiTemplates: []
                }
            }
        };

        // åˆå§‹åŒ–
        window.onload = function() {
            loadData();
            if (localStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                showPage('dashboard');
            }
        };

        // ç™»å…¥åŠŸèƒ½
        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === data.settings.password) {
                localStorage.setItem('isLoggedIn', 'true');
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                showPage('dashboard');
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            localStorage.removeItem('isLoggedIn');
            location.reload();
        }

        // è³‡æ–™å­˜å–
        function loadData() {
            const saved = localStorage.getItem('novelMaterialData');
            if (saved) {
                const loadedData = JSON.parse(saved);
                // ç¢ºä¿æœ‰é¸é …è¨­å®š
                if (!loadedData.settings.options) {
                    loadedData.settings.options = {
                        characterTags: ['ä¸»è§’', 'é…è§’', 'åæ´¾', 'è·¯äºº', 'NPC'],
                        hairColors: ['é»‘è‰²', 'æ£•è‰²', 'é‡‘è‰²', 'ç´…è‰²', 'ç™½è‰²', 'è—è‰²', 'ç¶ è‰²', 'ç´«è‰²', 'éŠ€è‰²', 'å…¶ä»–'],
                        eyeColors: ['é»‘è‰²', 'æ£•è‰²', 'è—è‰²', 'ç¶ è‰²', 'ç°è‰²', 'ç´…è‰²', 'ç´«è‰²', 'é‡‘è‰²', 'ç•°è‰²ç³', 'å…¶ä»–'],
                        backgroundTypes: ['åœ°é»', 'æ™‚ä»£', 'ä¸–ç•Œè§€', 'æ–‡åŒ–', 'çµ„ç¹”', 'åœ‹å®¶', 'å…¶ä»–'],
                        secretCategories: ['åŠ‡æƒ…è½‰æŠ˜', 'è§’è‰²ç§˜å¯†', 'ä¸–ç•Œè¨­å®š', 'ä¼ç­†', 'çµå±€', 'é—œä¿‚ç§˜å¯†', 'å…¶ä»–'],
                        aiTemplates: []
                    };
                }
                data = loadedData;
            }
        }

        function saveData() {
            localStorage.setItem('novelMaterialData', JSON.stringify(data));
            if (data.settings && data.settings.autoBackup) {
                // é€™è£¡å¯ä»¥åŠ å…¥ Google Drive è‡ªå‹•å‚™ä»½
            }
        }

        // é é¢è·¯ç”±
        function showPage(page) {
            // æ›´æ–°å°èˆªæ¬„
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // é¡¯ç¤ºå°æ‡‰é é¢
            const content = document.getElementById('pageContent');
            content.classList.remove('fade-in');
            
            setTimeout(() => {
                switch(page) {
                    case 'dashboard':
                        showDashboard();
                        break;
                    case 'characters':
                        showCharacters();
                        break;
                    case 'backgrounds':
                        showBackgrounds();
                        break;
                    case 'secrets':
                        showSecrets();
                        break;
                    case 'novels':
                        showNovels();
                        break;
                    case 'ai':
                        showAI();
                        break;
                    case 'settings':
                        showSettings();
                        break;
                }
                content.classList.add('fade-in');
            }, 100);
        }

        // ç¸½è¦½é é¢
        function showDashboard() {
            const totalWords = calculateTotalWords();
            const recentItems = getRecentItems();
            
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">ğŸ“Š ç¸½è¦½</h1>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.characters.length}</div>
                        <div class="stat-label">è§’è‰²ç¸½æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.backgrounds.length}</div>
                        <div class="stat-label">èƒŒæ™¯è¨­å®š</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.secrets.length}</div>
                        <div class="stat-label">ç§˜å¯†è¨­å®š</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.novels.length}</div>
                        <div class="stat-label">AIå°èªª</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalWords}</div>
                        <div class="stat-label">ç¸½å­—æ•¸</div>
                    </div>
                </div>

                <h2 style="margin: 2rem 0 1rem;">ğŸ• æœ€è¿‘æ›´æ–°</h2>
                <div id="recentItems">
                    ${recentItems.map(item => `
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">${item.icon} ${item.title}</div>
                                    <div class="card-meta">
                                        <span class="tag">${item.type}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.875rem;">
                                            ${new Date(item.updatedAt).toLocaleDateString()}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="quick-classifier">
                    <h3 style="margin-bottom: 1rem;">âš¡ å¿«é€Ÿåˆ†é¡åŠ©æ‰‹</h3>
                    <div class="content-preview">
                        <textarea id="quickContent" class="form-textarea" placeholder="è²¼ä¸Šæˆ–è¼¸å…¥å…§å®¹..." style="min-height: 80px;"></textarea>
                    </div>
                    <div class="ai-suggestion" id="aiSuggestion" style="display: none;">
                        ğŸ¤– ç³»çµ±å»ºè­°ï¼š<span id="suggestionText"></span>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-secondary" onclick="quickClassify('character')">ğŸ‘¤ å­˜ç‚ºè§’è‰²</button>
                        <button class="btn btn-secondary" onclick="quickClassify('background')">ğŸŒ å­˜ç‚ºèƒŒæ™¯</button>
                        <button class="btn btn-secondary" onclick="quickClassify('novel')">ğŸ“– å­˜ç‚ºå°èªª</button>
                        <button class="btn btn-primary" onclick="autoClassify()">ğŸ¤– æ™ºèƒ½åˆ†é¡</button>
                    </div>
                </div>
            `;

            // ç›£è½å¿«é€Ÿè¼¸å…¥æ¡†
            document.getElementById('quickContent').addEventListener('input', (e) => {
                if (e.target.value.length > 10) {
                    suggestClassification(e.target.value);
                }
            });
        }

        // è§’è‰²é é¢
        function showCharacters() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">ğŸ‘¤ è§’è‰²è¨­å®š</h1>
                    <button class="btn btn-primary" onclick="editCharacter()">
                        <span>â•</span> æ–°å¢è§’è‰²
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" class="form-input search-input" placeholder="æœå°‹è§’è‰²..." onkeyup="searchCharacters(this.value)">
                    <select class="form-select" style="width: 200px;" onchange="filterByTag(this.value, 'characters')">
                        <option value="">æ‰€æœ‰æ¨™ç±¤</option>
                        ${data.settings.options.characterTags.map(tag => 
                            `<option value="${tag}">${tag}</option>`
                        ).join('')}
                    </select>
                </div>

                <div id="charactersList">
                    ${renderCharacters(data.characters)}
                </div>
            `;
        }

        // æ¸²æŸ“è§’è‰²åˆ—è¡¨
// ä¿®æ”¹è§’è‰²åˆ—è¡¨æ¸²æŸ“ï¼Œæ·»åŠ æŸ¥çœ‹åŠŸèƒ½
function renderCharacters(characters) {
    if (characters.length === 0) {
        return '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰è§’è‰²ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹è§’è‰²ï¼</p>';
    }

    return characters.map(char => `
        <div class="card" style="cursor: pointer;" onclick="viewCharacter('${char.id}')">
            <div class="card-header">
                <div>
                    <div class="card-title">${char.name}</div>
                    <div class="card-meta">
                        ${char.tags.map(tag => {
                            let tagClass = '';
                            if (tag === 'ä¸»è§’') tagClass = 'tag-hero';
                            else if (tag === 'åæ´¾') tagClass = 'tag-villain';
                            else if (tag === 'é…è§’') tagClass = 'tag-support';
                            return `<span class="tag ${tagClass}">${tag}</span>`;
                        }).join('')}
                        <span style="color: var(--text-secondary);">å¹´é½¡: ${char.age || 'æœªçŸ¥'}</span>
                        <span style="color: var(--text-secondary);">ç¨®æ—: ${char.race || 'äººé¡'}</span>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;" onclick="event.stopPropagation();">
                    <button class="btn btn-secondary" onclick="editCharacter('${char.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-danger" onclick="deleteItem('characters', '${char.id}')">åˆªé™¤</button>
                </div>
            </div>
            <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                ${char.description ? char.description.substring(0, 100) + '...' : 'æ²’æœ‰æè¿°'}
            </div>
        </div>
    `).join('');
}


        // ç·¨è¼¯è§’è‰²
        function editCharacter(id = null) {
            const character = id ? data.characters.find(c => c.id === id) : {
                id: generateId(),
                name: '',
                age: '',
                appearance: { hair: '', eyes: '' },
                race: '',
                personality: '',
                background: '',
                notes: '',
                tags: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${id ? 'ç·¨è¼¯' : 'æ–°å¢'}è§’è‰²</h1>
                        <button class="btn btn-secondary" onclick="showCharacters()">è¿”å›</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è§’è‰²åç¨± *</label>
                        <input type="text" class="form-input" id="charName" value="${character.name}" placeholder="è¼¸å…¥è§’è‰²åç¨±">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">å¹´é½¡</label>
                            <input type="text" class="form-input" id="charAge" value="${character.age}" placeholder="ä¾‹å¦‚: 25">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¨®æ—</label>
                            <input type="text" class="form-input" id="charRace" value="${character.race}" placeholder="ä¾‹å¦‚: äººé¡ã€ç²¾éˆ">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">é«®è‰²</label>
                            <select class="form-select" id="charHair">
                                <option value="">è«‹é¸æ“‡</option>
                                ${data.settings.options.hairColors.map(color => 
                                    `<option value="${color}" ${character.appearance.hair === color ? 'selected' : ''}>${color}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">çœ¼è‰²</label>
                            <select class="form-select" id="charEyes">
                                <option value="">è«‹é¸æ“‡</option>
                                ${data.settings.options.eyeColors.map(color => 
                                    `<option value="${color}" ${character.appearance.eyes === color ? 'selected' : ''}>${color}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å¤–è²Œæè¿°</label>
                        <textarea class="form-textarea" id="charDescription" placeholder="è©³ç´°æè¿°è§’è‰²çš„å¤–è²Œç‰¹å¾µ...">${character.description || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ€§æ ¼ç‰¹è³ª</label>
                        <textarea class="form-textarea" id="charPersonality" placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€ç¿’æ…£ã€å–œå¥½ç­‰...">${character.personality}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">èƒŒæ™¯æ•…äº‹</label>
                        <textarea class="form-textarea" id="charBackground" placeholder="è§’è‰²çš„éå»ã€ç¶“æ­·ã€å‹•æ©Ÿç­‰..." style="min-height: 150px;">${character.background}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é¡å¤–å‚™è¨»</label>
                        <textarea class="form-textarea" id="charNotes" placeholder="å…¶ä»–é‡è¦è³‡è¨Š...">${character.notes}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨™ç±¤</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            ${data.settings.options.characterTags.map(tag => 
                                `<label><input type="checkbox" id="tag-${tag}" ${character.tags.includes(tag) ? 'checked' : ''}> ${tag}</label>`
                            ).join('')}
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="showCharacters()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveCharacter('${character.id}', ${!!id})">
                            <span>ğŸ’¾</span> å„²å­˜
                        </button>
                    </div>
                </div>
            `;
        }

        // å„²å­˜è§’è‰²
        function saveCharacter(id, isEdit) {
            const character = {
                id: id,
                name: document.getElementById('charName').value,
                age: document.getElementById('charAge').value,
                appearance: {
                    hair: document.getElementById('charHair').value,
                    eyes: document.getElementById('charEyes').value
                },
                race: document.getElementById('charRace').value,
                description: document.getElementById('charDescription').value,
                personality: document.getElementById('charPersonality').value,
                background: document.getElementById('charBackground').value,
                notes: document.getElementById('charNotes').value,
                tags: [],
                updatedAt: Date.now()
            };

            if (!character.name) {
                alert('è«‹è¼¸å…¥è§’è‰²åç¨±ï¼');
                return;
            }

            // æ”¶é›†æ¨™ç±¤
            data.settings.options.characterTags.forEach(tag => {
                if (document.getElementById(`tag-${tag}`).checked) {
                    character.tags.push(tag);
                }
            });

            if (isEdit) {
                const index = data.characters.findIndex(c => c.id === id);
                character.createdAt = data.characters[index].createdAt;
                data.characters[index] = character;
            } else {
                character.createdAt = Date.now();
                data.characters.push(character);
            }

            saveData();
            showCharacters();
        }

        // èƒŒæ™¯é é¢
        function showBackgrounds() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">ğŸŒ æ•…äº‹èƒŒæ™¯</h1>
                    <button class="btn btn-primary" onclick="editBackground()">
                        <span>â•</span> æ–°å¢èƒŒæ™¯
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" class="form-input search-input" placeholder="æœå°‹èƒŒæ™¯..." onkeyup="searchBackgrounds(this.value)">
                    <select class="form-select" style="width: 200px;" onchange="filterByType(this.value, 'backgrounds')">
                        <option value="">æ‰€æœ‰é¡å‹</option>
                        ${data.settings.options.backgroundTypes.map(type => 
                            `<option value="${type}">${type}</option>`
                        ).join('')}
                    </select>
                </div>

                <div id="backgroundsList">
                    ${renderBackgrounds(data.backgrounds)}
                </div>
            `;
        }

        // æŸ¥çœ‹è§’è‰²è©³æƒ…
function viewCharacter(id) {
    const character = data.characters.find(c => c.id === id);
    if (!character) return;

    document.getElementById('pageContent').innerHTML = `
        <div class="edit-page">
            <div class="edit-header">
                <h1 class="page-title">ğŸ‘¤ ${character.name}</h1>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="editCharacter('${character.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-secondary" onclick="showCharacters()">è¿”å›</button>
                </div>
            </div>

            <div class="card">
                <h3>åŸºæœ¬è³‡è¨Š</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div><strong>å¹´é½¡ï¼š</strong>${character.age || 'æœªçŸ¥'}</div>
                    <div><strong>ç¨®æ—ï¼š</strong>${character.race || 'äººé¡'}</div>
                    <div><strong>é«®è‰²ï¼š</strong>${character.appearance.hair || 'æœªè¨­å®š'}</div>
                    <div><strong>çœ¼è‰²ï¼š</strong>${character.appearance.eyes || 'æœªè¨­å®š'}</div>
                </div>
            </div>

            ${character.description ? `
                <div class="card">
                    <h3>å¤–è²Œæè¿°</h3>
                    <p style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;">${character.description}</p>
                </div>
            ` : ''}

            ${character.personality ? `
                <div class="card">
                    <h3>æ€§æ ¼ç‰¹è³ª</h3>
                    <p style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;">${character.personality}</p>
                </div>
            ` : ''}

            ${character.background ? `
                <div class="card">
                    <h3>èƒŒæ™¯æ•…äº‹</h3>
                    <p style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;">${character.background}</p>
                </div>
            ` : ''}

            ${character.notes ? `
                <div class="card">
                    <h3>å‚™è¨»</h3>
                    <p style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;">${character.notes}</p>
                </div>
            ` : ''}

            ${character.tags && character.tags.length > 0 ? `
                <div class="card">
                    <h3>æ¨™ç±¤</h3>
                    <div class="card-meta" style="margin-top: 1rem;">
                        ${character.tags.map(tag => {
                            let tagClass = '';
                            if (tag === 'ä¸»è§’') tagClass = 'tag-hero';
                            else if (tag === 'åæ´¾') tagClass = 'tag-villain';
                            else if (tag === 'é…è§’') tagClass = 'tag-support';
                            return `<span class="tag ${tagClass}">${tag}</span>`;
                        }).join('')}
                    </div>
                </div>
            ` : ''}

            <div class="card">
                <h3>å»ºç«‹è³‡è¨Š</h3>
                <div style="margin-top: 1rem;">
                    <div><strong>å»ºç«‹æ™‚é–“ï¼š</strong>${new Date(character.createdAt).toLocaleString()}</div>
                    <div style="margin-top: 0.5rem;"><strong>æœ€å¾Œæ›´æ–°ï¼š</strong>${new Date(character.updatedAt).toLocaleString()}</div>
                </div>
            </div>
        </div>
    `;
}

// æŸ¥çœ‹ç¸½è¦½è©³æƒ…
function viewOutline(id) {
    const outline = data.outlines.find(o => o.id === id);
    if (!outline) return;

    document.getElementById('pageContent').innerHTML = `
        <div class="edit-page">
            <div class="edit-header">
                <h1 class="page-title">ğŸ“‹ ${outline.title}</h1>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="editOutline('${outline.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-secondary" onclick="showOutlines()">è¿”å›</button>
                </div>
            </div>

            ${outline.summary ? `
                <div class="card">
                    <h3>æ‘˜è¦</h3>
                    <p style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;">${outline.summary}</p>
                </div>
            ` : ''}

            ${outline.content ? `
                <div class="card">
                    <h3>è©³ç´°å…§å®¹</h3>
                    <div style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;">${outline.content}</div>
                </div>
            ` : ''}

            ${outline.tags && outline.tags.length > 0 ? `
                <div class="card">
                    <h3>æ¨™ç±¤</h3>
                    <div class="card-meta" style="margin-top: 1rem;">
                        ${outline.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>
            ` : ''}

            <div class="card">
                <h3>å»ºç«‹è³‡è¨Š</h3>
                <div style="margin-top: 1rem;">
                    <div><strong>å»ºç«‹æ™‚é–“ï¼š</strong>${new Date(outline.createdAt).toLocaleString()}</div>
                    <div style="margin-top: 0.5rem;"><strong>æœ€å¾Œæ›´æ–°ï¼š</strong>${new Date(outline.updatedAt).toLocaleString()}</div>
                </div>
            </div>
        </div>
    `;
}

// æŸ¥çœ‹ä¸–ç•Œè§€è©³æƒ…
function viewWorldbuilding(id) {
    const world = data.worldbuilding.find(w => w.id === id);
    if (!world) return;

    document.getElementById('pageContent').innerHTML = `
        <div class="edit-page">
            <div class="edit-header">
                <h1 class="page-title">ğŸŒ ${world.title}</h1>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="editWorldbuilding('${world.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-secondary" onclick="showWorldbuilding()">è¿”å›</button>
                </div>
            </div>

            <div class="card">
                <h3>é¡å‹</h3>
                <p style="margin-top: 1rem;"><span class="tag">${world.type}</span></p>
            </div>

            ${world.description ? `
                <div class="card">
                    <h3>æè¿°</h3>
                    <p style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;">${world.description}</p>
                </div>
            ` : ''}

            ${world.details ? `
                <div class="card">
                    <h3>è©³ç´°è³‡è¨Š</h3>
                    <div style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.6;">${world.details}</div>
                </div>
            ` : ''}

            <div class="card">
                <h3>å»ºç«‹è³‡è¨Š</h3>
                <div style="margin-top: 1rem;">
                    <div><strong>å»ºç«‹æ™‚é–“ï¼š</strong>${new Date(world.createdAt).toLocaleString()}</div>
                    <div style="margin-top: 0.5rem;"><strong>æœ€å¾Œæ›´æ–°ï¼š</strong>${new Date(world.updatedAt).toLocaleString()}</div>
                </div>
            </div>
        </div>
    `;
}


        

        // æ¸²æŸ“èƒŒæ™¯åˆ—è¡¨
        function renderBackgrounds(backgrounds) {
            if (backgrounds.length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰èƒŒæ™¯è¨­å®šï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ï¼</p>';
            }

            return backgrounds.map(bg => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${bg.name}</div>
                            <div class="card-meta">
                                <span class="tag">${bg.type}</span>
                                ${bg.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editBackground('${bg.id}')">ç·¨è¼¯</button>
                            <button class="btn btn-danger" onclick="deleteItem('backgrounds', '${bg.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                        ${bg.description ? bg.description.substring(0, 150) + '...' : 'æ²’æœ‰æè¿°'}
                    </div>
                </div>
            `).join('');
        }

        // ç·¨è¼¯èƒŒæ™¯
        function editBackground(id = null) {
            const background = id ? data.backgrounds.find(b => b.id === id) : {
                id: generateId(),
                name: '',
                type: data.settings.options.backgroundTypes[0] || 'åœ°é»',
                description: '',
                rules: '',
                notes: '',
                tags: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${id ? 'ç·¨è¼¯' : 'æ–°å¢'}èƒŒæ™¯</h1>
                        <button class="btn btn-secondary" onclick="showBackgrounds()">è¿”å›</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å ´æ™¯åç¨± *</label>
                        <input type="text" class="form-input" id="bgName" value="${background.name}" placeholder="è¼¸å…¥å ´æ™¯åç¨±">
                    </div>

                    <div class="form-group">
                        <label class="form-label">é¡å‹</label>
                        <select class="form-select" id="bgType">
                            ${data.settings.options.backgroundTypes.map(type => 
                                `<option value="${type}" ${background.type === type ? 'selected' : ''}>${type}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è©³ç´°æè¿°</label>
                        <textarea class="form-textarea" id="bgDescription" placeholder="æè¿°é€™å€‹å ´æ™¯çš„ç´°ç¯€..." style="min-height: 200px;">${background.description}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è¦å‰‡/æ³•å‰‡</label>
                        <textarea class="form-textarea" id="bgRules" placeholder="é€™å€‹ä¸–ç•Œçš„ç‰¹æ®Šè¦å‰‡æˆ–æ³•å‰‡...">${background.rules}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‚™è¨»</label>
                        <textarea class="form-textarea" id="bgNotes" placeholder="å…¶ä»–æ³¨æ„äº‹é …...">${background.notes}</textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="showBackgrounds()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveBackground('${background.id}', ${!!id})">
                            <span>ğŸ’¾</span> å„²å­˜
                        </button>
                    </div>
                </div>
            `;
        }

        // å„²å­˜èƒŒæ™¯
        function saveBackground(id, isEdit) {
            const background = {
                id: id,
                name: document.getElementById('bgName').value,
                type: document.getElementById('bgType').value,
                description: document.getElementById('bgDescription').value,
                rules: document.getElementById('bgRules').value,
                notes: document.getElementById('bgNotes').value,
                tags: [],
                updatedAt: Date.now()
            };

            if (!background.name) {
                alert('è«‹è¼¸å…¥å ´æ™¯åç¨±ï¼');
                return;
            }

            if (isEdit) {
                const index = data.backgrounds.findIndex(b => b.id === id);
                background.createdAt = data.backgrounds[index].createdAt;
                data.backgrounds[index] = background;
            } else {
                background.createdAt = Date.now();
                data.backgrounds.push(background);
            }

            saveData();
            showBackgrounds();
        }

        // ç§˜å¯†è¨­å®šé é¢
        function showSecrets() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">ğŸ” ç§˜å¯†è¨­å®š</h1>
                    <button class="btn btn-primary" onclick="editSecret()">
                        <span>â•</span> æ–°å¢ç§˜å¯†
                    </button>
                </div>

                <div class="secret-warning">
                    âš ï¸ æ³¨æ„ï¼šæ­¤å€åŸŸåŒ…å«åŠ‡é€å…§å®¹ï¼Œè«‹è¬¹æ…æŸ¥çœ‹ï¼
                </div>

                <div class="search-bar">
                    <input type="text" class="form-input search-input" placeholder="æœå°‹ç§˜å¯†..." onkeyup="searchSecrets(this.value)">
                    <select class="form-select" style="width: 200px;" onchange="filterByCategory(this.value, 'secrets')">
                        <option value="">æ‰€æœ‰é¡åˆ¥</option>
                        ${data.settings.options.secretCategories.map(category => 
                            `<option value="${category}">${category}</option>`
                        ).join('')}
                    </select>
                </div>

                <div id="secretsList">
                    ${renderSecrets(data.secrets)}
                </div>
            `;
        }

        // æ¸²æŸ“ç§˜å¯†åˆ—è¡¨
        function renderSecrets(secrets) {
            if (secrets.length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ç§˜å¯†è¨­å®šï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ï¼</p>';
            }

            return secrets.map(secret => `
                <div class="card" style="border-color: rgba(239, 68, 68, 0.3);">
                    <div class="card-header">
                        <div>
                            <div class="card-title">ğŸ”’ ${secret.title}</div>
                            <div class="card-meta">
                                <span class="tag tag-villain">${secret.category}</span>
                                ${secret.knownBy && secret.knownBy.length > 0 ? 
                                    `<span class="tag">çŸ¥æƒ…è€…: ${secret.knownBy.length}äºº</span>` : 
                                    '<span class="tag">ç„¡äººçŸ¥æ›‰</span>'
                                }
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editSecret('${secret.id}')">ç·¨è¼¯</button>
                            <button class="btn btn-danger" onclick="deleteItem('secrets', '${secret.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: var(--warning);">âš ï¸ é»æ“ŠæŸ¥çœ‹ç§˜å¯†å…§å®¹</summary>
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                            <p>${secret.content}</p>
                            ${secret.impact ? `<p style="margin-top: 0.5rem;"><strong>å½±éŸ¿ï¼š</strong>${secret.impact}</p>` : ''}
                            ${secret.knownBy && secret.knownBy.length > 0 ? 
                                `<p style="margin-top: 0.5rem;"><strong>çŸ¥æƒ…è€…ï¼š</strong>${secret.knownBy.join('ã€')}</p>` : ''
                            }
                        </div>
                    </details>
                </div>
            `).join('');
        }

        // ç·¨è¼¯ç§˜å¯†
        function editSecret(id = null) {
            const secret = id ? data.secrets.find(s => s.id === id) : {
                id: generateId(),
                title: '',
                category: data.settings.options.secretCategories[0] || 'åŠ‡æƒ…è½‰æŠ˜',
                content: '',
                impact: '',
                knownBy: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${id ? 'ç·¨è¼¯' : 'æ–°å¢'}ç§˜å¯†</h1>
                        <button class="btn btn-secondary" onclick="showSecrets()">è¿”å›</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨™é¡Œ *</label>
                        <input type="text" class="form-input" id="secretTitle" value="${secret.title}" placeholder="ç°¡çŸ­æè¿°é€™å€‹ç§˜å¯†">
                    </div>

                    <div class="form-group">
                        <label class="form-label">é¡åˆ¥</label>
                        <select class="form-select" id="secretCategory">
                            ${data.settings.options.secretCategories.map(category => 
                                `<option value="${category}" ${secret.category === category ? 'selected' : ''}>${category}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å…§å®¹</label>
                        <textarea class="form-textarea" id="secretContent" placeholder="è©³ç´°æè¿°é€™å€‹ç§˜å¯†..." style="min-height: 200px;">${secret.content}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å½±éŸ¿/é‡è¦æ€§</label>
                        <textarea class="form-textarea" id="secretImpact" placeholder="é€™å€‹ç§˜å¯†æœƒå¦‚ä½•å½±éŸ¿æ•…äº‹...">${secret.impact}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çŸ¥æƒ…äººå“¡</label>
                        <div class="multi-select">
                            <div class="multi-select-input" onclick="toggleMultiSelect()">
                                <span id="selectedKnownBy">${secret.knownBy.length > 0 ? secret.knownBy.join('ã€') : 'é¸æ“‡çŸ¥æƒ…è€…'}</span>
                                <span>â–¼</span>
                            </div>
                            <div class="multi-select-dropdown" id="knownByDropdown">
                                ${data.characters.map(char => `
                                    <div class="multi-select-option">
                                        <input type="checkbox" id="known-${char.id}" value="${char.name}" 
                                            ${secret.knownBy.includes(char.name) ? 'checked' : ''} 
                                            onchange="updateKnownBy()">
                                        <label for="known-${char.id}">${char.name}</label>
                                    </div>
                                `).join('')}
                                <div style="padding: 0.5rem 1rem;">
                                    <input type="text" class="form-input" id="customKnownBy" 
                                        placeholder="è¼¸å…¥å…¶ä»–çŸ¥æƒ…è€…ï¼ˆæŒ‰Enteræ·»åŠ ï¼‰" 
                                        onkeypress="if(event.key==='Enter') addCustomKnownBy()">
                                </div>
                            </div>
                        </div>
                        <div id="customKnownByList" style="margin-top: 0.5rem;">
                            ${secret.knownBy.filter(name => !data.characters.some(c => c.name === name))
                                .map(name => `<span class="tag">${name} <span onclick="removeCustomKnownBy('${name}')" style="cursor: pointer;">Ã—</span></span>`).join('')}
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="showSecrets()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveSecret('${secret.id}', ${!!id})">
                            <span>ğŸ’¾</span> å„²å­˜
                        </button>
                    </div>
                </div>
            `;
        }

        // åˆ‡æ›å¤šé¸ä¸‹æ‹‰æ¡†
        function toggleMultiSelect() {
            const dropdown = document.getElementById('knownByDropdown');
            dropdown.classList.toggle('show');
        }

        // æ›´æ–°çŸ¥æƒ…è€…
        function updateKnownBy() {
            const checkboxes = document.querySelectorAll('#knownByDropdown input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            const custom = Array.from(document.querySelectorAll('#customKnownByList .tag')).map(tag => tag.textContent.replace(' Ã—', ''));
            const all = [...selected, ...custom];
            document.getElementById('selectedKnownBy').textContent = all.length > 0 ? all.join('ã€') : 'é¸æ“‡çŸ¥æƒ…è€…';
        }

        // æ·»åŠ è‡ªå®šç¾©çŸ¥æƒ…è€…
        function addCustomKnownBy() {
            const input = document.getElementById('customKnownBy');
            const value = input.value.trim();
            if (value) {
                const customList = document.getElementById('customKnownByList');
                customList.innerHTML += `<span class="tag">${value} <span onclick="removeCustomKnownBy('${value}')" style="cursor: pointer;">Ã—</span></span>`;
                input.value = '';
                updateKnownBy();
            }
        }

        // ç§»é™¤è‡ªå®šç¾©çŸ¥æƒ…è€…
        function removeCustomKnownBy(name) {
            const customList = document.getElementById('customKnownByList');
            const tags = Array.from(customList.querySelectorAll('.tag'));
            tags.forEach(tag => {
                if (tag.textContent.replace(' Ã—', '') === name) {
                    tag.remove();
                }
            });
            updateKnownBy();
        }

        // å„²å­˜ç§˜å¯†
        function saveSecret(id, isEdit) {
            const checkboxes = document.querySelectorAll('#knownByDropdown input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            const custom = Array.from(document.querySelectorAll('#customKnownByList .tag')).map(tag => tag.textContent.replace(' Ã—', ''));
            
            const secret = {
                id: id,
                title: document.getElementById('secretTitle').value,
                category: document.getElementById('secretCategory').value,
                content: document.getElementById('secretContent').value,
                impact: document.getElementById('secretImpact').value,
                knownBy: [...selected, ...custom],
                updatedAt: Date.now()
            };

            if (!secret.title) {
                alert('è«‹è¼¸å…¥æ¨™é¡Œï¼');
                return;
            }

            if (isEdit) {
                const index = data.secrets.findIndex(s => s.id === id);
                secret.createdAt = data.secrets[index].createdAt;
                data.secrets[index] = secret;
            } else {
                secret.createdAt = Date.now();
                data.secrets.push(secret);
            }

            saveData();
            showSecrets();
        }

        // AIå°èªªé é¢
        function showNovels() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">ğŸ“– AIå°èªª</h1>
                    <button class="btn btn-primary" onclick="editNovel()">
                        <span>â•</span> æ–°å¢å°èªª
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" class="form-input search-input" placeholder="æœå°‹å°èªª..." onkeyup="searchNovels(this.value)">
                </div>

                <div id="novelsList">
                    ${renderNovels(data.novels)}
                </div>
            `;
        }

        // æ¸²æŸ“å°èªªåˆ—è¡¨
        function renderNovels(novels) {
            if (novels.length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰AIå°èªªï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ï¼</p>';
            }

            return novels.map(novel => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${novel.title}</div>
                            <div class="card-meta">
                                <span class="tag">å­—æ•¸: ${novel.content.length}</span>
                                <span style="color: var(--text-secondary); font-size: 0.875rem;">
                                    ${new Date(novel.createdAt).toLocaleDateString()}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="viewNovel('${novel.id}')">æŸ¥çœ‹</button>
                            <button class="btn btn-secondary" onclick="editNovel('${novel.id}')">ç·¨è¼¯</button>
                            <button class="btn btn-danger" onclick="deleteItem('novels', '${novel.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                        ${novel.content.substring(0, 150)}...
                    </div>
                </div>
            `).join('');
        }

        // æŸ¥çœ‹å°èªª
        function viewNovel(id) {
            const novel = data.novels.find(n => n.id === id);
            if (!novel) return;

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${novel.title}</h1>
                        <button class="btn btn-secondary" onclick="showNovels()">è¿”å›</button>
                    </div>

                    <div class="card" style="background: rgba(99, 102, 241, 0.1);">
                        <h3>ä½¿ç”¨çš„æç¤ºè©</h3>
                        <p style="margin-top: 0.5rem; white-space: pre-wrap;">${novel.prompt || 'ç„¡'}</p>
                    </div>

                    <div class="card">
                        <h3>å°èªªå…§å®¹</h3>
                        <div style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.8;">${novel.content}</div>
                    </div>

                    ${novel.notes ? `
                        <div class="card">
                            <h3>å‚™è¨»/è©•åƒ¹</h3>
                            <p style="margin-top: 0.5rem;">${novel.notes}</p>
                        </div>
                    ` : ''}

                    ${novel.relatedMaterials && novel.relatedMaterials.length > 0 ? `
                        <div class="card">
                            <h3>ç›¸é—œç´ æ</h3>
                            <div class="card-meta" style="margin-top: 0.5rem;">
                                ${novel.relatedMaterials.map(material => `<span class="tag">${material}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ç·¨è¼¯å°èªª
        function editNovel(id = null) {
            const novel = id ? data.novels.find(n => n.id === id) : {
                id: generateId(),
                title: '',
                prompt: '',
                content: '',
                notes: '',
                relatedMaterials: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${id ? 'ç·¨è¼¯' : 'æ–°å¢'}å°èªª</h1>
                        <button class="btn btn-secondary" onclick="showNovels()">è¿”å›</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨™é¡Œ *</label>
                        <input type="text" class="form-input" id="novelTitle" value="${novel.title}" placeholder="è¼¸å…¥å°èªªæ¨™é¡Œ">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä½¿ç”¨çš„æç¤ºè©</label>
                        <textarea class="form-textarea" id="novelPrompt" placeholder="è¨˜éŒ„ä½¿ç”¨çš„AIæç¤ºè©..." style="min-height: 100px;">${novel.prompt}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å°èªªå…§å®¹</label>
                        <textarea class="form-textarea" id="novelContent" placeholder="è²¼ä¸Šæˆ–è¼¸å…¥å°èªªå…§å®¹..." style="min-height: 400px;">${novel.content}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‚™è¨»/è©•åƒ¹</label>
                        <textarea class="form-textarea" id="novelNotes" placeholder="å°é€™å€‹ä½œå“çš„æƒ³æ³•...">${novel.notes}</textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="showNovels()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="saveNovel('${novel.id}', ${!!id})">
                            <span>ğŸ’¾</span> å„²å­˜
                        </button>
                    </div>
                </div>
            `;
        }

        // å„²å­˜å°èªª
        function saveNovel(id, isEdit) {
            const novel = {
                id: id,
                title: document.getElementById('novelTitle').value,
                prompt: document.getElementById('novelPrompt').value,
                content: document.getElementById('novelContent').value,
                notes: document.getElementById('novelNotes').value,
                relatedMaterials: [],
                updatedAt: Date.now()
            };

            if (!novel.title) {
                alert('è«‹è¼¸å…¥æ¨™é¡Œï¼');
                return;
            }

            if (isEdit) {
                const index = data.novels.findIndex(n => n.id === id);
                novel.createdAt = data.novels[index].createdAt;
                data.novels[index] = novel;
            } else {
                novel.createdAt = Date.now();
                data.novels.push(novel);
            }

            saveData();
            showNovels();
        }

        // AIåŠ©æ‰‹é é¢
        function showAI() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">ğŸ¤– AIå‰µä½œåŠ©æ‰‹</h1>
                </div>

                <div class="ai-assistant">
                    <h2 style="margin-bottom: 1.5rem;">é¸æ“‡è¦ä½¿ç”¨çš„ç´ æ</h2>
                    
                    <h3 style="margin-bottom: 1rem;">ğŸ‘¤ è§’è‰²</h3>
                    <div class="material-selector">
                        ${data.characters.length > 0 ? data.characters.map(char => `
                            <div class="material-item">
                                <input type="checkbox" id="ai-char-${char.id}" value="${char.id}">
                                <label for="ai-char-${char.id}">${char.name}</label>
                            </div>
                        `).join('') : '<p style="color: var(--text-secondary);">å°šç„¡è§’è‰²è³‡æ–™</p>'}
                    </div>

                    <h3 style="margin: 1.5rem 0 1rem;">ğŸŒ èƒŒæ™¯</h3>
                    <div class="material-selector">
                        ${data.backgrounds.length > 0 ? data.backgrounds.map(bg => `
                            <div class="material-item">
                                <input type="checkbox" id="ai-bg-${bg.id}" value="${bg.id}">
                                <label for="ai-bg-${bg.id}">${bg.name}</label>
                            </div>
                        `).join('') : '<p style="color: var(--text-secondary);">å°šç„¡èƒŒæ™¯è³‡æ–™</p>'}
                    </div>

                    <h3 style="margin: 1.5rem 0 1rem;">ğŸ” ç§˜å¯†è¨­å®š</h3>
                    <div class="material-selector">
                        ${data.secrets.length > 0 ? data.secrets.map(secret => `
                            <div class="material-item">
                                <input type="checkbox" id="ai-secret-${secret.id}" value="${secret.id}">
                                <label for="ai-secret-${secret.id}">${secret.title}</label>
                            </div>
                        `).join('') : '<p style="color: var(--text-secondary);">å°šç„¡ç§˜å¯†è¨­å®š</p>'}
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1rem;">ğŸ“ æç¤ºè©ç”Ÿæˆ</h2>
                    
                    <div class="form-group">
                        <label class="form-label">å¿«é€Ÿæ¨¡æ¿</label>
                        <select class="form-select" id="templateSelect" onchange="applyTemplate(this.value)">
                            <option value="">é¸æ“‡æ¨¡æ¿...</option>
                            <option value="story">å‰µä½œå®Œæ•´æ•…äº‹</option>
                            <option value="dialogue">è§’è‰²å°è©±</option>
                            <option value="scene">å ´æ™¯æè¿°</option>
                            <option value="dnd">DNDè§’è‰²å¡</option>
                            <option value="plot">åŠ‡æƒ…åˆ†æ</option>
                            ${data.settings.options.aiTemplates.map((template, index) => 
                                `<option value="custom-${index}">${template.name}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è‡ªè¨‚æç¤ºè©</label>
                        <textarea class="form-textarea" id="aiPrompt" placeholder="è¼¸å…¥ä½ çš„å‰µä½œéœ€æ±‚..." style="min-height: 300px;"></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="generatePrompt()">
                            <span>ğŸ²</span> ç”Ÿæˆæç¤ºè©
                        </button>
                        <button class="btn btn-secondary" onclick="copyPrompt()">
                            <span>ğŸ“‹</span> è¤‡è£½
                        </button>
                        <button class="btn btn-primary" onclick="sendToPerplexity()">
                            <span>ğŸš€</span> ç™¼é€åˆ°Perplexity
                        </button>
                        <button class="btn btn-secondary" onclick="saveAsTemplate()">
                            <span>ğŸ’¾</span> å„²å­˜ç‚ºæ¨¡æ¿
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ’¡ ä½¿ç”¨æç¤º</h3>
                    <ul style="margin-top: 1rem; padding-left: 1.5rem; color: var(--text-secondary);">
                        <li>é¸æ“‡ç›¸é—œçš„è§’è‰²ã€èƒŒæ™¯å’Œç§˜å¯†è¨­å®š</li>
                        <li>ä½¿ç”¨å¿«é€Ÿæ¨¡æ¿æˆ–è‡ªè¨‚æç¤ºè©</li>
                        <li>é»æ“Šã€Œç”Ÿæˆæç¤ºè©ã€æœƒè‡ªå‹•æ•´åˆæ‰€é¸ç´ æ</li>
                        <li>å¯ä»¥ç›´æ¥ç™¼é€åˆ°Perplexityé€²è¡Œå‰µä½œ</li>
                        <li>å¸¸ç”¨çš„æç¤ºè©å¯ä»¥å„²å­˜ç‚ºæ¨¡æ¿</li>
                    </ul>
                </div>
            `;
        }

        // æ‡‰ç”¨æ¨¡æ¿
        function applyTemplate(template) {
            const promptArea = document.getElementById('aiPrompt');
            
            if (template.startsWith('custom-')) {
                const index = parseInt(template.split('-')[1]);
                const customTemplate = data.settings.options.aiTemplates[index];
                if (customTemplate) {
                    promptArea.value = customTemplate.content;
                }
                return;
            }
            
            switch(template) {
                case 'story':
                    promptArea.value = 'è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²å’ŒèƒŒæ™¯è¨­å®šï¼Œå‰µä½œä¸€å€‹å®Œæ•´çš„çŸ­ç¯‡æ•…äº‹ï¼ˆç´„2000å­—ï¼‰ï¼š\n\n[è§’è‰²è³‡è¨Š]\n\n[èƒŒæ™¯è¨­å®š]\n\næ•…äº‹è¦æ±‚ï¼š\n- è¦æœ‰æ˜ç¢ºçš„é–‹ç«¯ã€ç™¼å±•ã€é«˜æ½®å’Œçµå°¾\n- å±•ç¾è§’è‰²çš„æ€§æ ¼ç‰¹å¾µ\n- èå…¥ä¸–ç•Œè§€è¨­å®š\n- æƒ…ç¯€ç·Šæ¹Šï¼Œå¼•äººå…¥å‹';
                    break;
                case 'dialogue':
                    promptArea.value = 'è«‹ç‚ºä»¥ä¸‹è§’è‰²å‰µä½œä¸€æ®µå°è©±å ´æ™¯ï¼š\n\n[è§’è‰²è³‡è¨Š]\n\nå ´æ™¯ï¼š[æè¿°å°è©±ç™¼ç”Ÿçš„åœ°é»å’Œæƒ…å¢ƒ]\n\nè¦æ±‚ï¼š\n- å°è©±è¦ç¬¦åˆå„è§’è‰²çš„æ€§æ ¼\n- å±•ç¾è§’è‰²ä¹‹é–“çš„é—œä¿‚\n- æ¨é€²åŠ‡æƒ…ç™¼å±•\n- ç´„500-800å­—';
                    break;
                case 'scene':
                    promptArea.value = 'è«‹è©³ç´°æè¿°ä»¥ä¸‹å ´æ™¯ï¼š\n\n[èƒŒæ™¯è¨­å®š]\n\næè¿°è¦æ±‚ï¼š\n- åŒ…å«è¦–è¦ºã€è½è¦ºã€å—…è¦ºç­‰æ„Ÿå®˜ç´°ç¯€\n- ç‡Ÿé€ ç¨ç‰¹çš„æ°›åœ\n- å±•ç¾å ´æ™¯çš„ç‰¹è‰²\n- ç´„300-500å­—';
                    break;
                case 'dnd':
                    promptArea.value = 'è«‹ç‚ºä»¥ä¸‹è§’è‰²å‰µå»ºDNDè§’è‰²å¡ï¼š\n\n[è§’è‰²è³‡è¨Š]\n\nåŒ…å«å…§å®¹ï¼š\n- åŸºæœ¬å±¬æ€§ï¼ˆåŠ›é‡ã€æ•æ·ã€é«”è³ªã€æ™ºåŠ›ã€æ„ŸçŸ¥ã€é­…åŠ›ï¼‰\n- è·æ¥­å’Œç­‰ç´š\n- æŠ€èƒ½å°ˆé•·\n- è£å‚™æ¸…å–®\n- èƒŒæ™¯æ•…äº‹\n- æ€§æ ¼ç‰¹å¾µå’Œç¼ºé™·\n- ç†æƒ³ã€ç¾ˆçµ†å’Œå¼±é»';
                    break;
                case 'plot':
                    promptArea.value = 'è«‹åˆ†æä»¥ä¸‹æ•…äº‹è¨­å®šï¼Œä¸¦æä¾›åŠ‡æƒ…ç™¼å±•å»ºè­°ï¼š\n\n[è§’è‰²å’ŒèƒŒæ™¯è³‡è¨Š]\n\nåˆ†æå…§å®¹ï¼š\n- æ½›åœ¨çš„è¡çªé»\n- è§’è‰²ç™¼å±•å¼§ç·š\n- å¯èƒ½çš„åŠ‡æƒ…è½‰æŠ˜\n- ä¸»é¡Œæ¢è¨å»ºè­°\n- çµå±€èµ°å‘é¸é …';
                    break;
            }
        }

        // å„²å­˜ç‚ºæ¨¡æ¿
        function saveAsTemplate() {
            const promptContent = document.getElementById('aiPrompt').value;
            if (!promptContent) {
                alert('è«‹å…ˆè¼¸å…¥æç¤ºè©å…§å®¹ï¼');
                return;
            }
            
            const templateName = prompt('è«‹è¼¸å…¥æ¨¡æ¿åç¨±ï¼š');
            if (!templateName) return;
            
            data.settings.options.aiTemplates.push({
                name: templateName,
                content: promptContent
            });
            
            saveData();
            alert('æ¨¡æ¿å·²å„²å­˜ï¼');
            showAI(); // é‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæ–°æ¨¡æ¿
        }

        // ç”Ÿæˆæç¤ºè©
        function generatePrompt() {
            const selectedChars = [];
            const selectedBgs = [];
            const selectedSecrets = [];

            // æ”¶é›†é¸ä¸­çš„ç´ æ
            document.querySelectorAll('input[id^="ai-char-"]:checked').forEach(input => {
                const char = data.characters.find(c => c.id === input.value);
                if (char) selectedChars.push(char);
            });

            document.querySelectorAll('input[id^="ai-bg-"]:checked').forEach(input => {
                const bg = data.backgrounds.find(b => b.id === input.value);
                if (bg) selectedBgs.push(bg);
            });

            document.querySelectorAll('input[id^="ai-secret-"]:checked').forEach(input => {
                const secret = data.secrets.find(s => s.id === input.value);
                if (secret) selectedSecrets.push(secret);
            });

            // æ§‹å»ºæç¤ºè©
            let prompt = document.getElementById('aiPrompt').value || 'è«‹åŸºæ–¼ä»¥ä¸‹è¨­å®šå‰µä½œä¸€å€‹æ•…äº‹ï¼š\n\n';

            if (selectedChars.length > 0) {
                prompt += '\nã€è§’è‰²è¨­å®šã€‘\n';
                selectedChars.forEach(char => {
                    prompt += `\nè§’è‰²åï¼š${char.name}\n`;
                    if (char.age) prompt += `å¹´é½¡ï¼š${char.age}\n`;
                    if (char.race) prompt += `ç¨®æ—ï¼š${char.race}\n`;
                    if (char.appearance.hair || char.appearance.eyes) {
                        prompt += `å¤–è²Œï¼š${char.appearance.hair ? 'é«®è‰²-' + char.appearance.hair : ''} ${char.appearance.eyes ? 'çœ¼è‰²-' + char.appearance.eyes : ''}\n`;
                    }
                    if (char.description) prompt += `å¤–è²Œæè¿°ï¼š${char.description}\n`;
                    if (char.personality) prompt += `æ€§æ ¼ï¼š${char.personality}\n`;
                    if (char.background) prompt += `èƒŒæ™¯ï¼š${char.background}\n`;
                    if (char.notes) prompt += `å‚™è¨»ï¼š${char.notes}\n`;
                });
            }

            if (selectedBgs.length > 0) {
                prompt += '\nã€èƒŒæ™¯è¨­å®šã€‘\n';
                selectedBgs.forEach(bg => {
                    prompt += `\nå ´æ™¯ï¼š${bg.name}ï¼ˆ${bg.type}ï¼‰\n`;
                    if (bg.description) prompt += `æè¿°ï¼š${bg.description}\n`;
                    if (bg.rules) prompt += `è¦å‰‡/æ³•å‰‡ï¼š${bg.rules}\n`;
                    if (bg.notes) prompt += `å‚™è¨»ï¼š${bg.notes}\n`;
                });
            }

            if (selectedSecrets.length > 0) {
                prompt += '\nã€ç§˜å¯†è¨­å®šã€‘\n';
                selectedSecrets.forEach(secret => {
                    prompt += `\n${secret.title}ï¼ˆ${secret.category}ï¼‰\n`;
                    if (secret.content) prompt += `å…§å®¹ï¼š${secret.content}\n`;
                    if (secret.impact) prompt += `å½±éŸ¿ï¼š${secret.impact}\n`;
                    if (secret.knownBy && secret.knownBy.length > 0) {
                        prompt += `çŸ¥æƒ…è€…ï¼š${secret.knownBy.join('ã€')}\n`;
                    }
                });
            }

            document.getElementById('aiPrompt').value = prompt;
        }

        // è¤‡è£½æç¤ºè©
        function copyPrompt() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) {
                alert('è«‹å…ˆè¼¸å…¥æˆ–ç”Ÿæˆæç¤ºè©ï¼');
                return;
            }

            navigator.clipboard.writeText(prompt).then(() => {
                alert('æç¤ºè©å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡è¤‡è£½');
            });
        }

        // ç™¼é€åˆ°Perplexity
        function sendToPerplexity() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) {
                alert('è«‹å…ˆè¼¸å…¥æˆ–ç”Ÿæˆæç¤ºè©ï¼');
                return;
            }

            // ç·¨ç¢¼æç¤ºè©
            const encodedPrompt = encodeURIComponent(prompt);
            
            // é–‹å•ŸPerplexityï¼ˆæ³¨æ„ï¼šå¯¦éš›URLå¯èƒ½éœ€è¦èª¿æ•´ï¼‰
            window.open(`https://www.perplexity.ai/?q=${encodedPrompt}`, '_blank');
        }

        // è¨­å®šé é¢
        function showSettings() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">âš™ï¸ ç³»çµ±è¨­å®š</h1>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem;">ğŸ”’ å®‰å…¨è¨­å®š</h2>
                    <div class="form-group">
                        <label class="form-label">ä¿®æ”¹å¯†ç¢¼</label>
                        <input type="password" class="form-input" id="newPassword" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">æ›´æ–°å¯†ç¢¼</button>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem;">ğŸ¨ é¸é …ç®¡ç†</h2>
                    
                    <div class="form-group">
                        <label class="form-label">è§’è‰²æ¨™ç±¤</label>
                        <div id="characterTagsList" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${data.settings.options.characterTags.map(tag => 
                                `<span class="tag">${tag} <span onclick="removeOption('characterTags', '${tag}')" style="cursor: pointer;">Ã—</span></span>`
                            ).join('')}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="newCharacterTag" placeholder="æ–°å¢æ¨™ç±¤" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="addOption('characterTags', 'newCharacterTag')">æ–°å¢</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é«®è‰²é¸é …</label>
                        <div id="hairColorsList" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${data.settings.options.hairColors.map(color => 
                                `<span class="tag">${color} <span onclick="removeOption('hairColors', '${color}')" style="cursor: pointer;">Ã—</span></span>`
                            ).join('')}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="newHairColor" placeholder="æ–°å¢é«®è‰²" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="addOption('hairColors', 'newHairColor')">æ–°å¢</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çœ¼è‰²é¸é …</label>
                        <div id="eyeColorsList" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${data.settings.options.eyeColors.map(color => 
                                `<span class="tag">${color} <span onclick="removeOption('eyeColors', '${color}')" style="cursor: pointer;">Ã—</span></span>`
                            ).join('')}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="newEyeColor" placeholder="æ–°å¢çœ¼è‰²" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="addOption('eyeColors', 'newEyeColor')">æ–°å¢</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">èƒŒæ™¯é¡å‹</label>
                        <div id="backgroundTypesList" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${data.settings.options.backgroundTypes.map(type => 
                                `<span class="tag">${type} <span onclick="removeOption('backgroundTypes', '${type}')" style="cursor: pointer;">Ã—</span></span>`
                            ).join('')}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="newBackgroundType" placeholder="æ–°å¢é¡å‹" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="addOption('backgroundTypes', 'newBackgroundType')">æ–°å¢</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ç§˜å¯†é¡åˆ¥</label>
                        <div id="secretCategoriesList" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                            ${data.settings.options.secretCategories.map(category => 
                                `<span class="tag">${category} <span onclick="removeOption('secretCategories', '${category}')" style="cursor: pointer;">Ã—</span></span>`
                            ).join('')}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="newSecretCategory" placeholder="æ–°å¢é¡åˆ¥" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="addOption('secretCategories', 'newSecretCategory')">æ–°å¢</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">AIæç¤ºè©æ¨¡æ¿</label>
                        <div id="aiTemplatesList" style="margin-bottom: 0.5rem;">
                            ${data.settings.options.aiTemplates.map((template, index) => 
                                `<div class="card" style="margin-bottom: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong>${template.name}</strong>
                                        <button class="btn btn-danger" onclick="removeAITemplate(${index})" style="padding: 0.25rem 0.75rem;">åˆªé™¤</button>
                                    </div>
                                    <p style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">${template.content.substring(0, 100)}...</p>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem;">â˜ï¸ å‚™ä»½èˆ‡é‚„åŸ</h2>
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                        <button class="btn btn-secondary" onclick="exportData()">
                            <span>ğŸ“¥</span> åŒ¯å‡ºè³‡æ–™
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                            <span>ğŸ“¤</span> åŒ¯å…¥è³‡æ–™
                        </button>
                        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(this)">
                    </div>

                    <div class="alert alert-warning">
                        âš ï¸ Google Drive æ•´åˆåŠŸèƒ½å³å°‡æ¨å‡ºï¼
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem;">ğŸ“Š è³‡æ–™çµ±è¨ˆ</h2>
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>ç¸½è³‡æ–™å¤§å°</span>
                            <span>${(JSON.stringify(data).length / 1024).toFixed(2)} KB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>å»ºç«‹æ™‚é–“</span>
                            <span>${getAllItems().length > 0 ? new Date(Math.min(...getAllItems().map(item => item.createdAt))).toLocaleDateString() : 'å°šç„¡è³‡æ–™'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>æœ€å¾Œæ›´æ–°</span>
                            <span>${getAllItems().length > 0 ? new Date(Math.max(...getAllItems().map(item => item.updatedAt))).toLocaleDateString() : 'å°šç„¡è³‡æ–™'}</span>
                        </div>
                    </div>
                </div>

                <div class="card" style="border-color: rgba(239, 68, 68, 0.5);">
                    <h2 style="margin-bottom: 1.5rem; color: var(--danger);">âš ï¸ å±éšªå€åŸŸ</h2>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…æ“ä½œï¼</p>
                    <button class="btn btn-danger" onclick="if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) clearAllData()">
                        æ¸…é™¤æ‰€æœ‰è³‡æ–™
                    </button>
                </div>
            `;
        }

        // æ–°å¢é¸é …
        function addOption(optionType, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            
            if (!value) {
                alert('è«‹è¼¸å…¥å…§å®¹ï¼');
                return;
            }
            
            if (data.settings.options[optionType].includes(value)) {
                alert('æ­¤é¸é …å·²å­˜åœ¨ï¼');
                return;
            }
            
            data.settings.options[optionType].push(value);
            saveData();
            showSettings();
        }

        // ç§»é™¤é¸é …
        function removeOption(optionType, value) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${value}ã€å—ï¼Ÿ`)) return;
            
            const index = data.settings.options[optionType].indexOf(value);
            if (index > -1) {
                data.settings.options[optionType].splice(index, 1);
                saveData();
                showSettings();
            }
        }

        // ç§»é™¤AIæ¨¡æ¿
        function removeAITemplate(index) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¨¡æ¿å—ï¼Ÿ`)) return;
            
            data.settings.options.aiTemplates.splice(index, 1);
            saveData();
            showSettings();
        }

        // è¼”åŠ©å‡½æ•¸
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function calculateTotalWords() {
            let total = 0;
            data.characters.forEach(char => {
                total += (char.description || '').length;
                total += (char.personality || '').length;
                total += (char.background || '').length;
                total += (char.notes || '').length;
            });
            data.backgrounds.forEach(bg => {
                total += (bg.description || '').length;
                total += (bg.rules || '').length;
                total += (bg.notes || '').length;
            });
            data.secrets.forEach(secret => {
                total += (secret.content || '').length;
                total += (secret.impact || '').length;
            });
            data.novels.forEach(novel => {
                total += (novel.content || '').length;
            });
            return total;
        }

        function getAllItems() {
            return [
                ...data.characters,
                ...data.backgrounds,
                ...data.secrets,
                ...data.novels
            ];
        }

        function getRecentItems() {
            const allItems = [
                ...data.characters.map(item => ({...item, type: 'è§’è‰²', icon: 'ğŸ‘¤'})),
                ...data.backgrounds.map(item => ({...item, type: 'èƒŒæ™¯', icon: 'ğŸŒ', title: item.name})),
                ...data.secrets.map(item => ({...item, type: 'ç§˜å¯†', icon: 'ğŸ”'})),
                ...data.novels.map(item => ({...item, type: 'å°èªª', icon: 'ğŸ“–'}))
            ];
            
            return allItems
                .sort((a, b) => b.updatedAt - a.updatedAt)
                .slice(0, 5)
                .map(item => ({
                    ...item,
                    title: item.title || item.name
                }));
        }

        // åˆªé™¤é …ç›®
        function deleteItem(type, id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) return;
            
            const index = data[type].findIndex(item => item.id === id);
            if (index > -1) {
                data[type].splice(index, 1);
                saveData();
                
                // é‡æ–°è¼‰å…¥ç•¶å‰é é¢
                switch(type) {
                    case 'characters': showCharacters(); break;
                    case 'backgrounds': showBackgrounds(); break;
                    case 'secrets': showSecrets(); break;
                    case 'novels': showNovels(); break;
                }
            }
        }

        // æœå°‹åŠŸèƒ½
        function searchCharacters(query) {
            const filtered = data.characters.filter(char => 
                char.name.toLowerCase().includes(query.toLowerCase()) ||
                (char.description || '').toLowerCase().includes(query.toLowerCase())
            );
            document.getElementById('charactersList').innerHTML = renderCharacters(filtered);
        }

        function searchBackgrounds(query) {
            const filtered = data.backgrounds.filter(bg => 
                bg.name.toLowerCase().includes(query.toLowerCase()) ||
                (bg.description || '').toLowerCase().includes(query.toLowerCase())
            );
            document.getElementById('backgroundsList').innerHTML = renderBackgrounds(filtered);
        }

        function searchSecrets(query) {
            const filtered = data.secrets.filter(secret => 
                secret.title.toLowerCase().includes(query.toLowerCase()) ||
                (secret.content || '').toLowerCase().includes(query.toLowerCase())
            );
            document.getElementById('secretsList').innerHTML = renderSecrets(filtered);
        }

        function searchNovels(query) {
            const filtered = data.novels.filter(novel => 
                novel.title.toLowerCase().includes(query.toLowerCase()) ||
                (novel.content || '').toLowerCase().includes(query.toLowerCase())
            );
            document.getElementById('novelsList').innerHTML = renderNovels(filtered);
        }

        // ç¯©é¸åŠŸèƒ½
        function filterByTag(tag, type) {
            if (type === 'characters') {
                const filtered = tag ? data.characters.filter(char => char.tags.includes(tag)) : data.characters;
                document.getElementById('charactersList').innerHTML = renderCharacters(filtered);
            }
        }

        function filterByType(type, dataType) {
            if (dataType === 'backgrounds') {
                const filtered = type ? data.backgrounds.filter(bg => bg.type === type) : data.backgrounds;
                document.getElementById('backgroundsList').innerHTML = renderBackgrounds(filtered);
            }
        }

        function filterByCategory(category, type) {
            if (type === 'secrets') {
                const filtered = category ? data.secrets.filter(secret => secret.category === category) : data.secrets;
                document.getElementById('secretsList').innerHTML = renderSecrets(filtered);
            }
        }

        // è¨­å®šåŠŸèƒ½
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword) {
                alert('è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼');
                return;
            }
            
            data.settings.password = newPassword;
            saveData();
            alert('å¯†ç¢¼å·²æ›´æ–°ï¼');
            document.getElementById('newPassword').value = '';
        }

        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `novel-materials-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼')) {
                        data = importedData;
                        saveData();
                        location.reload();
                    }
                } catch (error) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            data = {
                characters: [],
                backgrounds: [],
                secrets: [],
                novels: [],
                settings: {
                    password: 'admin',
                    autoBackup: true,
                    googleDriveToken: null,
                    options: {
                        characterTags: ['ä¸»è§’', 'é…è§’', 'åæ´¾', 'è·¯äºº', 'NPC'],
                        hairColors: ['é»‘è‰²', 'æ£•è‰²', 'é‡‘è‰²', 'ç´…è‰²', 'ç™½è‰²', 'è—è‰²', 'ç¶ è‰²', 'ç´«è‰²', 'éŠ€è‰²', 'å…¶ä»–'],
                        eyeColors: ['é»‘è‰²', 'æ£•è‰²', 'è—è‰²', 'ç¶ è‰²', 'ç°è‰²', 'ç´…è‰²', 'ç´«è‰²', 'é‡‘è‰²', 'ç•°è‰²ç³', 'å…¶ä»–'],
                        backgroundTypes: ['åœ°é»', 'æ™‚ä»£', 'ä¸–ç•Œè§€', 'æ–‡åŒ–', 'çµ„ç¹”', 'åœ‹å®¶', 'å…¶ä»–'],
                        secretCategories: ['åŠ‡æƒ…è½‰æŠ˜', 'è§’è‰²ç§˜å¯†', 'ä¸–ç•Œè¨­å®š', 'ä¼ç­†', 'çµå±€', 'é—œä¿‚ç§˜å¯†', 'å…¶ä»–'],
                        aiTemplates: []
                    }
                }
            };
            saveData();
            location.reload();
        }
        function deleteOption(category, optionValue) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é¸é …å—ï¼Ÿ')) {
        const index = data.options[category].indexOf(optionValue);
        if (index > -1) {
            data.options[category].splice(index, 1);
            saveData();
            showSettings();
        }
    }
}
        // ä¿®æ”¹ renderOutlines å‡½æ•¸
function renderOutlines(outlines) {
    if (outlines.length === 0) {
        return '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰å¤§ç¶±ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹å¤§ç¶±ï¼</p>';
    }

    return outlines.map(outline => `
        <div class="card" style="cursor: pointer;" onclick="viewOutline('${outline.id}')">
            <div class="card-header">
                <div>
                    <div class="card-title">${outline.title}</div>
                    <div class="card-meta">
                        ${outline.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;" onclick="event.stopPropagation();">
                    <button class="btn btn-secondary" onclick="editOutline('${outline.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-danger" onclick="deleteItem('outlines', '${outline.id}')">åˆªé™¤</button>
                </div>
            </div>
            <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                ${outline.summary ? outline.summary.substring(0, 100) + '...' : 'æ²’æœ‰æ‘˜è¦'}
            </div>
        </div>
    `).join('');
}

// ä¿®æ”¹ renderWorldbuilding å‡½æ•¸
function renderWorldbuilding(worldbuilding) {
    if (worldbuilding.length === 0) {
        return '<p style="text-align: center; color: var(--text-secondary);">é‚„æ²’æœ‰ä¸–ç•Œè§€è¨­å®šï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹è¨­å®šï¼</p>';
    }

    return worldbuilding.map(world => `
        <div class="card" style="cursor: pointer;" onclick="viewWorldbuilding('${world.id}')">
            <div class="card-header">
                <div>
                    <div class="card-title">${world.title}</div>
                    <div class="card-meta">
                        <span class="tag">${world.type}</span>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;" onclick="event.stopPropagation();">
                    <button class="btn btn-secondary" onclick="editWorldbuilding('${world.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-danger" onclick="deleteItem('worldbuilding', '${world.id}')">åˆªé™¤</button>
                </div>
            </div>
            <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                ${world.description ? world.description.substring(0, 100) + '...' : 'æ²’æœ‰æè¿°'}
            </div>
        </div>
    `).join('');
}
// æ‰¾åˆ° showAIAssistant å‡½æ•¸ä¸¦æ›¿æ›
function showAIAssistant() {
    document.getElementById('pageContent').innerHTML = `
        <div class="page">
            <div class="page-header">
                <h1 class="page-title">ğŸ¤– AI å¯«ä½œåŠ©æ‰‹</h1>
            </div>

            <!-- å¿«é€Ÿæ¨¡æ¿å€åŸŸ -->
            <div class="card">
                <h3>ğŸ“ å¿«é€Ÿæ¨¡æ¿ç”Ÿæˆ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="generateTemplate('character')">è§’è‰²æè¿°æ¨¡æ¿</button>
                    <button class="btn btn-secondary" onclick="generateTemplate('scene')">å ´æ™¯æè¿°æ¨¡æ¿</button>
                    <button class="btn btn-secondary" onclick="generateTemplate('dialogue')">å°è©±å¯«ä½œæ¨¡æ¿</button>
                    <button class="btn btn-secondary" onclick="generateTemplate('plot')">æƒ…ç¯€ç™¼å±•æ¨¡æ¿</button>
                    <button class="btn btn-secondary" onclick="generateTemplate('emotion')">æƒ…æ„Ÿæå¯«æ¨¡æ¿</button>
                    <button class="btn btn-secondary" onclick="generateTemplate('worldbuilding')">ä¸–ç•Œè§€å»ºæ§‹æ¨¡æ¿</button>
                </div>
                
                <!-- æ¨¡æ¿é¡¯ç¤ºå€åŸŸ -->
                <div id="templateResult" style="margin-top: 1rem; display: none;">
                    <h4>ç”Ÿæˆçš„æ¨¡æ¿ï¼š</h4>
                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                        <textarea id="generatedTemplate" class="form-input" style="width: 100%; height: 200px; resize: vertical;" placeholder="ç”Ÿæˆçš„æ¨¡æ¿å°‡é¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="copyTemplate()">è¤‡è£½æ¨¡æ¿</button>
                        <button class="btn btn-secondary" onclick="clearTemplate()">æ¸…é™¤</button>
                    </div>
                </div>
            </div>

            <!-- è‡ªè¨‚æç¤ºè©å€åŸŸ -->
            <div class="card">
                <h3>âœï¸ è‡ªè¨‚æç¤ºè©ç”Ÿæˆ</h3>
                <div style="margin-top: 1rem;">
                    <label class="form-label">å¯«ä½œéœ€æ±‚æè¿°ï¼š</label>
                    <textarea id="customPromptInput" class="form-input" rows="4" placeholder="è«‹æè¿°ä½ çš„å¯«ä½œéœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³å¯«ä¸€å€‹é—œæ–¼ç§‘å¹»ä¸–ç•Œçš„è§’è‰²ä»‹ç´¹..."></textarea>
                </div>
                
                <div style="margin-top: 1rem;">
                    <label class="form-label">å¯«ä½œé¢¨æ ¼ï¼š</label>
                    <select id="writingStyleSelect" class="form-input">
                        <option value="">é¸æ“‡é¢¨æ ¼ï¼ˆå¯é¸ï¼‰</option>
                        <option value="formal">æ­£å¼æ–‡å­¸</option>
                        <option value="casual">è¼•é¬†éš¨æ„</option>
                        <option value="poetic">è©©æ„å„ªç¾</option>
                        <option value="dramatic">æˆ²åŠ‡å¼µåŠ›</option>
                        <option value="humorous">å¹½é»˜é¢¨è¶£</option>
                        <option value="dark">é»‘æš—é¢¨æ ¼</option>
                    </select>
                </div>

                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="generateCustomPrompt()">ç”Ÿæˆæç¤ºè©</button>
                </div>

                <!-- è‡ªè¨‚æç¤ºè©çµæœå€åŸŸ -->
                <div id="customPromptResult" style="margin-top: 1rem; display: none;">
                    <h4>ç”Ÿæˆçš„æç¤ºè©ï¼š</h4>
                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                        <textarea id="generatedCustomPrompt" class="form-input" style="width: 100%; height: 150px; resize: vertical;" placeholder="ç”Ÿæˆçš„æç¤ºè©å°‡é¡¯ç¤ºåœ¨é€™è£¡..."></textarea>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="copyCustomPrompt()">è¤‡è£½æç¤ºè©</button>
                        <button class="btn btn-secondary" onclick="clearCustomPrompt()">æ¸…é™¤</button>
                    </div>
                </div>
            </div>

            <!-- ä½¿ç”¨èªªæ˜ -->
            <div class="card">
                <h3>ğŸ’¡ ä½¿ç”¨èªªæ˜</h3>
                <ul style="margin-top: 1rem; line-height: 1.6;">
                    <li><strong>å¿«é€Ÿæ¨¡æ¿ï¼š</strong>é»æ“ŠæŒ‰éˆ•ç”Ÿæˆå¸¸ç”¨çš„å¯«ä½œæ¨¡æ¿</li>
                    <li><strong>è‡ªè¨‚æç¤ºè©ï¼š</strong>æè¿°ä½ çš„å…·é«”éœ€æ±‚ï¼Œç”Ÿæˆå€‹äººåŒ–çš„å¯«ä½œæç¤º</li>
                    <li><strong>è¤‡è£½åŠŸèƒ½ï¼š</strong>ç”Ÿæˆå¾Œå¯ä»¥ç›´æ¥è¤‡è£½åˆ°ä½ çš„å¯«ä½œå·¥å…·ä¸­ä½¿ç”¨</li>
                    <li><strong>é¢¨æ ¼é¸æ“‡ï¼š</strong>é¸æ“‡é©åˆçš„å¯«ä½œé¢¨æ ¼è®“æç¤ºè©æ›´ç²¾æº–</li>
                </ul>
            </div>
        </div>
    `;
}
// ç”Ÿæˆå¿«é€Ÿæ¨¡æ¿
function generateTemplate(type) {
    const templates = {
        character: "è§’è‰²å§“åï¼š[å§“å]\nå¹´é½¡ï¼š[å¹´é½¡]\nå¤–è²Œç‰¹å¾µï¼š[æè¿°å¤–è²Œç‰¹é»]\næ€§æ ¼ç‰¹è³ªï¼š[3-5å€‹é—œéµè©]\nèƒŒæ™¯æ•…äº‹ï¼š[ç°¡è¿°èƒŒæ™¯]\nç›®æ¨™å‹•æ©Ÿï¼š[è§’è‰²æƒ³è¦é”æˆä»€éº¼]\nè¡çªé»ï¼š[å…§åœ¨æˆ–å¤–åœ¨è¡çª]\nç¨ç‰¹ä¹‹è™•ï¼š[è®“è§’è‰²èˆ‡çœ¾ä¸åŒçš„åœ°æ–¹]",
        scene: "å ´æ™¯åç¨±ï¼š[å ´æ™¯åç¨±]\næ™‚é–“ï¼š[æ™‚é–“è¨­å®š]\nåœ°é»ï¼š[å…·é«”ä½ç½®]\næ°›åœï¼š[æ•´é«”æ„Ÿå—]\nè¦–è¦ºæè¿°ï¼š[è®€è€…èƒ½çœ‹åˆ°ä»€éº¼]\nè½è¦ºæè¿°ï¼š[ç’°å¢ƒè²éŸ³]\næ°£å‘³è§¸æ„Ÿï¼š[å…¶ä»–æ„Ÿå®˜æ„Ÿå—]\né‡è¦ç‰©å“ï¼š[å ´æ™¯ä¸­çš„é—œéµç‰©ä»¶]",
        dialogue: "å°è©±ç›®çš„ï¼š[é€™æ®µå°è©±è¦é”æˆä»€éº¼]\nè§’è‰²Aï¼š[è§’è‰²åç¨±]\n- èªªè©±é¢¨æ ¼ï¼š[æ­£å¼/éš¨æ„/å¹½é»˜ç­‰]\n- æƒ…ç·’ç‹€æ…‹ï¼š[ç•¶å‰å¿ƒæƒ…]\nè§’è‰²Bï¼š[è§’è‰²åç¨±]\n- èªªè©±é¢¨æ ¼ï¼š[æ­£å¼/éš¨æ„/å¹½é»˜ç­‰]\n- æƒ…ç·’ç‹€æ…‹ï¼š[ç•¶å‰å¿ƒæƒ…]\nå°è©±é‡é»ï¼š[è¦å‚³é”çš„é—œéµä¿¡æ¯]\næ½›å°è©ï¼š[æ²’æœ‰ç›´æ¥èªªå‡ºçš„å«æ„]",
        plot: "æƒ…ç¯€é»ï¼š[é€™å€‹æƒ…ç¯€è¦ç™¼ç”Ÿä»€éº¼]\nèµ·å› ï¼š[ç‚ºä»€éº¼æœƒç™¼ç”Ÿ]\néç¨‹ï¼š[å¦‚ä½•ç™¼å±•]\nçµæœï¼š[å°è‡´ä»€éº¼å¾Œæœ]\nå½±éŸ¿è§’è‰²ï¼š[å°ä¸»è§’çš„å½±éŸ¿]\næ¨é€²åŠ‡æƒ…ï¼š[å¦‚ä½•æ¨å‹•æ•…äº‹å‰é€²]\nè¡çªé¡å‹ï¼š[äººèˆ‡äºº/äººèˆ‡ç’°å¢ƒ/å…§å¿ƒè¡çª]\nè½‰æŠ˜é»ï¼š[æ„å¤–æˆ–è½‰è®Š]",
        emotion: "æƒ…ç·’é¡å‹ï¼š[å–œæ‚…/æ‚²å‚·/æ†¤æ€’/ææ‡¼ç­‰]\nè§¸ç™¼åŸå› ï¼š[ä»€éº¼å¼•èµ·é€™å€‹æƒ…ç·’]\nå…§åœ¨æ„Ÿå—ï¼š[è§’è‰²å…§å¿ƒçš„æƒ³æ³•]\nå¤–åœ¨è¡¨ç¾ï¼š[è¡Œç‚ºèˆ‰æ­¢è®ŠåŒ–]\nç”Ÿç†åæ‡‰ï¼š[èº«é«”çš„åæ‡‰]\nå°è©±è®ŠåŒ–ï¼š[èªªè©±æ–¹å¼çš„æ”¹è®Š]\nè¡Œå‹•å½±éŸ¿ï¼š[æƒ…ç·’å¦‚ä½•å½±éŸ¿æ±ºå®š]\næŒçºŒæ™‚é–“ï¼š[æƒ…ç·’æœƒæŒçºŒå¤šä¹…]",
        worldbuilding: "ä¸–ç•Œåç¨±ï¼š[ä¸–ç•Œ/åœ°å€åç¨±]\nä¸–ç•Œé¡å‹ï¼š[ç¾ä»£/å¤ä»£/ç§‘å¹»/å¥‡å¹»ç­‰]\nåœ°ç†ç’°å¢ƒï¼š[åœ°å½¢åœ°è²Œç‰¹è‰²]\nç¤¾æœƒåˆ¶åº¦ï¼š[æ”¿æ²»é«”åˆ¶]\næ–‡åŒ–ç‰¹è‰²ï¼š[é¢¨ä¿—ç¿’æ…£]\nç§‘æŠ€æ°´å¹³ï¼š[æŠ€è¡“ç™¼å±•ç¨‹åº¦]\né­”æ³•/è¶…èƒ½åŠ›ï¼š[ç‰¹æ®Šèƒ½åŠ›ç³»çµ±]\næ­·å²èƒŒæ™¯ï¼š[é‡è¦æ­·å²äº‹ä»¶]\nç¨ç‰¹è¦å‰‡ï¼š[é€™å€‹ä¸–ç•Œçš„ç‰¹æ®Šæ³•å‰‡]"
    };

    const template = templates[type];
    if (template) {
        document.getElementById('generatedTemplate').value = template;
        document.getElementById('templateResult').style.display = 'block';
        document.getElementById('generatedTemplate').focus();
    }
}

// ç”Ÿæˆè‡ªè¨‚æç¤ºè©
function generateCustomPrompt() {
    const userInput = document.getElementById('customPromptInput').value.trim();
    const style = document.getElementById('writingStyleSelect').value;
    
    if (!userInput) {
        alert('è«‹å…ˆæè¿°ä½ çš„å¯«ä½œéœ€æ±‚');
        return;
    }

    let prompt = `æ ¹æ“šä»¥ä¸‹éœ€æ±‚å‰µä½œï¼š\n\néœ€æ±‚æè¿°ï¼š${userInput}\n\n`;
    
    if (style) {
        const styleDescriptions = {
            formal: "è«‹ä½¿ç”¨æ­£å¼çš„æ–‡å­¸é¢¨æ ¼ï¼Œç”¨è©å„ªé›…ã€çµæ§‹åš´è¬¹ã€‚",
            casual: "è«‹ä½¿ç”¨è¼•é¬†éš¨æ„çš„é¢¨æ ¼ï¼Œå°±åƒæœ‹å‹é–“çš„å°è©±ã€‚",
            poetic: "è«‹ä½¿ç”¨è©©æ„å„ªç¾çš„èªè¨€ï¼Œé‡è¦–éŸ»å¾‹å’Œæ„å¢ƒã€‚",
            dramatic: "è«‹ç‡Ÿé€ å¼·çƒˆçš„æˆ²åŠ‡å¼µåŠ›å’Œæƒ…æ„Ÿè¡æ“Šã€‚",
            humorous: "è«‹åŠ å…¥å¹½é»˜é¢¨è¶£çš„å…ƒç´ ï¼Œè®“è®€è€…æœƒå¿ƒä¸€ç¬‘ã€‚",
            dark: "è«‹ä½¿ç”¨é»‘æš—é¢¨æ ¼ï¼Œç‡Ÿé€ ç¥ç§˜æˆ–å£“æŠ‘çš„æ°›åœã€‚"
        };
        prompt += `å¯«ä½œé¢¨æ ¼ï¼š${styleDescriptions[style]}\n\n`;
    }

    prompt += "è«‹æä¾›ï¼š\n1. å…·é«”çš„å¯«ä½œå»ºè­°\n2. å¯ä»¥åƒè€ƒçš„æå¯«è§’åº¦\n3. é©åˆçš„è©å½™å’Œå¥å¼\n4. éœ€è¦æ³¨æ„çš„å¯«ä½œè¦é»";

    document.getElementById('generatedCustomPrompt').value = prompt;
    document.getElementById('customPromptResult').style.display = 'block';
    document.getElementById('generatedCustomPrompt').focus();
}

// è¤‡è£½æ¨¡æ¿
function copyTemplate() {
    const template = document.getElementById('generatedTemplate');
    template.select();
    document.execCommand('copy');
    alert('æ¨¡æ¿å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
}

// è¤‡è£½è‡ªè¨‚æç¤ºè©
function copyCustomPrompt() {
    const prompt = document.getElementById('generatedCustomPrompt');
    prompt.select();
    document.execCommand('copy');
    alert('æç¤ºè©å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
}

// æ¸…é™¤æ¨¡æ¿
function clearTemplate() {
    document.getElementById('generatedTemplate').value = '';
    document.getElementById('templateResult').style.display = 'none';
}

// æ¸…é™¤è‡ªè¨‚æç¤ºè©
function clearCustomPrompt() {
    document.getElementById('generatedCustomPrompt').value = '';
    document.getElementById('customPromptInput').value = '';
    document.getElementById('writingStyleSelect').value = '';
    document.getElementById('customPromptResult').style.display = 'none';
}


        // å¿«é€Ÿåˆ†é¡åŠŸèƒ½
        function quickClassify(type) {
            const content = document.getElementById('quickContent').value;
            if (!content) {
                alert('è«‹å…ˆè¼¸å…¥å…§å®¹ï¼');
                return;
            }

            switch(type) {
                case 'character':
                    const charId = generateId();
                    data.characters.push({
                        id: charId,
                        name: 'æœªå‘½åè§’è‰²',
                        age: '',
                        appearance: { hair: '', eyes: '' },
                        race: '',
                        description: content,
                        personality: '',
                        background: '',
                        notes: '',
                        tags: [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                    saveData();
                    editCharacter(charId);
                    break;
                    
                case 'background':
                    const bgId = generateId();
                    data.backgrounds.push({
                        id: bgId,
                        name: 'æœªå‘½åå ´æ™¯',
                        type: 'åœ°é»',
                        description: content,
                        rules: '',
                        notes: '',
                        tags: [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                    saveData();
                    editBackground(bgId);
                    break;
                    
                case 'novel':
                    const novelId = generateId();
                    data.novels.push({
                        id: novelId,
                        title: 'æœªå‘½åå°èªª',
                        prompt: '',
                        content: content,
                        notes: '',
                        relatedMaterials: [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                    saveData();
                    editNovel(novelId);
                    break;
            }
        }

        // æ™ºèƒ½åˆ†é¡å»ºè­°
        function suggestClassification(content) {
            const suggestion = document.getElementById('aiSuggestion');
            const suggestionText = document.getElementById('suggestionText');
            
            // ç°¡å–®çš„é—œéµè©åˆ†æ
            const lowerContent = content.toLowerCase();
            let type = '';
            let confidence = '';
            
            if (lowerContent.includes('ä»–') || lowerContent.includes('å¥¹') || lowerContent.includes('åå­—') || 
                lowerContent.includes('æ­²') || lowerContent.includes('æ€§æ ¼') || lowerContent.includes('å¤–è²Œ')) {
                type = 'è§’è‰²æè¿°';
                confidence = 'é«˜';
            } else if (lowerContent.includes('åœ°æ–¹') || lowerContent.includes('åŸå¸‚') || lowerContent.includes('ä¸–ç•Œ') ||
                       lowerContent.includes('è¦å‰‡') || lowerContent.includes('ç’°å¢ƒ') || lowerContent.includes('å ´æ™¯')) {
                type = 'å ´æ™¯æè¿°';
                confidence = 'é«˜';
            } else if (lowerContent.includes('æ•…äº‹') || lowerContent.includes('åŠ‡æƒ…') || content.length > 500) {
                type = 'å°èªªå…§å®¹';
                confidence = 'ä¸­';
            } else {
                type = 'æœªçŸ¥é¡å‹';
                confidence = 'ä½';
            }
            
            suggestion.style.display = 'flex';
            suggestionText.textContent = `${type} (ä¿¡å¿ƒåº¦: ${confidence})`;
        }

        // è‡ªå‹•åˆ†é¡
        function autoClassify() {
            const content = document.getElementById('quickContent').value;
            if (!content) {
                alert('è«‹å…ˆè¼¸å…¥å…§å®¹ï¼');
                return;
            }
            
            const lowerContent = content.toLowerCase();
            
            if (lowerContent.includes('ä»–') || lowerContent.includes('å¥¹') || lowerContent.includes('åå­—') || 
                lowerContent.includes('æ­²') || lowerContent.includes('æ€§æ ¼')) {
                quickClassify('character');
            } else if (lowerContent.includes('åœ°æ–¹') || lowerContent.includes('åŸå¸‚') || lowerContent.includes('ä¸–ç•Œ') ||
                       lowerContent.includes('è¦å‰‡') || lowerContent.includes('ç’°å¢ƒ')) {
                quickClassify('background');
            } else {
                quickClassify('novel');
            }
        }

        // é»æ“Šå¤–éƒ¨é—œé–‰ä¸‹æ‹‰é¸å–®
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select')) {
                const dropdowns = document.querySelectorAll('.multi-select-dropdown');
                dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
            }
        });

        // é˜²æ­¢è¡¨å–®æäº¤åˆ·æ–°é é¢
        document.addEventListener('submit', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
