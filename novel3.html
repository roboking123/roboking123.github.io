<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Â∞èË™™Á¥†ÊùêÂ∫´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #a78bfa;
            --accent: #f472b6;
            --bg-dark: #0f172a;
            --bg-light: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-light) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ÁôªÂÖ•È†ÅÈù¢ */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box h1 {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .password-input {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* Â∞éËà™Ê¨Ñ */
        .navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: var(--primary);
        }

        /* ‰∏ªÂÆπÂô® */
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* È†ÅÈù¢Ê®ôÈ°å */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .page-title {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Âç°ÁâáÊ®£Âºè */
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        /* Ê®ôÁ±§ */
        .tag {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            background: rgba(99, 102, 241, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(99, 102, 241, 0.3);
            transition: all 0.3s;
        }

        .tag:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: scale(1.05);
        }

        .tag.tag-hero { background: rgba(16, 185, 129, 0.2); color: #10b981; border-color: rgba(16, 185, 129, 0.3); }
        .tag.tag-villain { background: rgba(239, 68, 68, 0.2); color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
        .tag.tag-support { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); }

        /* ÊåâÈàï */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background: rgba(99, 102, 241, 0.3);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* Ë°®ÂñÆ */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: rgba(15, 23, 42, 0.5);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* ÊêúÂ∞ãÊ¨Ñ */
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        /* Áµ±Ë®àË≥áË®ä */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(167, 139, 250, 0.1));
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(99, 102, 241, 0.3);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Á∑®ËºØÈ†ÅÈù¢ */
        .edit-page {
            max-width: 800px;
            margin: 0 auto;
        }

        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* AIÂä©Êâã */
        .ai-assistant {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.1), rgba(99, 102, 241, 0.1));
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(244, 114, 182, 0.3);
        }

        .material-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .material-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .material-item:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .material-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* ÂãïÁï´ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .nav-menu {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(15, 23, 42, 0.95);
                backdrop-filter: blur(10px);
                padding: 1rem;
                display: flex;
                justify-content: space-around;
                box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.3);
            }

            .nav-container {
                padding: 0;
            }

            .main-container {
                padding: 0 1rem;
                margin-bottom: 5rem;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ËºâÂÖ•ÂãïÁï´ */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ë≠¶ÂëäÊèêÁ§∫ */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.5);
            color: var(--warning);
        }

        /* ÁßòÂØÜË®≠ÂÆöÁöÑÁâπÊÆäÊ®£Âºè */
        .secret-warning {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1));
            border: 2px solid rgba(239, 68, 68, 0.5);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Â§öÈÅ∏‰∏ãÊãâÊ°Ü */
        .multi-select {
            position: relative;
        }

        .multi-select-input {
            cursor: pointer;
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid var(--border);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-primary);
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .multi-select-option:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .multi-select-option input {
            cursor: pointer;
        }

        /* Âø´ÈÄüÂàÜÈ°ûÂä©Êâã */
        .quick-classifier {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(99, 102, 241, 0.1));
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .content-preview {
            background: rgba(15, 23, 42, 0.5);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .content-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, rgba(15, 23, 42, 0.5));
        }

        .ai-suggestion {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* ÂΩ©Ëâ≤ÂúñÊ®ô */
        .icon-character { color: #f472b6; }
        .icon-background { color: #60a5fa; }
        .icon-secret { color: #fb923c; }
        .icon-novel { color: #a78bfa; }
        .icon-ai { color: #34d399; }
    </style>
</head>
<body>
    <!-- ÁôªÂÖ•È†ÅÈù¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>üìö Â∞èË™™Á¥†ÊùêÂ∫´</h1>
            <input type="password" class="password-input" id="passwordInput" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" onkeypress="if(event.key==='Enter') login()">
            <button class="login-btn" onclick="login()">ÈÄ≤ÂÖ•Á≥ªÁµ±</button>
        </div>
    </div>

    <!-- ‰∏ªÊáâÁî® -->
    <div id="app" style="display: none;">
        <!-- Â∞éËà™Ê¨Ñ -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">üìö Â∞èË™™Á¥†ÊùêÂ∫´</div>
                <div class="nav-menu">
                    <div class="nav-item" onclick="showPage('dashboard')">üìä Á∏ΩË¶Ω</div>
                    <div class="nav-item" onclick="showPage('characters')">üë§ ËßíËâ≤</div>
                    <div class="nav-item" onclick="showPage('backgrounds')">üåç ËÉåÊôØ</div>
                    <div class="nav-item" onclick="showPage('secrets')">üîê ÁßòÂØÜ</div>
                    <div class="nav-item" onclick="showPage('novels')">üìñ Â∞èË™™</div>
                    <div class="nav-item" onclick="showPage('ai')">ü§ñ AIÂä©Êâã</div>
                    <div class="nav-item" onclick="showPage('settings')">‚öôÔ∏è Ë®≠ÂÆö</div>
                    <div class="nav-item" onclick="logout()">üö™ ÁôªÂá∫</div>
                </div>
            </div>
        </nav>

        <!-- ‰∏ªÂÖßÂÆπÂçÄ -->
        <div class="main-container">
            <div id="pageContent"></div>
        </div>
    </div>

    <script>
        // Ë≥áÊñôÁµêÊßã
        let data = {
            characters: [],
            backgrounds: [],
            secrets: [],
            novels: [],
            settings: {
                password: 'admin',
                autoBackup: true,
                googleDriveToken: null
            }
        };

        // ÂàùÂßãÂåñ
        window.onload = function() {
            loadData();
            if (localStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                showPage('dashboard');
            }
        };

        // ÁôªÂÖ•ÂäüËÉΩ
        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === data.settings.password) {
                localStorage.setItem('isLoggedIn', 'true');
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                showPage('dashboard');
            } else {
                alert('ÂØÜÁ¢ºÈåØË™§ÔºÅ');
            }
        }

        // ÁôªÂá∫ÂäüËÉΩ
        function logout() {
            localStorage.removeItem('isLoggedIn');
            location.reload();
        }

        // Ë≥áÊñôÂ≠òÂèñ
        function loadData() {
            const saved = localStorage.getItem('novelMaterialData');
            if (saved) {
                data = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('novelMaterialData', JSON.stringify(data));
            if (data.settings.autoBackup) {
                // ÈÄôË£°ÂèØ‰ª•Âä†ÂÖ• Google Drive Ëá™ÂãïÂÇô‰ªΩ
            }
        }

        // È†ÅÈù¢Ë∑ØÁî±
        function showPage(page) {
            // Êõ¥Êñ∞Â∞éËà™Ê¨Ñ
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // È°ØÁ§∫Â∞çÊáâÈ†ÅÈù¢
            const content = document.getElementById('pageContent');
            content.classList.remove('fade-in');
            
            setTimeout(() => {
                switch(page) {
                    case 'dashboard':
                        showDashboard();
                        break;
                    case 'characters':
                        showCharacters();
                        break;
                    case 'backgrounds':
                        showBackgrounds();
                        break;
                    case 'secrets':
                        showSecrets();
                        break;
                    case 'novels':
                        showNovels();
                        break;
                    case 'ai':
                        showAI();
                        break;
                    case 'settings':
                        showSettings();
                        break;
                }
                content.classList.add('fade-in');
            }, 100);
        }

        // Á∏ΩË¶ΩÈ†ÅÈù¢
        function showDashboard() {
            const totalWords = calculateTotalWords();
            const recentItems = getRecentItems();
            
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">üìä Á∏ΩË¶Ω</h1>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.characters.length}</div>
                        <div class="stat-label">ËßíËâ≤Á∏ΩÊï∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.backgrounds.length}</div>
                        <div class="stat-label">ËÉåÊôØË®≠ÂÆö</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.secrets.length}</div>
                        <div class="stat-label">ÁßòÂØÜË®≠ÂÆö</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.novels.length}</div>
                        <div class="stat-label">AIÂ∞èË™™</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalWords}</div>
                        <div class="stat-label">Á∏ΩÂ≠óÊï∏</div>
                    </div>
                </div>

                <h2 style="margin: 2rem 0 1rem;">üïê ÊúÄËøëÊõ¥Êñ∞</h2>
                <div id="recentItems">
                    ${recentItems.map(item => `
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">${item.icon} ${item.title}</div>
                                    <div class="card-meta">
                                        <span class="tag">${item.type}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.875rem;">
                                            ${new Date(item.updatedAt).toLocaleDateString()}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="quick-classifier">
                    <h3 style="margin-bottom: 1rem;">‚ö° Âø´ÈÄüÂàÜÈ°ûÂä©Êâã</h3>
                    <div class="content-preview">
                        <textarea id="quickContent" class="form-textarea" placeholder="Ë≤º‰∏äÊàñËº∏ÂÖ•ÂÖßÂÆπ..." style="min-height: 80px;"></textarea>
                    </div>
                    <div class="ai-suggestion" id="aiSuggestion" style="display: none;">
                        ü§ñ Á≥ªÁµ±Âª∫Ë≠∞Ôºö<span id="suggestionText"></span>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-secondary" onclick="quickClassify('character')">üë§ Â≠òÁÇ∫ËßíËâ≤</button>
                        <button class="btn btn-secondary" onclick="quickClassify('background')">üåç Â≠òÁÇ∫ËÉåÊôØ</button>
                        <button class="btn btn-secondary" onclick="quickClassify('novel')">üìñ Â≠òÁÇ∫Â∞èË™™</button>
                        <button class="btn btn-primary" onclick="autoClassify()">ü§ñ Êô∫ËÉΩÂàÜÈ°û</button>
                    </div>
                </div>
            `;

            // Áõ£ËÅΩÂø´ÈÄüËº∏ÂÖ•Ê°Ü
            document.getElementById('quickContent').addEventListener('input', (e) => {
                if (e.target.value.length > 10) {
                    suggestClassification(e.target.value);
                }
            });
        }

        // ËßíËâ≤È†ÅÈù¢
        function showCharacters() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">üë§ ËßíËâ≤Ë®≠ÂÆö</h1>
                    <button class="btn btn-primary" onclick="editCharacter()">
                        <span>‚ûï</span> Êñ∞Â¢ûËßíËâ≤
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" class="form-input search-input" placeholder="ÊêúÂ∞ãËßíËâ≤..." onkeyup="searchCharacters(this.value)">
                    <select class="form-select" style="width: 200px;" onchange="filterByTag(this.value, 'characters')">
                        <option value="">ÊâÄÊúâÊ®ôÁ±§</option>
                        <option value="‰∏ªËßí">‰∏ªËßí</option>
                        <option value="ÈÖçËßí">ÈÖçËßí</option>
                        <option value="ÂèçÊ¥æ">ÂèçÊ¥æ</option>
                    </select>
                </div>

                <div id="charactersList">
                    ${renderCharacters(data.characters)}
                </div>
            `;
        }

        // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
        function renderCharacters(characters) {
            if (characters.length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">ÈÇÑÊ≤íÊúâËßíËâ≤ÔºåÈªûÊìä‰∏äÊñπÊåâÈàïÊñ∞Â¢ûÁ¨¨‰∏ÄÂÄãËßíËâ≤ÔºÅ</p>';
            }

            return characters.map(char => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${char.name}</div>
                            <div class="card-meta">
                                ${char.tags.map(tag => `<span class="tag tag-${tag === '‰∏ªËßí' ? 'hero' : tag === 'ÂèçÊ¥æ' ? 'villain' : 'support'}">${tag}</span>`).join('')}
                                <span style="color: var(--text-secondary);">Âπ¥ÈΩ°: ${char.age || 'Êú™Áü•'}</span>
                                <span style="color: var(--text-secondary);">Á®ÆÊóè: ${char.race || '‰∫∫È°û'}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editCharacter('${char.id}')">Á∑®ËºØ</button>
                            <button class="btn btn-danger" onclick="deleteItem('characters', '${char.id}')">Âà™Èô§</button>
                        </div>
                    </div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                        ${char.description ? char.description.substring(0, 100) + '...' : 'Ê≤íÊúâÊèèËø∞'}
                    </div>
                </div>
            `).join('');
        }

        // Á∑®ËºØËßíËâ≤
        function editCharacter(id = null) {
            const character = id ? data.characters.find(c => c.id === id) : {
                id: generateId(),
                name: '',
                age: '',
                appearance: { hair: '', eyes: '' },
                race: '',
                personality: '',
                background: '',
                notes: '',
                tags: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${id ? 'Á∑®ËºØ' : 'Êñ∞Â¢û'}ËßíËâ≤</h1>
                        <button class="btn btn-secondary" onclick="showCharacters()">ËøîÂõû</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ËßíËâ≤ÂêçÁ®± *</label>
                        <input type="text" class="form-input" id="charName" value="${character.name}" placeholder="Ëº∏ÂÖ•ËßíËâ≤ÂêçÁ®±">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Âπ¥ÈΩ°</label>
                            <input type="text" class="form-input" id="charAge" value="${character.age}" placeholder="‰æãÂ¶Ç: 25">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Á®ÆÊóè</label>
                            <input type="text" class="form-input" id="charRace" value="${character.race}" placeholder="‰æãÂ¶Ç: ‰∫∫È°û„ÄÅÁ≤æÈùà">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">È´ÆËâ≤</label>
                            <select class="form-select" id="charHair">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="ÈªëËâ≤" ${character.appearance.hair === 'ÈªëËâ≤' ? 'selected' : ''}>ÈªëËâ≤</option>
                                <option value="Ê£ïËâ≤" ${character.appearance.hair === 'Ê£ïËâ≤' ? 'selected' : ''}>Ê£ïËâ≤</option>
                                <option value="ÈáëËâ≤" ${character.appearance.hair === 'ÈáëËâ≤' ? 'selected' : ''}>ÈáëËâ≤</option>
                                <option value="Á¥ÖËâ≤" ${character.appearance.hair === 'Á¥ÖËâ≤' ? 'selected' : ''}>Á¥ÖËâ≤</option>
                                <option value="ÁôΩËâ≤" ${character.appearance.hair === 'ÁôΩËâ≤' ? 'selected' : ''}>ÁôΩËâ≤</option>
                                <option value="ËóçËâ≤" ${character.appearance.hair === 'ËóçËâ≤' ? 'selected' : ''}>ËóçËâ≤</option>
                                <option value="Á∂†Ëâ≤" ${character.appearance.hair === 'Á∂†Ëâ≤' ? 'selected' : ''}>Á∂†Ëâ≤</option>
                                <option value="Á¥´Ëâ≤" ${character.appearance.hair === 'Á¥´Ëâ≤' ? 'selected' : ''}>Á¥´Ëâ≤</option>
                                <option value="ÂÖ∂‰ªñ" ${character.appearance.hair === 'ÂÖ∂‰ªñ' ? 'selected' : ''}>ÂÖ∂‰ªñ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÁúºËâ≤</label>
                            <select class="form-select" id="charEyes">
                                <option value="">Ë´ãÈÅ∏Êìá</option>
                                <option value="ÈªëËâ≤" ${character.appearance.eyes === 'ÈªëËâ≤' ? 'selected' : ''}>ÈªëËâ≤</option>
                                <option value="Ê£ïËâ≤" ${character.appearance.eyes === 'Ê£ïËâ≤' ? 'selected' : ''}>Ê£ïËâ≤</option>
                                <option value="ËóçËâ≤" ${character.appearance.eyes === 'ËóçËâ≤' ? 'selected' : ''}>ËóçËâ≤</option>
                                <option value="Á∂†Ëâ≤" ${character.appearance.eyes === 'Á∂†Ëâ≤' ? 'selected' : ''}>Á∂†Ëâ≤</option>
                                <option value="ÁÅ∞Ëâ≤" ${character.appearance.eyes === 'ÁÅ∞Ëâ≤' ? 'selected' : ''}>ÁÅ∞Ëâ≤</option>
                                <option value="Á¥ÖËâ≤" ${character.appearance.eyes === 'Á¥ÖËâ≤' ? 'selected' : ''}>Á¥ÖËâ≤</option>
                                <option value="Á¥´Ëâ≤" ${character.appearance.eyes === 'Á¥´Ëâ≤' ? 'selected' : ''}>Á¥´Ëâ≤</option>
                                <option value="Áï∞Ëâ≤Áû≥" ${character.appearance.eyes === 'Áï∞Ëâ≤Áû≥' ? 'selected' : ''}>Áï∞Ëâ≤Áû≥</option>
                                <option value="ÂÖ∂‰ªñ" ${character.appearance.eyes === 'ÂÖ∂‰ªñ' ? 'selected' : ''}>ÂÖ∂‰ªñ</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Â§ñË≤åÊèèËø∞</label>
                        <textarea class="form-textarea" id="charDescription" placeholder="Ë©≥Á¥∞ÊèèËø∞ËßíËâ≤ÁöÑÂ§ñË≤åÁâπÂæµ...">${character.description || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÊÄßÊ†ºÁâπË≥™</label>
                        <textarea class="form-textarea" id="charPersonality" placeholder="ÊèèËø∞ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁøíÊÖ£„ÄÅÂñúÂ•ΩÁ≠â...">${character.personality}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ËÉåÊôØÊïÖ‰∫ã</label>
                        <textarea class="form-textarea" id="charBackground" placeholder="ËßíËâ≤ÁöÑÈÅéÂéª„ÄÅÁ∂ìÊ≠∑„ÄÅÂãïÊ©üÁ≠â..." style="min-height: 150px;">${character.background}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">È°çÂ§ñÂÇôË®ª</label>
                        <textarea class="form-textarea" id="charNotes" placeholder="ÂÖ∂‰ªñÈáçË¶ÅË≥áË®ä...">${character.notes}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ê®ôÁ±§</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label><input type="checkbox" id="tag-hero" ${character.tags.includes('‰∏ªËßí') ? 'checked' : ''}> ‰∏ªËßí</label>
                            <label><input type="checkbox" id="tag-support" ${character.tags.includes('ÈÖçËßí') ? 'checked' : ''}> ÈÖçËßí</label>
                            <label><input type="checkbox" id="tag-villain" ${character.tags.includes('ÂèçÊ¥æ') ? 'checked' : ''}> ÂèçÊ¥æ</label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="showCharacters()">ÂèñÊ∂à</button>
                        <button class="btn btn-primary" onclick="saveCharacter('${character.id}', ${!!id})">
                            <span>üíæ</span> ÂÑ≤Â≠ò
                        </button>
                    </div>
                </div>
            `;
        }

        // ÂÑ≤Â≠òËßíËâ≤
        function saveCharacter(id, isEdit) {
            const character = {
                id: id,
                name: document.getElementById('charName').value,
                age: document.getElementById('charAge').value,
                appearance: {
                    hair: document.getElementById('charHair').value,
                    eyes: document.getElementById('charEyes').value
                },
                race: document.getElementById('charRace').value,
                description: document.getElementById('charDescription').value,
                personality: document.getElementById('charPersonality').value,
                background: document.getElementById('charBackground').value,
                notes: document.getElementById('charNotes').value,
                tags: [],
                updatedAt: Date.now()
            };

            if (!character.name) {
                alert('Ë´ãËº∏ÂÖ•ËßíËâ≤ÂêçÁ®±ÔºÅ');
                return;
            }

            // Êî∂ÈõÜÊ®ôÁ±§
            if (document.getElementById('tag-hero').checked) character.tags.push('‰∏ªËßí');
            if (document.getElementById('tag-support').checked) character.tags.push('ÈÖçËßí');
            if (document.getElementById('tag-villain').checked) character.tags.push('ÂèçÊ¥æ');

            if (isEdit) {
                const index = data.characters.findIndex(c => c.id === id);
                character.createdAt = data.characters[index].createdAt;
                data.characters[index] = character;
            } else {
                character.createdAt = Date.now();
                data.characters.push(character);
            }

            saveData();
            showCharacters();
        }

        // ËÉåÊôØÈ†ÅÈù¢
        function showBackgrounds() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">üåç ÊïÖ‰∫ãËÉåÊôØ</h1>
                    <button class="btn btn-primary" onclick="editBackground()">
                        <span>‚ûï</span> Êñ∞Â¢ûËÉåÊôØ
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" class="form-input search-input" placeholder="ÊêúÂ∞ãËÉåÊôØ..." onkeyup="searchBackgrounds(this.value)">
                    <select class="form-select" style="width: 200px;" onchange="filterByType(this.value, 'backgrounds')">
                        <option value="">ÊâÄÊúâÈ°ûÂûã</option>
                        <option value="Âú∞Èªû">Âú∞Èªû</option>
                        <option value="ÊôÇ‰ª£">ÊôÇ‰ª£</option>
                        <option value="‰∏ñÁïåËßÄ">‰∏ñÁïåËßÄ</option>
                        <option value="ÊñáÂåñ">ÊñáÂåñ</option>
                        <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                    </select>
                </div>

                <div id="backgroundsList">
                    ${renderBackgrounds(data.backgrounds)}
                </div>
            `;
        }

        // Ê∏≤ÊüìËÉåÊôØÂàóË°®
        function renderBackgrounds(backgrounds) {
            if (backgrounds.length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">ÈÇÑÊ≤íÊúâËÉåÊôØË®≠ÂÆöÔºåÈªûÊìä‰∏äÊñπÊåâÈàïÊñ∞Â¢ûÔºÅ</p>';
            }

            return backgrounds.map(bg => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${bg.name}</div>
                            <div class="card-meta">
                                <span class="tag">${bg.type}</span>
                                ${bg.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editBackground('${bg.id}')">Á∑®ËºØ</button>
                            <button class="btn btn-danger" onclick="deleteItem('backgrounds', '${bg.id}')">Âà™Èô§</button>
                        </div>
                    </div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                        ${bg.description ? bg.description.substring(0, 150) + '...' : 'Ê≤íÊúâÊèèËø∞'}
                    </div>
                </div>
            `).join('');
        }

        // Á∑®ËºØËÉåÊôØ
        function editBackground(id = null) {
            const background = id ? data.backgrounds.find(b => b.id === id) : {
                id: generateId(),
                name: '',
                type: 'Âú∞Èªû',
                description: '',
                rules: '',
                notes: '',
                tags: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${id ? 'Á∑®ËºØ' : 'Êñ∞Â¢û'}ËÉåÊôØ</h1>
                        <button class="btn btn-secondary" onclick="showBackgrounds()">ËøîÂõû</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Â†¥ÊôØÂêçÁ®± *</label>
                        <input type="text" class="form-input" id="bgName" value="${background.name}" placeholder="Ëº∏ÂÖ•Â†¥ÊôØÂêçÁ®±">
                    </div>

                    <div class="form-group">
                        <label class="form-label">È°ûÂûã</label>
                        <select class="form-select" id="bgType">
                            <option value="Âú∞Èªû" ${background.type === 'Âú∞Èªû' ? 'selected' : ''}>Âú∞Èªû</option>
                            <option value="ÊôÇ‰ª£" ${background.type === 'ÊôÇ‰ª£' ? 'selected' : ''}>ÊôÇ‰ª£</option>
                            <option value="‰∏ñÁïåËßÄ" ${background.type === '‰∏ñÁïåËßÄ' ? 'selected' : ''}>‰∏ñÁïåËßÄ</option>
                            <option value="ÊñáÂåñ" ${background.type === 'ÊñáÂåñ' ? 'selected' : ''}>ÊñáÂåñ</option>
                            <option value="ÂÖ∂‰ªñ" ${background.type === 'ÂÖ∂‰ªñ' ? 'selected' : ''}>ÂÖ∂‰ªñ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ë©≥Á¥∞ÊèèËø∞</label>
                        <textarea class="form-textarea" id="bgDescription" placeholder="ÊèèËø∞ÈÄôÂÄãÂ†¥ÊôØÁöÑÁ¥∞ÁØÄ..." style="min-height: 200px;">${background.description}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ë¶èÂâá/Ê≥ïÂâá</label>
                        <textarea class="form-textarea" id="bgRules" placeholder="ÈÄôÂÄã‰∏ñÁïåÁöÑÁâπÊÆäË¶èÂâáÊàñÊ≥ïÂâá...">${background.rules}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <textarea class="form-textarea" id="bgNotes" placeholder="ÂÖ∂‰ªñÊ≥®ÊÑè‰∫ãÈ†Ö...">${background.notes}</textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="showBackgrounds()">ÂèñÊ∂à</button>
                        <button class="btn btn-primary" onclick="saveBackground('${background.id}', ${!!id})">
                            <span>üíæ</span> ÂÑ≤Â≠ò
                        </button>
                    </div>
                </div>
            `;
        }

        // ÂÑ≤Â≠òËÉåÊôØ
        function saveBackground(id, isEdit) {
            const background = {
                id: id,
                name: document.getElementById('bgName').value,
                type: document.getElementById('bgType').value,
                description: document.getElementById('bgDescription').value,
                rules: document.getElementById('bgRules').value,
                notes: document.getElementById('bgNotes').value,
                tags: [],
                updatedAt: Date.now()
            };

            if (!background.name) {
                alert('Ë´ãËº∏ÂÖ•Â†¥ÊôØÂêçÁ®±ÔºÅ');
                return;
            }

            if (isEdit) {
                const index = data.backgrounds.findIndex(b => b.id === id);
                background.createdAt = data.backgrounds[index].createdAt;
                data.backgrounds[index] = background;
            } else {
                background.createdAt = Date.now();
                data.backgrounds.push(background);
            }

            saveData();
            showBackgrounds();
        }

        // ÁßòÂØÜË®≠ÂÆöÈ†ÅÈù¢
        function showSecrets() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">üîê ÁßòÂØÜË®≠ÂÆö</h1>
                    <button class="btn btn-primary" onclick="editSecret()">
                        <span>‚ûï</span> Êñ∞Â¢ûÁßòÂØÜ
                    </button>
                </div>

                <div class="secret-warning">
                    ‚ö†Ô∏è Ê≥®ÊÑèÔºöÊ≠§ÂçÄÂüüÂåÖÂê´ÂäáÈÄèÂÖßÂÆπÔºåË´ãË¨πÊÖéÊü•ÁúãÔºÅ
                </div>

                <div class="search-bar">
                    <input type="text" class="form-input search-input" placeholder="ÊêúÂ∞ãÁßòÂØÜ..." onkeyup="searchSecrets(this.value)">
                    <select class="form-select" style="width: 200px;" onchange="filterByCategory(this.value, 'secrets')">
                        <option value="">ÊâÄÊúâÈ°ûÂà•</option>
                        <option value="ÂäáÊÉÖËΩâÊäò">ÂäáÊÉÖËΩâÊäò</option>
                        <option value="ËßíËâ≤ÁßòÂØÜ">ËßíËâ≤ÁßòÂØÜ</option>
                        <option value="‰∏ñÁïåË®≠ÂÆö">‰∏ñÁïåË®≠ÂÆö</option>
                        <option value="‰ºèÁ≠Ü">‰ºèÁ≠Ü</option>
                        <option value="ÁµêÂ±Ä">ÁµêÂ±Ä</option>
                    </select>
                </div>

                <div id="secretsList">
                    ${renderSecrets(data.secrets)}
                </div>
            `;
        }

        // Ê∏≤ÊüìÁßòÂØÜÂàóË°®
        function renderSecrets(secrets) {
            if (secrets.length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">ÈÇÑÊ≤íÊúâÁßòÂØÜË®≠ÂÆöÔºåÈªûÊìä‰∏äÊñπÊåâÈàïÊñ∞Â¢ûÔºÅ</p>';
            }

            return secrets.map(secret => `
                <div class="card" style="border-color: rgba(239, 68, 68, 0.3);">
                    <div class="card-header">
                        <div>
                            <div class="card-title">üîí ${secret.title}</div>
                            <div class="card-meta">
                                <span class="tag tag-villain">${secret.category}</span>
                                ${secret.knownBy && secret.knownBy.length > 0 ? 
                                    `<span class="tag">Áü•ÊÉÖËÄÖ: ${secret.knownBy.length}‰∫∫</span>` : 
                                    '<span class="tag">ÁÑ°‰∫∫Áü•Êõâ</span>'
                                }
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="editSecret('${secret.id}')">Á∑®ËºØ</button>
                            <button class="btn btn-danger" onclick="deleteItem('secrets', '${secret.id}')">Âà™Èô§</button>
                        </div>
                    </div>
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: var(--warning);">‚ö†Ô∏è ÈªûÊìäÊü•ÁúãÁßòÂØÜÂÖßÂÆπ</summary>
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                            <p>${secret.content}</p>
                            ${secret.impact ? `<p style="margin-top: 0.5rem;"><strong>ÂΩ±ÈüøÔºö</strong>${secret.impact}</p>` : ''}
                            ${secret.knownBy && secret.knownBy.length > 0 ? 
                                `<p style="margin-top: 0.5rem;"><strong>Áü•ÊÉÖËÄÖÔºö</strong>${secret.knownBy.join('„ÄÅ')}</p>` : ''
                            }
                        </div>
                    </details>
                </div>
            `).join('');
        }

        // Á∑®ËºØÁßòÂØÜ
        function editSecret(id = null) {
            const secret = id ? data.secrets.find(s => s.id === id) : {
                id: generateId(),
                title: '',
                category: 'ÂäáÊÉÖËΩâÊäò',
                content: '',
                impact: '',
                knownBy: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${id ? 'Á∑®ËºØ' : 'Êñ∞Â¢û'}ÁßòÂØÜ</h1>
                        <button class="btn btn-secondary" onclick="showSecrets()">ËøîÂõû</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ê®ôÈ°å *</label>
                        <input type="text" class="form-input" id="secretTitle" value="${secret.title}" placeholder="Á∞°Áü≠ÊèèËø∞ÈÄôÂÄãÁßòÂØÜ">
                    </div>

                    <div class="form-group">
                        <label class="form-label">È°ûÂà•</label>
                        <select class="form-select" id="secretCategory">
                            <option value="ÂäáÊÉÖËΩâÊäò" ${secret.category === 'ÂäáÊÉÖËΩâÊäò' ? 'selected' : ''}>ÂäáÊÉÖËΩâÊäò</option>
                            <option value="ËßíËâ≤ÁßòÂØÜ" ${secret.category === 'ËßíËâ≤ÁßòÂØÜ' ? 'selected' : ''}>ËßíËâ≤ÁßòÂØÜ</option>
                            <option value="‰∏ñÁïåË®≠ÂÆö" ${secret.category === '‰∏ñÁïåË®≠ÂÆö' ? 'selected' : ''}>‰∏ñÁïåË®≠ÂÆö</option>
                            <option value="‰ºèÁ≠Ü" ${secret.category === '‰ºèÁ≠Ü' ? 'selected' : ''}>‰ºèÁ≠Ü</option>
                            <option value="ÁµêÂ±Ä" ${secret.category === 'ÁµêÂ±Ä' ? 'selected' : ''}>ÁµêÂ±Ä</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂÖßÂÆπ</label>
                        <textarea class="form-textarea" id="secretContent" placeholder="Ë©≥Á¥∞ÊèèËø∞ÈÄôÂÄãÁßòÂØÜ..." style="min-height: 200px;">${secret.content}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂΩ±Èüø/ÈáçË¶ÅÊÄß</label>
                        <textarea class="form-textarea" id="secretImpact" placeholder="ÈÄôÂÄãÁßòÂØÜÊúÉÂ¶Ç‰ΩïÂΩ±ÈüøÊïÖ‰∫ã...">${secret.impact}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Áü•ÊÉÖ‰∫∫Âì°</label>
                        <div class="multi-select">
                            <div class="multi-select-input" onclick="toggleMultiSelect()">
                                <span id="selectedKnownBy">${secret.knownBy.length > 0 ? secret.knownBy.join('„ÄÅ') : 'ÈÅ∏ÊìáÁü•ÊÉÖËÄÖ'}</span>
                                <span>‚ñº</span>
                            </div>
                            <div class="multi-select-dropdown" id="knownByDropdown">
                                ${data.characters.map(char => `
                                    <div class="multi-select-option">
                                        <input type="checkbox" id="known-${char.id}" value="${char.name}" 
                                            ${secret.knownBy.includes(char.name) ? 'checked' : ''} 
                                            onchange="updateKnownBy()">
                                        <label for="known-${char.id}">${char.name}</label>
                                    </div>
                                `).join('')}
                                <div style="padding: 0.5rem 1rem;">
                                    <input type="text" class="form-input" id="customKnownBy" 
                                        placeholder="Ëº∏ÂÖ•ÂÖ∂‰ªñÁü•ÊÉÖËÄÖÔºàÊåâEnterÊ∑ªÂä†Ôºâ" 
                                        onkeypress="if(event.key==='Enter') addCustomKnownBy()">
                                </div>
                            </div>
                        </div>
                        <div id="customKnownByList" style="margin-top: 0.5rem;">
                            ${secret.knownBy.filter(name => !data.characters.some(c => c.name === name))
                                .map(name => `<span class="tag">${name} <span onclick="removeCustomKnownBy('${name}')" style="cursor: pointer;">√ó</span></span>`).join('')}
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="showSecrets()">ÂèñÊ∂à</button>
                        <button class="btn btn-primary" onclick="saveSecret('${secret.id}', ${!!id})">
                            <span>üíæ</span> ÂÑ≤Â≠ò
                        </button>
                    </div>
                </div>
            `;
        }

        // ÂàáÊèõÂ§öÈÅ∏‰∏ãÊãâÊ°Ü
        function toggleMultiSelect() {
            const dropdown = document.getElementById('knownByDropdown');
            dropdown.classList.toggle('show');
        }

        // Êõ¥Êñ∞Áü•ÊÉÖËÄÖ
        function updateKnownBy() {
            const checkboxes = document.querySelectorAll('#knownByDropdown input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            const custom = Array.from(document.querySelectorAll('#customKnownByList .tag')).map(tag => tag.textContent.replace(' √ó', ''));
            const all = [...selected, ...custom];
            document.getElementById('selectedKnownBy').textContent = all.length > 0 ? all.join('„ÄÅ') : 'ÈÅ∏ÊìáÁü•ÊÉÖËÄÖ';
        }

        // Ê∑ªÂä†Ëá™ÂÆöÁæ©Áü•ÊÉÖËÄÖ
        function addCustomKnownBy() {
            const input = document.getElementById('customKnownBy');
            const value = input.value.trim();
            if (value) {
                const customList = document.getElementById('customKnownByList');
                customList.innerHTML += `<span class="tag">${value} <span onclick="removeCustomKnownBy('${value}')" style="cursor: pointer;">√ó</span></span>`;
                input.value = '';
                updateKnownBy();
            }
        }

        // ÁßªÈô§Ëá™ÂÆöÁæ©Áü•ÊÉÖËÄÖ
        function removeCustomKnownBy(name) {
            const customList = document.getElementById('customKnownByList');
            const tags = Array.from(customList.querySelectorAll('.tag'));
            tags.forEach(tag => {
                if (tag.textContent.replace(' √ó', '') === name) {
                    tag.remove();
                }
            });
            updateKnownBy();
        }

        // ÂÑ≤Â≠òÁßòÂØÜ
        function saveSecret(id, isEdit) {
            const checkboxes = document.querySelectorAll('#knownByDropdown input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            const custom = Array.from(document.querySelectorAll('#customKnownByList .tag')).map(tag => tag.textContent.replace(' √ó', ''));
            
            const secret = {
                id: id,
                title: document.getElementById('secretTitle').value,
                category: document.getElementById('secretCategory').value,
                content: document.getElementById('secretContent').value,
                impact: document.getElementById('secretImpact').value,
                knownBy: [...selected, ...custom],
                updatedAt: Date.now()
            };

            if (!secret.title) {
                alert('Ë´ãËº∏ÂÖ•Ê®ôÈ°åÔºÅ');
                return;
            }

            if (isEdit) {
                const index = data.secrets.findIndex(s => s.id === id);
                secret.createdAt = data.secrets[index].createdAt;
                data.secrets[index] = secret;
            } else {
                secret.createdAt = Date.now();
                data.secrets.push(secret);
            }

            saveData();
            showSecrets();
        }

        // AIÂ∞èË™™È†ÅÈù¢
        function showNovels() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">üìñ AIÂ∞èË™™</h1>
                    <button class="btn btn-primary" onclick="editNovel()">
                        <span>‚ûï</span> Êñ∞Â¢ûÂ∞èË™™
                    </button>
                </div>

                <div class="search-bar">
                    <input type="text" class="form-input search-input" placeholder="ÊêúÂ∞ãÂ∞èË™™..." onkeyup="searchNovels(this.value)">
                </div>

                <div id="novelsList">
                    ${renderNovels(data.novels)}
                </div>
            `;
        }

        // Ê∏≤ÊüìÂ∞èË™™ÂàóË°®
        function renderNovels(novels) {
            if (novels.length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">ÈÇÑÊ≤íÊúâAIÂ∞èË™™ÔºåÈªûÊìä‰∏äÊñπÊåâÈàïÊñ∞Â¢ûÔºÅ</p>';
            }

            return novels.map(novel => `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${novel.title}</div>
                            <div class="card-meta">
                                <span class="tag">Â≠óÊï∏: ${novel.content.length}</span>
                                <span style="color: var(--text-secondary); font-size: 0.875rem;">
                                    ${new Date(novel.createdAt).toLocaleDateString()}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="viewNovel('${novel.id}')">Êü•Áúã</button>
                            <button class="btn btn-secondary" onclick="editNovel('${novel.id}')">Á∑®ËºØ</button>
                            <button class="btn btn-danger" onclick="deleteItem('novels', '${novel.id}')">Âà™Èô§</button>
                        </div>
                    </div>
                    <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                        ${novel.content.substring(0, 150)}...
                    </div>
                </div>
            `).join('');
        }

        // Êü•ÁúãÂ∞èË™™
        function viewNovel(id) {
            const novel = data.novels.find(n => n.id === id);
            if (!novel) return;

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${novel.title}</h1>
                        <button class="btn btn-secondary" onclick="showNovels()">ËøîÂõû</button>
                    </div>

                    <div class="card" style="background: rgba(99, 102, 241, 0.1);">
                        <h3>‰ΩøÁî®ÁöÑÊèêÁ§∫Ë©û</h3>
                        <p style="margin-top: 0.5rem; white-space: pre-wrap;">${novel.prompt || 'ÁÑ°'}</p>
                    </div>

                    <div class="card">
                        <h3>Â∞èË™™ÂÖßÂÆπ</h3>
                        <div style="margin-top: 1rem; white-space: pre-wrap; line-height: 1.8;">${novel.content}</div>
                    </div>

                    ${novel.notes ? `
                        <div class="card">
                            <h3>ÂÇôË®ª/Ë©ïÂÉπ</h3>
                            <p style="margin-top: 0.5rem;">${novel.notes}</p>
                        </div>
                    ` : ''}

                    ${novel.relatedMaterials && novel.relatedMaterials.length > 0 ? `
                        <div class="card">
                            <h3>Áõ∏ÈóúÁ¥†Êùê</h3>
                            <div class="card-meta" style="margin-top: 0.5rem;">
                                ${novel.relatedMaterials.map(material => `<span class="tag">${material}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Á∑®ËºØÂ∞èË™™
        function editNovel(id = null) {
            const novel = id ? data.novels.find(n => n.id === id) : {
                id: generateId(),
                title: '',
                prompt: '',
                content: '',
                notes: '',
                relatedMaterials: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };

            document.getElementById('pageContent').innerHTML = `
                <div class="edit-page">
                    <div class="edit-header">
                        <h1 class="page-title">${id ? 'Á∑®ËºØ' : 'Êñ∞Â¢û'}Â∞èË™™</h1>
                        <button class="btn btn-secondary" onclick="showNovels()">ËøîÂõû</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ê®ôÈ°å *</label>
                        <input type="text" class="form-input" id="novelTitle" value="${novel.title}" placeholder="Ëº∏ÂÖ•Â∞èË™™Ê®ôÈ°å">
                    </div>

                    <div class="form-group">
                        <label class="form-label">‰ΩøÁî®ÁöÑÊèêÁ§∫Ë©û</label>
                        <textarea class="form-textarea" id="novelPrompt" placeholder="Ë®òÈåÑ‰ΩøÁî®ÁöÑAIÊèêÁ§∫Ë©û..." style="min-height: 100px;">${novel.prompt}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Â∞èË™™ÂÖßÂÆπ</label>
                        <textarea class="form-textarea" id="novelContent" placeholder="Ë≤º‰∏äÊàñËº∏ÂÖ•Â∞èË™™ÂÖßÂÆπ..." style="min-height: 400px;">${novel.content}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª/Ë©ïÂÉπ</label>
                        <textarea class="form-textarea" id="novelNotes" placeholder="Â∞çÈÄôÂÄã‰ΩúÂìÅÁöÑÊÉ≥Ê≥ï...">${novel.notes}</textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="showNovels()">ÂèñÊ∂à</button>
                        <button class="btn btn-primary" onclick="saveNovel('${novel.id}', ${!!id})">
                            <span>üíæ</span> ÂÑ≤Â≠ò
                        </button>
                    </div>
                </div>
            `;
        }

        // ÂÑ≤Â≠òÂ∞èË™™
        function saveNovel(id, isEdit) {
            const novel = {
                id: id,
                title: document.getElementById('novelTitle').value,
                prompt: document.getElementById('novelPrompt').value,
                content: document.getElementById('novelContent').value,
                notes: document.getElementById('novelNotes').value,
                relatedMaterials: [],
                updatedAt: Date.now()
            };

            if (!novel.title) {
                alert('Ë´ãËº∏ÂÖ•Ê®ôÈ°åÔºÅ');
                return;
            }

            if (isEdit) {
                const index = data.novels.findIndex(n => n.id === id);
                novel.createdAt = data.novels[index].createdAt;
                data.novels[index] = novel;
            } else {
                novel.createdAt = Date.now();
                data.novels.push(novel);
            }

            saveData();
            showNovels();
        }

        // AIÂä©ÊâãÈ†ÅÈù¢
        function showAI() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">ü§ñ AIÂâµ‰ΩúÂä©Êâã</h1>
                </div>

                <div class="ai-assistant">
                    <h2 style="margin-bottom: 1.5rem;">ÈÅ∏ÊìáË¶Å‰ΩøÁî®ÁöÑÁ¥†Êùê</h2>
                    
                    <h3 style="margin-bottom: 1rem;">üë§ ËßíËâ≤</h3>
                    <div class="material-selector">
                        ${data.characters.map(char => `
                            <div class="material-item">
                                <input type="checkbox" id="ai-char-${char.id}" value="${char.id}">
                                <label for="ai-char-${char.id}">${char.name}</label>
                            </div>
                        `).join('')}
                    </div>

                    <h3 style="margin: 1.5rem 0 1rem;">üåç ËÉåÊôØ</h3>
                    <div class="material-selector">
                        ${data.backgrounds.map(bg => `
                            <div class="material-item">
                                <input type="checkbox" id="ai-bg-${bg.id}" value="${bg.id}">
                                <label for="ai-bg-${bg.id}">${bg.name}</label>
                            </div>
                        `).join('')}
                    </div>

                    <h3 style="margin: 1.5rem 0 1rem;">üîê ÁßòÂØÜË®≠ÂÆö</h3>
                    <div class="material-selector">
                        ${data.secrets.map(secret => `
                            <div class="material-item">
                                <input type="checkbox" id="ai-secret-${secret.id}" value="${secret.id}">
                                <label for="ai-secret-${secret.id}">${secret.title}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1rem;">üìù ÊèêÁ§∫Ë©ûÁîüÊàê</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Âø´ÈÄüÊ®°Êùø</label>
                        <select class="form-select" onchange="applyTemplate(this.value)">
                            <option value="">ÈÅ∏ÊìáÊ®°Êùø...</option>
                            <option value="story">Ââµ‰ΩúÂÆåÊï¥ÊïÖ‰∫ã</option>
                            <option value="dialogue">ËßíËâ≤Â∞çË©±</option>
                            <option value="scene">Â†¥ÊôØÊèèËø∞</option>
                            <option value="dnd">DNDËßíËâ≤Âç°</option>
                            <option value="plot">ÂäáÊÉÖÂàÜÊûê</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ëá™Ë®ÇÊèêÁ§∫Ë©û</label>
                        <textarea class="form-textarea" id="aiPrompt" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÂâµ‰ΩúÈúÄÊ±Ç..." style="min-height: 300px;"></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="generatePrompt()">
                            <span>üé≤</span> ÁîüÊàêÊèêÁ§∫Ë©û
                        </button>
                        <button class="btn btn-secondary" onclick="copyPrompt()">
                            <span>üìã</span> Ë§áË£Ω
                        </button>
                        <button class="btn btn-primary" onclick="sendToPerplexity()">
                            <span>üöÄ</span> ÁôºÈÄÅÂà∞Perplexity
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>üí° ‰ΩøÁî®ÊèêÁ§∫</h3>
                    <ul style="margin-top: 1rem; padding-left: 1.5rem; color: var(--text-secondary);">
                        <li>ÈÅ∏ÊìáÁõ∏ÈóúÁöÑËßíËâ≤„ÄÅËÉåÊôØÂíåÁßòÂØÜË®≠ÂÆö</li>
                        <li>‰ΩøÁî®Âø´ÈÄüÊ®°ÊùøÊàñËá™Ë®ÇÊèêÁ§∫Ë©û</li>
                        <li>ÈªûÊìä„ÄåÁîüÊàêÊèêÁ§∫Ë©û„ÄçÊúÉËá™ÂãïÊï¥ÂêàÊâÄÈÅ∏Á¥†Êùê</li>
                        <li>ÂèØ‰ª•Áõ¥Êé•ÁôºÈÄÅÂà∞PerplexityÈÄ≤Ë°åÂâµ‰Ωú</li>
                    </ul>
                </div>
            `;
        }

        // ÊáâÁî®Ê®°Êùø
        function applyTemplate(template) {
            const promptArea = document.getElementById('aiPrompt');
            switch(template) {
                case 'story':
                    promptArea.value = 'Ë´ãÊ†πÊìö‰ª•‰∏ãËßíËâ≤ÂíåËÉåÊôØË®≠ÂÆöÔºåÂâµ‰Ωú‰∏ÄÂÄãÂÆåÊï¥ÁöÑÁü≠ÁØáÊïÖ‰∫ãÔºàÁ¥Ñ2000Â≠óÔºâÔºö\n\n[ËßíËâ≤Ë≥áË®ä]\n\n[ËÉåÊôØË®≠ÂÆö]\n\nÊïÖ‰∫ãË¶ÅÊ±ÇÔºö\n- Ë¶ÅÊúâÊòéÁ¢∫ÁöÑÈñãÁ´Ø„ÄÅÁôºÂ±ï„ÄÅÈ´òÊΩÆÂíåÁµêÂ∞æ\n- Â±ïÁèæËßíËâ≤ÁöÑÊÄßÊ†ºÁâπÂæµ\n- ËûçÂÖ•‰∏ñÁïåËßÄË®≠ÂÆö\n- ÊÉÖÁØÄÁ∑äÊπäÔºåÂºï‰∫∫ÂÖ•Âãù';
                    break;
                case 'dialogue':
                    promptArea.value = 'Ë´ãÁÇ∫‰ª•‰∏ãËßíËâ≤Ââµ‰Ωú‰∏ÄÊÆµÂ∞çË©±Â†¥ÊôØÔºö\n\n[ËßíËâ≤Ë≥áË®ä]\n\nÂ†¥ÊôØÔºö[ÊèèËø∞Â∞çË©±ÁôºÁîüÁöÑÂú∞ÈªûÂíåÊÉÖÂ¢É]\n\nË¶ÅÊ±ÇÔºö\n- Â∞çË©±Ë¶ÅÁ¨¶ÂêàÂêÑËßíËâ≤ÁöÑÊÄßÊ†º\n- Â±ïÁèæËßíËâ≤‰πãÈñìÁöÑÈóú‰øÇ\n- Êé®ÈÄ≤ÂäáÊÉÖÁôºÂ±ï\n- Á¥Ñ500-800Â≠ó';
                    break;
                case 'scene':
                    promptArea.value = 'Ë´ãË©≥Á¥∞ÊèèËø∞‰ª•‰∏ãÂ†¥ÊôØÔºö\n\n[ËÉåÊôØË®≠ÂÆö]\n\nÊèèËø∞Ë¶ÅÊ±ÇÔºö\n- ÂåÖÂê´Ë¶ñË¶∫„ÄÅËÅΩË¶∫„ÄÅÂóÖË¶∫Á≠âÊÑüÂÆòÁ¥∞ÁØÄ\n- ÁáüÈÄ†Áç®ÁâπÁöÑÊ∞õÂúç\n- Â±ïÁèæÂ†¥ÊôØÁöÑÁâπËâ≤\n- Á¥Ñ300-500Â≠ó';
                    break;
                case 'dnd':
                    promptArea.value = 'Ë´ãÁÇ∫‰ª•‰∏ãËßíËâ≤ÂâµÂª∫DNDËßíËâ≤Âç°Ôºö\n\n[ËßíËâ≤Ë≥áË®ä]\n\nÂåÖÂê´ÂÖßÂÆπÔºö\n- Âü∫Êú¨Â±¨ÊÄßÔºàÂäõÈáè„ÄÅÊïèÊç∑„ÄÅÈ´îË≥™„ÄÅÊô∫Âäõ„ÄÅÊÑüÁü•„ÄÅÈ≠ÖÂäõÔºâ\n- ËÅ∑Ê•≠ÂíåÁ≠âÁ¥ö\n- ÊäÄËÉΩÂ∞àÈï∑\n- Ë£ùÂÇôÊ∏ÖÂñÆ\n- ËÉåÊôØÊïÖ‰∫ã\n- ÊÄßÊ†ºÁâπÂæµÂíåÁº∫Èô∑\n- ÁêÜÊÉ≥„ÄÅÁæàÁµÜÂíåÂº±Èªû';
                    break;
                case 'plot':
                    promptArea.value = 'Ë´ãÂàÜÊûê‰ª•‰∏ãÊïÖ‰∫ãË®≠ÂÆöÔºå‰∏¶Êèê‰æõÂäáÊÉÖÁôºÂ±ïÂª∫Ë≠∞Ôºö\n\n[ËßíËâ≤ÂíåËÉåÊôØË≥áË®ä]\n\nÂàÜÊûêÂÖßÂÆπÔºö\n- ÊΩõÂú®ÁöÑË°ùÁ™ÅÈªû\n- ËßíËâ≤ÁôºÂ±ïÂºßÁ∑ö\n- ÂèØËÉΩÁöÑÂäáÊÉÖËΩâÊäò\n- ‰∏ªÈ°åÊé¢Ë®éÂª∫Ë≠∞\n- ÁµêÂ±ÄËµ∞ÂêëÈÅ∏È†Ö';
                    break;
            }
        }

        // ÁîüÊàêÊèêÁ§∫Ë©û
        function generatePrompt() {
            const selectedChars = [];
            const selectedBgs = [];
            const selectedSecrets = [];

            // Êî∂ÈõÜÈÅ∏‰∏≠ÁöÑÁ¥†Êùê
            document.querySelectorAll('input[id^="ai-char-"]:checked').forEach(input => {
                const char = data.characters.find(c => c.id === input.value);
                if (char) selectedChars.push(char);
            });

            document.querySelectorAll('input[id^="ai-bg-"]:checked').forEach(input => {
                const bg = data.backgrounds.find(b => b.id === input.value);
                if (bg) selectedBgs.push(bg);
            });

            document.querySelectorAll('input[id^="ai-secret-"]:checked').forEach(input => {
                const secret = data.secrets.find(s => s.id === input.value);
                if (secret) selectedSecrets.push(secret);
            });

            // ÊßãÂª∫ÊèêÁ§∫Ë©û
            let prompt = document.getElementById('aiPrompt').value || 'Ë´ãÂü∫Êñº‰ª•‰∏ãË®≠ÂÆöÂâµ‰Ωú‰∏ÄÂÄãÊïÖ‰∫ãÔºö\n\n';

            if (selectedChars.length > 0) {
                prompt += '\n„ÄêËßíËâ≤Ë®≠ÂÆö„Äë\n';
                selectedChars.forEach(char => {
                    prompt += `\nËßíËâ≤ÂêçÔºö${char.name}\n`;
                    if (char.age) prompt += `Âπ¥ÈΩ°Ôºö${char.age}\n`;
                    if (char.race) prompt += `Á®ÆÊóèÔºö${char.race}\n`;
                    if (char.appearance.hair || char.appearance.eyes) {
                        prompt += `Â§ñË≤åÔºö${char.appearance.hair ? 'È´ÆËâ≤-' + char.appearance.hair : ''} ${char.appearance.eyes ? 'ÁúºËâ≤-' + char.appearance.eyes : ''}\n`;
                    }
                    if (char.description) prompt += `Â§ñË≤åÊèèËø∞Ôºö${char.description}\n`;
                    if (char.personality) prompt += `ÊÄßÊ†ºÔºö${char.personality}\n`;
                    if (char.background) prompt += `ËÉåÊôØÔºö${char.background}\n`;
                    if (char.notes) prompt += `ÂÇôË®ªÔºö${char.notes}\n`;
                });
            }

            if (selectedBgs.length > 0) {
                prompt += '\n„ÄêËÉåÊôØË®≠ÂÆö„Äë\n';
                selectedBgs.forEach(bg => {
                    prompt += `\nÂ†¥ÊôØÔºö${bg.name}Ôºà${bg.type}Ôºâ\n`;
                    if (bg.description) prompt += `ÊèèËø∞Ôºö${bg.description}\n`;
                    if (bg.rules) prompt += `Ë¶èÂâá/Ê≥ïÂâáÔºö${bg.rules}\n`;
                    if (bg.notes) prompt += `ÂÇôË®ªÔºö${bg.notes}\n`;
                });
            }

            if (selectedSecrets.length > 0) {
                prompt += '\n„ÄêÁßòÂØÜË®≠ÂÆö„Äë\n';
                selectedSecrets.forEach(secret => {
                    prompt += `\n${secret.title}Ôºà${secret.category}Ôºâ\n`;
                    if (secret.content) prompt += `ÂÖßÂÆπÔºö${secret.content}\n`;
                    if (secret.impact) prompt += `ÂΩ±ÈüøÔºö${secret.impact}\n`;
                    if (secret.knownBy && secret.knownBy.length > 0) {
                        prompt += `Áü•ÊÉÖËÄÖÔºö${secret.knownBy.join('„ÄÅ')}\n`;
                    }
                });
            }

            document.getElementById('aiPrompt').value = prompt;
        }

        // Ë§áË£ΩÊèêÁ§∫Ë©û
        function copyPrompt() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) {
                alert('Ë´ãÂÖàËº∏ÂÖ•ÊàñÁîüÊàêÊèêÁ§∫Ë©ûÔºÅ');
                return;
            }

            navigator.clipboard.writeText(prompt).then(() => {
                alert('ÊèêÁ§∫Ë©ûÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ');
            }).catch(err => {
                alert('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïÈÅ∏ÊìáË§áË£Ω');
            });
        }

        // ÁôºÈÄÅÂà∞Perplexity
        function sendToPerplexity() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) {
                alert('Ë´ãÂÖàËº∏ÂÖ•ÊàñÁîüÊàêÊèêÁ§∫Ë©ûÔºÅ');
                return;
            }

            // Á∑®Á¢ºÊèêÁ§∫Ë©û
            const encodedPrompt = encodeURIComponent(prompt);
            
            // ÈñãÂïüPerplexityÔºàÊ≥®ÊÑèÔºöÂØ¶ÈöõURLÂèØËÉΩÈúÄË¶ÅË™øÊï¥Ôºâ
            window.open(`https://www.perplexity.ai/?q=${encodedPrompt}`, '_blank');
        }

        // Ë®≠ÂÆöÈ†ÅÈù¢
        function showSettings() {
            document.getElementById('pageContent').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">‚öôÔ∏è Á≥ªÁµ±Ë®≠ÂÆö</h1>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem;">üîí ÂÆâÂÖ®Ë®≠ÂÆö</h2>
                    <div class="form-group">
                        <label class="form-label">‰øÆÊîπÂØÜÁ¢º</label>
                        <input type="password" class="form-input" id="newPassword" placeholder="Ëº∏ÂÖ•Êñ∞ÂØÜÁ¢º">
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">Êõ¥Êñ∞ÂØÜÁ¢º</button>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem;">‚òÅÔ∏è ÂÇô‰ªΩËàáÈÇÑÂéü</h2>
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                        <button class="btn btn-secondary" onclick="exportData()">
                            <span>üì•</span> ÂåØÂá∫Ë≥áÊñô
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                            <span>üì§</span> ÂåØÂÖ•Ë≥áÊñô
                        </button>
                        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(this)">
                    </div>

                    <div class="alert alert-warning">
                        ‚ö†Ô∏è Google Drive Êï¥ÂêàÂäüËÉΩÂç≥Â∞áÊé®Âá∫ÔºÅ
                    </div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 1.5rem;">üìä Ë≥áÊñôÁµ±Ë®à</h2>
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Á∏ΩË≥áÊñôÂ§ßÂ∞è</span>
                            <span>${(JSON.stringify(data).length / 1024).toFixed(2)} KB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Âª∫Á´ãÊôÇÈñì</span>
                            <span>${new Date(Math.min(...getAllItems().map(item => item.createdAt))).toLocaleDateString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ÊúÄÂæåÊõ¥Êñ∞</span>
                            <span>${new Date(Math.max(...getAllItems().map(item => item.updatedAt))).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>

                <div class="card" style="border-color: rgba(239, 68, 68, 0.5);">
                    <h2 style="margin-bottom: 1.5rem; color: var(--danger);">‚ö†Ô∏è Âç±Èö™ÂçÄÂüü</h2>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºåË´ãË¨πÊÖéÊìç‰ΩúÔºÅ</p>
                    <button class="btn btn-danger" onclick="if(confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) clearAllData()">
                        Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô
                    </button>
                </div>
            `;
        }

        // ËºîÂä©ÂáΩÊï∏
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function calculateTotalWords() {
            let total = 0;
            data.characters.forEach(char => {
                total += (char.description || '').length;
                total += (char.personality || '').length;
                total += (char.background || '').length;
                total += (char.notes || '').length;
            });
            data.backgrounds.forEach(bg => {
                total += (bg.description || '').length;
                total += (bg.rules || '').length;
                total += (bg.notes || '').length;
            });
            data.secrets.forEach(secret => {
                total += (secret.content || '').length;
                total += (secret.impact || '').length;
            });
            data.novels.forEach(novel => {
                total += (novel.content || '').length;
            });
            return total;
        }

        function getAllItems() {
            return [
                ...data.characters,
                ...data.backgrounds,
                ...data.secrets,
                ...data.novels
            ];
        }

        function getRecentItems() {
            const allItems = [
                ...data.characters.map(item => ({...item, type: 'ËßíËâ≤', icon: 'üë§'})),
                ...data.backgrounds.map(item => ({...item, type: 'ËÉåÊôØ', icon: 'üåç', title: item.name})),
                ...data.secrets.map(item => ({...item, type: 'ÁßòÂØÜ', icon: 'üîê'})),
                ...data.novels.map(item => ({...item, type: 'Â∞èË™™', icon: 'üìñ'}))
            ];
            
            return allItems
                .sort((a, b) => b.updatedAt - a.updatedAt)
                .slice(0, 5)
                .map(item => ({
                    ...item,
                    title: item.title || item.name
                }));
        }

        // Âà™Èô§È†ÖÁõÆ
        function deleteItem(type, id) {
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÈ†ÖÁõÆÂóéÔºü')) return;
            
            const index = data[type].findIndex(item => item.id === id);
            if (index > -1) {
                data[type].splice(index, 1);
                saveData();
                
                // ÈáçÊñ∞ËºâÂÖ•Áï∂ÂâçÈ†ÅÈù¢
                switch(type) {
                    case 'characters': showCharacters(); break;
                    case 'backgrounds': showBackgrounds(); break;
                    case 'secrets': showSecrets(); break;
                    case 'novels': showNovels(); break;
                }
            }
        }

        // ÊêúÂ∞ãÂäüËÉΩ
        function searchCharacters(query) {
            const filtered = data.characters.filter(char => 
                char.name.toLowerCase().includes(query.toLowerCase()) ||
                (char.description || '').toLowerCase().includes(query.toLowerCase())
            );
            document.getElementById('charactersList').innerHTML = renderCharacters(filtered);
        }

        function searchBackgrounds(query) {
            const filtered = data.backgrounds.filter(bg => 
                bg.name.toLowerCase().includes(query.toLowerCase()) ||
                (bg.description || '').toLowerCase().includes(query.toLowerCase())
            );
            document.getElementById('backgroundsList').innerHTML = renderBackgrounds(filtered);
        }

        function searchSecrets(query) {
            const filtered = data.secrets.filter(secret => 
                secret.title.toLowerCase().includes(query.toLowerCase()) ||
                (secret.content || '').toLowerCase().includes(query.toLowerCase())
            );
            document.getElementById('secretsList').innerHTML = renderSecrets(filtered);
        }

        function searchNovels(query) {
            const filtered = data.novels.filter(novel => 
                novel.title.toLowerCase().includes(query.toLowerCase()) ||
                (novel.content || '').toLowerCase().includes(query.toLowerCase())
            );
            document.getElementById('novelsList').innerHTML = renderNovels(filtered);
        }

        // ÁØ©ÈÅ∏ÂäüËÉΩ
        function filterByTag(tag, type) {
            if (type === 'characters') {
                const filtered = tag ? data.characters.filter(char => char.tags.includes(tag)) : data.characters;
                document.getElementById('charactersList').innerHTML = renderCharacters(filtered);
            }
        }

        function filterByType(type, dataType) {
            if (dataType === 'backgrounds') {
                const filtered = type ? data.backgrounds.filter(bg => bg.type === type) : data.backgrounds;
                document.getElementById('backgroundsList').innerHTML = renderBackgrounds(filtered);
            }
        }

        function filterByCategory(category, type) {
            if (type === 'secrets') {
                const filtered = category ? data.secrets.filter(secret => secret.category === category) : data.secrets;
                document.getElementById('secretsList').innerHTML = renderSecrets(filtered);
            }
        }

        // Ë®≠ÂÆöÂäüËÉΩ
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword) {
                alert('Ë´ãËº∏ÂÖ•Êñ∞ÂØÜÁ¢ºÔºÅ');
                return;
            }
            
            data.settings.password = newPassword;
            saveData();
            alert('ÂØÜÁ¢ºÂ∑≤Êõ¥Êñ∞ÔºÅ');
            document.getElementById('newPassword').value = '';
        }

        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `novel-materials-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm('Á¢∫ÂÆöË¶ÅÂåØÂÖ•Ë≥áÊñôÂóéÔºüÈÄôÂ∞áË¶ÜËìãÁèæÊúâË≥áÊñôÔºÅ')) {
                        data = importedData;
                        saveData();
                        location.reload();
                    }
                } catch (error) {
                    alert('ÂåØÂÖ•Â§±ÊïóÔºÅË´ãÁ¢∫Ë™çÊ™îÊ°àÊ†ºÂºèÊ≠£Á¢∫„ÄÇ');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            data = {
                characters: [],
                backgrounds: [],
                secrets: [],
                novels: [],
                settings: {
                    password: 'admin',
                    autoBackup: true,
                    googleDriveToken: null
                }
            };
            saveData();
            location.reload();
        }

        // Âø´ÈÄüÂàÜÈ°ûÂäüËÉΩ
        function quickClassify(type) {
            const content = document.getElementById('quickContent').value;
            if (!content) {
                alert('Ë´ãÂÖàËº∏ÂÖ•ÂÖßÂÆπÔºÅ');
                return;
            }

            switch(type) {
                case 'character':
                    const charId = generateId();
                    data.characters.push({
                        id: charId,
                        name: 'Êú™ÂëΩÂêçËßíËâ≤',
                        age: '',
                        appearance: { hair: '', eyes: '' },
                        race: '',
                        description: content,
                        personality: '',
                        background: '',
                        notes: '',
                        tags: [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                    saveData();
                    editCharacter(charId);
                    break;
                    
                case 'background':
                    const bgId = generateId();
                    data.backgrounds.push({
                        id: bgId,
                        name: 'Êú™ÂëΩÂêçÂ†¥ÊôØ',
                        type: 'Âú∞Èªû',
                        description: content,
                        rules: '',
                        notes: '',
                        tags: [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                    saveData();
                    editBackground(bgId);
                    break;
                    
                case 'novel':
                    const novelId = generateId();
                    data.novels.push({
                        id: novelId,
                        title: 'Êú™ÂëΩÂêçÂ∞èË™™',
                        prompt: '',
                        content: content,
                        notes: '',
                        relatedMaterials: [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                    saveData();
                    editNovel(novelId);
                    break;
            }
        }

        // Êô∫ËÉΩÂàÜÈ°ûÂª∫Ë≠∞
        function suggestClassification(content) {
            const suggestion = document.getElementById('aiSuggestion');
            const suggestionText = document.getElementById('suggestionText');
            
            // Á∞°ÂñÆÁöÑÈóúÈçµË©ûÂàÜÊûê
            const lowerContent = content.toLowerCase();
            let type = '';
            let confidence = '';
            
            if (lowerContent.includes('‰ªñ') || lowerContent.includes('Â•π') || lowerContent.includes('ÂêçÂ≠ó') || 
                lowerContent.includes('Ê≠≤') || lowerContent.includes('ÊÄßÊ†º') || lowerContent.includes('Â§ñË≤å')) {
                type = 'ËßíËâ≤ÊèèËø∞';
                confidence = 'È´ò';
            } else if (lowerContent.includes('Âú∞Êñπ') || lowerContent.includes('ÂüéÂ∏Ç') || lowerContent.includes('‰∏ñÁïå') ||
                       lowerContent.includes('Ë¶èÂâá') || lowerContent.includes('Áí∞Â¢É') || lowerContent.includes('Â†¥ÊôØ')) {
                type = 'Â†¥ÊôØÊèèËø∞';
                confidence = 'È´ò';
            } else if (lowerContent.includes('ÊïÖ‰∫ã') || lowerContent.includes('ÂäáÊÉÖ') || content.length > 500) {
                type = 'Â∞èË™™ÂÖßÂÆπ';
                confidence = '‰∏≠';
            } else {
                type = 'Êú™Áü•È°ûÂûã';
                confidence = '‰Ωé';
            }
            
            suggestion.style.display = 'flex';
            suggestionText.textContent = `${type} (‰ø°ÂøÉÂ∫¶: ${confidence})`;
        }

        // Ëá™ÂãïÂàÜÈ°û
        function autoClassify() {
            const content = document.getElementById('quickContent').value;
            if (!content) {
                alert('Ë´ãÂÖàËº∏ÂÖ•ÂÖßÂÆπÔºÅ');
                return;
            }
            
            const lowerContent = content.toLowerCase();
            
            if (lowerContent.includes('‰ªñ') || lowerContent.includes('Â•π') || lowerContent.includes('ÂêçÂ≠ó') || 
                lowerContent.includes('Ê≠≤') || lowerContent.includes('ÊÄßÊ†º')) {
                quickClassify('character');
            } else if (lowerContent.includes('Âú∞Êñπ') || lowerContent.includes('ÂüéÂ∏Ç') || lowerContent.includes('‰∏ñÁïå') ||
                       lowerContent.includes('Ë¶èÂâá') || lowerContent.includes('Áí∞Â¢É')) {
                quickClassify('background');
            } else {
                quickClassify('novel');
            }
        }

        // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâ‰∏ãÊãâÈÅ∏ÂñÆ
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select')) {
                const dropdowns = document.querySelectorAll('.multi-select-dropdown');
                dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
            }
        });

        // Èò≤Ê≠¢Ë°®ÂñÆÊèê‰∫§Âà∑Êñ∞È†ÅÈù¢
        document.addEventListener('submit', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
