<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èªªç´ æåº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .main-app {
            display: none;
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #4a5568;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.3s;
            font-weight: 600;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f7fafc;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .items-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .item-content {
            color: #4a5568;
            line-height: 1.6;
        }

        .item-meta {
            font-size: 12px;
            color: #718096;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #718096;
        }

        .close:hover {
            color: #e53e3e;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        .secret-warning {
            background: #fed7e2;
            color: #97266d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>ğŸ”’ å°èªªç´ æåº«</h1>
            <div class="input-group">
                <label for="password">è«‹è¼¸å…¥å¯†ç¢¼ï¼š</label>
                <input type="password" id="password" placeholder="å¯†ç¢¼">
            </div>
            <button class="btn" onclick="login()" style="width: 100%;">ç™»å…¥</button>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <div class="header">
                <h1>ğŸ“š å°èªªç´ æåº«</h1>
                <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('characters')">è§’è‰²è¨­å®š</div>
                <div class="nav-tab" onclick="switchTab('backgrounds')">æ•…äº‹èƒŒæ™¯</div>
                <div class="nav-tab" onclick="switchTab('secrets')">ç§˜å¯†è¨­å®š</div>
                <div class="nav-tab" onclick="switchTab('novels')">AIå°èªª</div>
            </div>

            <!-- è§’è‰²è¨­å®š -->
            <div id="characters" class="content-section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ‘¤ è§’è‰²è¨­å®š</h2>
                    <button class="btn" onclick="openModal('characterModal')">æ–°å¢è§’è‰²</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="characterSearch" placeholder="æœå°‹è§’è‰²..." onkeyup="searchItems('characters')">
                </div>
                <div id="charactersList" class="items-grid"></div>
            </div>

            <!-- æ•…äº‹èƒŒæ™¯ -->
            <div id="backgrounds" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸŒ æ•…äº‹èƒŒæ™¯</h2>
                    <button class="btn" onclick="openModal('backgroundModal')">æ–°å¢èƒŒæ™¯</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="backgroundSearch" placeholder="æœå°‹èƒŒæ™¯..." onkeyup="searchItems('backgrounds')">
                </div>
                <div id="backgroundsList" class="items-grid"></div>
            </div>

            <!-- ç§˜å¯†è¨­å®š -->
            <div id="secrets" class="content-section">
                <div class="secret-warning">
                    âš ï¸ æ³¨æ„ï¼šæ­¤å€åŸŸåŒ…å«åŠ‡é€å’Œæ•æ„Ÿè¨­å®šï¼Œè«‹è¬¹æ…åˆ†äº«
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ” ç§˜å¯†è¨­å®š</h2>
                    <button class="btn" onclick="openModal('secretModal')">æ–°å¢ç§˜å¯†</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="secretSearch" placeholder="æœå°‹ç§˜å¯†è¨­å®š..." onkeyup="searchItems('secrets')">
                </div>
                <div id="secretsList" class="items-grid"></div>
            </div>

            <!-- AIå°èªª -->
            <div id="novels" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ“– AIå°èªª</h2>
                    <button class="btn" onclick="openModal('novelModal')">æ–°å¢å°èªª</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="novelSearch" placeholder="æœå°‹å°èªª..." onkeyup="searchItems('novels')">
                </div>
                <div id="novelsList" class="items-grid"></div>

                <div class="export-section">
                    <h3>ğŸ“¤ åŒ¯å‡ºåŠŸèƒ½</h3>
                    <p>å°‡æ‰€æœ‰è³‡æ–™åŒ¯å‡ºçµ¦AIä½¿ç”¨ï¼š</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="exportForAI()">åŒ¯å‡ºçµ¦AI</button>
                        <button class="btn btn-secondary" onclick="exportAll()">åŒ¯å‡ºæ‰€æœ‰è³‡æ–™</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹è¦–çª— -->
    <!-- è§’è‰²æ¨¡æ…‹ -->
    <div id="characterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="characterModalTitle">æ–°å¢è§’è‰²</h3>
                <span class="close" onclick="closeModal('characterModal')">&times;</span>
            </div>
            <form id="characterForm">
                <div class="input-group">
                    <label for="characterName">è§’è‰²åç¨±ï¼š</label>
                    <input type="text" id="characterName" required>
                </div>
                <div class="input-group">
                    <label for="characterAge">å¹´é½¡ï¼š</label>
                    <input type="text" id="characterAge">
                </div>
                <div class="input-group">
                    <label for="characterAppearance">å¤–è²Œæè¿°ï¼š</label>
                    <textarea id="characterAppearance"></textarea>
                </div>
                <div class="input-group">
                    <label for="characterPersonality">æ€§æ ¼ç‰¹è³ªï¼š</label>
                    <textarea id="characterPersonality"></textarea>
                </div>
                <div class="input-group">
                    <label for="characterBackground">èƒŒæ™¯æ•…äº‹ï¼š</label>
                    <textarea id="characterBackground"></textarea>
                </div>
                <div class="input-group">
                    <label for="characterNotes">é¡å¤–å‚™è¨»ï¼š</label>
                    <textarea id="characterNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('characterModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- èƒŒæ™¯æ¨¡æ…‹ -->
    <div id="backgroundModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="backgroundModalTitle">æ–°å¢æ•…äº‹èƒŒæ™¯</h3>
                <span class="close" onclick="closeModal('backgroundModal')">&times;</span>
            </div>
            <form id="backgroundForm">
                <div class="input-group">
                    <label for="backgroundName">å ´æ™¯åç¨±ï¼š</label>
                    <input type="text" id="backgroundName" required>
                </div>
                <div class="input-group">
                    <label for="backgroundType">é¡å‹ï¼š</label>
                    <select id="backgroundType">
                        <option value="åœ°é»">åœ°é»</option>
                        <option value="æ™‚ä»£">æ™‚ä»£</option>
                        <option value="ä¸–ç•Œè§€">ä¸–ç•Œè§€</option>
                        <option value="æ–‡åŒ–">æ–‡åŒ–</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="backgroundDescription">è©³ç´°æè¿°ï¼š</label>
                    <textarea id="backgroundDescription"></textarea>
                </div>
                <div class="input-group">
                    <label for="backgroundRules">è¦å‰‡/æ³•å‰‡ï¼š</label>
                    <textarea id="backgroundRules"></textarea>
                </div>
                <div class="input-group">
                    <label for="backgroundNotes">å‚™è¨»ï¼š</label>
                    <textarea id="backgroundNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('backgroundModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç§˜å¯†è¨­å®šæ¨¡æ…‹ -->
    <div id="secretModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="secretModalTitle">æ–°å¢ç§˜å¯†è¨­å®š</h3>
                <span class="close" onclick="closeModal('secretModal')">&times;</span>
            </div>
            <form id="secretForm">
                <div class="input-group">
                    <label for="secretTitle">æ¨™é¡Œï¼š</label>
                    <input type="text" id="secretTitle" required>
                </div>
                <div class="input-group">
                    <label for="secretCategory">é¡åˆ¥ï¼š</label>
                    <select id="secretCategory">
                        <option value="åŠ‡æƒ…è½‰æŠ˜">åŠ‡æƒ…è½‰æŠ˜</option>
                        <option value="è§’è‰²ç§˜å¯†">è§’è‰²ç§˜å¯†</option>
                        <option value="ä¸–ç•Œè¨­å®š">ä¸–ç•Œè¨­å®š</option>
                        <option value="ä¼ç­†">ä¼ç­†</option>
                        <option value="çµå±€">çµå±€</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="secretContent">å…§å®¹ï¼š</label>
                    <textarea id="secretContent"></textarea>
                </div>
                <div class="input-group">
                    <label for="secretImpact">å½±éŸ¿/é‡è¦æ€§ï¼š</label>
                    <textarea id="secretImpact"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('secretModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å°èªªæ¨¡æ…‹ -->
    <div id="novelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="novelModalTitle">æ–°å¢å°èªª</h3>
                <span class="close" onclick="closeModal('novelModal')">&times;</span>
            </div>
            <form id="novelForm">
                <div class="input-group">
                    <label for="novelTitle">æ¨™é¡Œï¼š</label>
                    <input type="text" id="novelTitle" required>
                </div>
                <div class="input-group">
                    <label for="novelPrompt">ä½¿ç”¨çš„æç¤ºè©ï¼š</label>
                    <textarea id="novelPrompt"></textarea>
                </div>
                <div class="input-group">
                    <label for="novelContent">å°èªªå…§å®¹ï¼š</label>
                    <textarea id="novelContent" style="min-height: 200px;"></textarea>
                </div>
                <div class="input-group">
                    <label for="novelNotes">å‚™è¨»/è©•åƒ¹ï¼š</label>
                    <textarea id="novelNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('novelModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // è³‡æ–™å„²å­˜
        let data = {
            characters: [],
            backgrounds: [],
            secrets: [],
            novels: []
        };

        let editingId = null;
        let currentEditType = null;

        // é è¨­å¯†ç¢¼ï¼ˆä½ å¯ä»¥ä¿®æ”¹ï¼‰
        const PASSWORD = "mynovel123";

        // åˆå§‹åŒ–
        function init() {
            loadData();
            renderAll();
        }

        // ç™»å…¥åŠŸèƒ½
        function login() {
            const password = document.getElementById('password').value;
            if (password === PASSWORD) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                init();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        function logout() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('password').value = '';
        }

        // è³‡æ–™è¼‰å…¥å’Œå„²å­˜
        function loadData() {
            try {
                const saved = localStorage.getItem('novelMaterials');
                if (saved) {
                    data = JSON.parse(saved);
                }
            } catch (e) {
                console.log('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨é è¨­è³‡æ–™');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('novelMaterials', JSON.stringify(data));
            } catch (e) {
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
            }
        }

        // åˆ†é åˆ‡æ›
        function switchTab(tab) {
            // ç§»é™¤æ‰€æœ‰active class
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            
            // æ·»åŠ active class
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        // æ¨¡æ…‹è¦–çª—
        function openModal(modalId, editId = null) {
            editingId = editId;
            currentEditType = modalId.replace('Modal', '').slice(0, -1); // ç§»é™¤Modalå’Œè¤‡æ•¸s
            
            document.getElementById(modalId).style.display = 'block';
            
            if (editId) {
                fillEditForm(modalId, editId);
            } else {
                clearForm(modalId);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            editingId = null;
            currentEditType = null;
        }

        function clearForm(modalId) {
            const form = document.querySelector(`#${modalId} form`);
            form.reset();
            
            // æ›´æ–°æ¨™é¡Œ
            const titleMap = {
                'characterModal': 'æ–°å¢è§’è‰²',
                'backgroundModal': 'æ–°å¢æ•…äº‹èƒŒæ™¯',
                'secretModal': 'æ–°å¢ç§˜å¯†è¨­å®š',
                'novelModal': 'æ–°å¢å°èªª'
            };
            document.querySelector(`#${modalId} h3`).textContent = titleMap[modalId];
        }

        function fillEditForm(modalId, editId) {
            const type = modalId.replace('Modal', '').slice(0, -1);
            const item = data[type + 's'].find(i => i.id === editId);
            
            if (!item) return;
            
            // æ›´æ–°æ¨™é¡Œ
            const titleMap = {
                'characterModal': 'ç·¨è¼¯è§’è‰²',
                'backgroundModal': 'ç·¨è¼¯æ•…äº‹èƒŒæ™¯',
                'secretModal': 'ç·¨è¼¯ç§˜å¯†è¨­å®š',
                'novelModal': 'ç·¨è¼¯å°èªª'
            };
            document.querySelector(`#${modalId} h3`).textContent = titleMap[modalId];
            
            // å¡«å…¥è³‡æ–™
            switch(type) {
                case 'character':
                    document.getElementById('characterName').value = item.name || '';
                    document.getElementById('characterAge').value = item.age || '';
                    document.getElementById('characterAppearance').value = item.appearance || '';
                    document.getElementById('characterPersonality').value = item.personality || '';
                    document.getElementById('characterBackground').value = item.background || '';
                    document.getElementById('characterNotes').value = item.notes || '';
                    break;
                case 'background':
                    document.getElementById('backgroundName').value = item.name || '';
                    document.getElementById('backgroundType').value = item.type || '';
                    document.getElementById('backgroundDescription').value = item.description || '';
                    document.getElementById('backgroundRules').value = item.rules || '';
                    document.getElementById('backgroundNotes').value = item.notes || '';
                    break;
                case 'secret':
                    document.getElementById('secretTitle').value = item.title || '';
                    document.getElementById('secretCategory').value = item.category || '';
                    document.getElementById('secretContent').value = item.content || '';
                    document.getElementById('secretImpact').value = item.impact || '';
                    break;
                case 'novel':
                    document.getElementById('novelTitle').value = item.title || '';
                    document.getElementById('novelPrompt').value = item.prompt || '';
                    document.getElementById('novelContent').value = item.content || '';
                    document.getElementById('novelNotes').value = item.notes || '';
                    break;
            }
        }

        // è¡¨å–®æäº¤
        document.getElementById('characterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveCharacter();
        });

        document.getElementById('backgroundForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveBackground();
        });

        document.getElementById('secretForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSecret();
        });

        document.getElementById('novelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveNovel();
        });

        function saveCharacter() {
            const character = {
                id: editingId || Date.now(),
                name: document.getElementById('characterName').value,
                age: document.getElementById('characterAge').value,
                appearance: document.getElementById('characterAppearance').value,
                personality: document.getElementById('characterPersonality').value,
                background: document.getElementById('characterBackground').value,
                notes: document.getElementById('characterNotes').value,
                createdAt: editingId ? data.characters.find(c => c.id === editingId).createdAt : new Date().toLocaleString(),
                updatedAt: new Date().toLocaleString()
            };

            if (editingId) {
                const index = data.characters.findIndex(c => c.id === editingId);
                data.characters[index] = character;
            } else {
                data.characters.push(character);
            }

            saveData();
            renderCharacters();
            closeModal('characterModal');
        }

        function saveBackground() {
            const background = {
                id: editingId || Date.now(),
                name: document.getElementById('backgroundName').value,
                type: document.getElementById('backgroundType').value,
                description: document.getElementById('backgroundDescription').value,
                rules: document.getElementById('backgroundRules').value,
                notes: document.getElementById('backgroundNotes').value,
                createdAt: editingId ? data.backgrounds.find(b => b.id === editingId).createdAt : new Date().toLocaleString(),
                updatedAt: new Date().toLocaleString()
            };

            if (editingId) {
                const index = data.backgrounds.findIndex(b => b.id === editingId);
                data.backgrounds[index] = background;
            } else {
                data.backgrounds.push(background);
            }

            saveData();
            renderBackgrounds();
            closeModal('backgroundModal');
        }

        function saveSecret() {
            const secret = {
                id: editingId || Date.now(),
                title: document.getElementById('secretTitle').value,
                category: document.getElementById('secretCategory').value,
                content: document.getElementById('secretContent').value,
                impact: document.getElementById('secretImpact').value,
                createdAt: editingId ? data.secrets.find(s => s.id === editingId).createdAt : new Date().toLocaleString(),
                updatedAt: new Date().toLocaleString()
            };

            if (editingId) {
                const index = data.secrets.findIndex(s => s.id === editingId);
                data.secrets[index] = secret;
            } else {
                data.secrets.push(secret);
            }

            saveData();
            renderSecrets();
            closeModal('secretModal');
        }

        function saveNovel() {
            const novel = {
                id: editingId || Date.now(),
                title: document.getElementById('novelTitle').value,
                prompt: document.getElementById('novelPrompt').value,
                content: document.getElementById('novelContent').value,
                notes: document.getElementById('novelNotes').value,
                createdAt: editingId ? data.novels.find(n => n.id === editingId).createdAt : new Date().toLocaleString(),
                updatedAt: new Date().toLocaleString()
            };

            if (editingId) {
                const index = data.novels.findIndex(n => n.id === editingId);
                data.novels[index] = novel;
            } else {
                data.novels.push(novel);
            }

            saveData();
            renderNovels();
            closeModal('novelModal');
        }

        // åˆªé™¤åŠŸèƒ½
        function deleteItem(type, id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
                const index = data[type].findIndex(item => item.id === id);
                if (index > -1) {
                    data[type].splice(index, 1);
                    saveData();
                    renderAll();
                }
            }
        }

        // æ¸²æŸ“åŠŸèƒ½
        function renderAll() {
            renderCharacters();
            renderBackgrounds();
            renderSecrets();
            renderNovels();
        }

        function renderCharacters() {
            const container = document.getElementById('charactersList');
            container.innerHTML = '';

            data.characters.forEach(character => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">${character.name}</div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="openModal('characterModal', ${character.id})">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('characters', ${character.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="item-content">
                        ${character.age ? `<strong>å¹´é½¡ï¼š</strong>${character.age}<br>` : ''}
                        ${character.appearance ? `<strong>å¤–è²Œï¼š</strong>${character.appearance}<br>` : ''}
                        ${character.personality ? `<strong>æ€§æ ¼ï¼š</strong>${character.personality}<br>` : ''}
                        ${character.background ? `<strong>èƒŒæ™¯ï¼š</strong>${character.background.substring(0, 100)}${character.background.length > 100 ? '...' : ''}<br>` : ''}
                        ${character.notes ? `<strong>å‚™è¨»ï¼š</strong>${character.notes.substring(0, 100)}${character.notes.length > 100 ? '...' : ''}` : ''}
                    </div>
                    <div class="item-meta">
                        å»ºç«‹ï¼š${character.createdAt} | æ›´æ–°ï¼š${character.updatedAt}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderBackgrounds() {
            const container = document.getElementById('backgroundsList');
            container.innerHTML = '';

            data.backgrounds.forEach(background => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">${background.name} <span style="font-size: 14px; color: #718096;">[${background.type}]</span></div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="openModal('backgroundModal', ${background.id})">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('backgrounds', ${background.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="item-content">
                        ${background.description ? `<strong>æè¿°ï¼š</strong>${background.description.substring(0, 150)}${background.description.length > 150 ? '...' : ''}<br>` : ''}
                        ${background.rules ? `<strong>è¦å‰‡ï¼š</strong>${background.rules.substring(0, 100)}${background.rules.length > 100 ? '...' : ''}<br>` : ''}
                        ${background.notes ? `<strong>å‚™è¨»ï¼š</strong>${background.notes.substring(0, 100)}${background.notes.length > 100 ? '...' : ''}` : ''}
                    </div>
                    <div class="item-meta">
                        å»ºç«‹ï¼š${background.createdAt} | æ›´æ–°ï¼š${background.updatedAt}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderSecrets() {
            const container = document.getElementById('secretsList');
            container.innerHTML = '';

            data.secrets.forEach(secret => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">ğŸ” ${secret.title} <span style="font-size: 14px; color: #718096;">[${secret.category}]</span></div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="openModal('secretModal', ${secret.id})">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('secrets', ${secret.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="item-content">
                        ${secret.content ? `<strong>å…§å®¹ï¼š</strong>${secret.content.substring(0, 150)}${secret.content.length > 150 ? '...' : ''}<br>` : ''}
                        ${secret.impact ? `<strong>å½±éŸ¿ï¼š</strong>${secret.impact.substring(0, 100)}${secret.impact.length > 100 ? '...' : ''}` : ''}
                    </div>
                    <div class="item-meta">
                        å»ºç«‹ï¼š${secret.createdAt} | æ›´æ–°ï¼š${secret.updatedAt}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderNovels() {
            const container = document.getElementById('novelsList');
            container.innerHTML = '';

            data.novels.forEach(novel => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">ğŸ“– ${novel.title}</div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="openModal('novelModal', ${novel.id})">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('novels', ${novel.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="item-content">
                        ${novel.prompt ? `<strong>æç¤ºè©ï¼š</strong>${novel.prompt.substring(0, 100)}${novel.prompt.length > 100 ? '...' : ''}<br>` : ''}
                        ${novel.content ? `<strong>å…§å®¹ï¼š</strong>${novel.content.substring(0, 200)}${novel.content.length > 200 ? '...' : ''}<br>` : ''}
                        ${novel.notes ? `<strong>å‚™è¨»ï¼š</strong>${novel.notes.substring(0, 100)}${novel.notes.length > 100 ? '...' : ''}` : ''}
                    </div>
                    <div class="item-meta">
                        å»ºç«‹ï¼š${novel.createdAt} | æ›´æ–°ï¼š${novel.updatedAt}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // æœå°‹åŠŸèƒ½
        function searchItems(type) {
            const searchInput = document.getElementById(type.slice(0, -1) + 'Search');
            const searchTerm = searchInput.value.toLowerCase();
            const cards = document.querySelectorAll(`#${type}List .item-card`);
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function exportForAI() {
            const exportData = {
                è§’è‰²è¨­å®š: data.characters.map(c => ({
                    åç¨±: c.name,
                    å¹´é½¡: c.age,
                    å¤–è²Œ: c.appearance,
                    æ€§æ ¼: c.personality,
                    èƒŒæ™¯: c.background,
                    å‚™è¨»: c.notes
                })),
                æ•…äº‹èƒŒæ™¯: data.backgrounds.map(b => ({
                    åç¨±: b.name,
                    é¡å‹: b.type,
                    æè¿°: b.description,
                    è¦å‰‡: b.rules,
                    å‚™è¨»: b.notes
                }))
            };

            const text = "=== å°èªªç´ æåº« ===\n\n" + JSON.stringify(exportData, null, 2);
            
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼å¯ä»¥ç›´æ¥è²¼çµ¦AIä½¿ç”¨');
            }).catch(() => {
                // å¦‚æœå‰ªè²¼ç°¿APIå¤±æ•—ï¼Œé¡¯ç¤ºåœ¨æ–°è¦–çª—
                const newWindow = window.open();
                newWindow.document.write(`<pre>${text}</pre>`);
            });
        }

        function exportAll() {
            const text = "=== å®Œæ•´å°èªªç´ æåº« ===\n\n" + JSON.stringify(data, null, 2);
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å°èªªç´ æåº«_' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // é—œé–‰æ‰€æœ‰æ¨¡æ…‹è¦–çª—
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // é»æ“Šæ¨¡æ…‹èƒŒæ™¯é—œé–‰
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // åˆå§‹è¼‰å…¥
        window.addEventListener('load', function() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn === 'true') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                init();
            }
        });

        // ä¿®æ”¹ç™»å…¥å‡½æ•¸ä»¥è¨˜ä½ç™»å…¥ç‹€æ…‹
        function login() {
            const password = document.getElementById('password').value;
            if (password === PASSWORD) {
                localStorage.setItem('isLoggedIn', 'true');
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                init();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        // ä¿®æ”¹ç™»å‡ºå‡½æ•¸
        function logout() {
            localStorage.removeItem('isLoggedIn');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('password').value = '';
        }
    </script>
</body>
</html>
