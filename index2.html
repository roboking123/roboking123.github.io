<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>知識與提示詞管理工具</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    /* 自定義滾動條樣式 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase 配置（需要替換為您的配置）
    const firebaseConfig = {
      apiKey: "AIzaSyAy_S7tGi6ht_Ksd8EvjYbr3ILkIRhAU6k",
      authDomain: "knowledge-prompt-manager.firebaseapp.com",
      projectId: "knowledge-prompt-manager",
      storageBucket: "knowledge-prompt-manager.firebasestorage.app",
      messagingSenderId: "234120761290",
      appId: "1:234120761290:web:f4c82b8187827a4f458933",
      measurementId: "G-G1K6BNZNJK"
    };

    // 初始化 Firebase
    let app, auth, db;
    try {
      if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        console.log('Firebase 初始化成功');
      } else {
        console.warn('請設定 Firebase 配置');
      }
    } catch (error) {
      console.error('Firebase 初始化失敗:', error);
    }

    // GitHub API 服務
    class GitHubService {
      constructor() {
        this.baseURL = 'https://api.github.com';
        this.token = null;
      }

      setToken(token) {
        this.token = token;
        localStorage.setItem('github_token', token);
      }

      loadToken() {
        this.token = localStorage.getItem('github_token');
        return this.token;
      }

      clearToken() {
        this.token = null;
        localStorage.removeItem('github_token');
      }

      async request(endpoint, options = {}) {
        if (!this.token) {
          throw new Error('未設定 GitHub token');
        }

        const response = await fetch(`${this.baseURL}${endpoint}`, {
          ...options,
          headers: {
            'Authorization': `token ${this.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || `GitHub API 錯誤: ${response.status}`);
        }

        return response.json();
      }

      async getUser() {
        return this.request('/user');
      }

      async getFile(owner, repo, path) {
        try {
          const response = await this.request(`/repos/${owner}/${repo}/contents/${path}`);
          return {
            exists: true,
            sha: response.sha,
            content: response.content
          };
        } catch (error) {
          if (error.message.includes('404')) {
            return { exists: false };
          }
          throw error;
        }
      }

      async createOrUpdateFile(owner, repo, path, content, message, sha = null) {
        const contentBase64 = btoa(unescape(encodeURIComponent(content)));
        
        const body = {
          message: message,
          content: contentBase64
        };

        if (sha) {
          body.sha = sha;
        }

        return this.request(`/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          body: JSON.stringify(body)
        });
      }

      async readFile(owner, repo, path) {
        const file = await this.getFile(owner, repo, path);
        if (!file.exists) {
          throw new Error('檔案不存在');
        }

        const content = decodeURIComponent(escape(atob(file.content)));
        return JSON.parse(content);
      }
    }

    // 圖標元件
    const Icon = ({ name, size = 20, className = "" }) => {
      const icons = {
        search: "M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z",
        plus: "M12 4.5v15m7.5-7.5h-15",
        edit: "M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10",
        save: "M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4z",
        trash: "M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0",
        copy: "M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184",
        external: "M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14",
        upload: "M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5",
        download: "M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3",
        check: "M4.5 12.75l6 6 9-13.5",
        x: "M6 18L18 6M6 6l12 12",
        logout: "M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75",
        cloud: "M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
      };

      return (
        <svg 
          className={`${className}`} 
          width={size} 
          height={size} 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          strokeWidth="2" 
          strokeLinecap="round" 
          strokeLinejoin="round"
        >
          <path d={icons[name]} />
        </svg>
      );

      // 渲染雲端同步分頁
      const renderSync = () => {
        try {
          return (
            <div className="max-w-2xl mx-auto">
              <div className="bg-white p-6 rounded-lg border border-gray-200">
                <h3 className="text-lg font-semibold mb-4">Firebase 雲端同步</h3>
                
                {/* 同步狀態 */}
                <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-medium">同步狀態</span>
                    <span className={`px-2 py-1 rounded text-sm ${
                      syncStatus === 'synced' ? 'bg-green-100 text-green-800' :
                      syncStatus === 'syncing' ? 'bg-yellow-100 text-yellow-800' :
                      syncStatus === 'error' ? 'bg-red-100 text-red-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {syncStatus === 'synced' ? '已同步' :
                       syncStatus === 'syncing' ? '同步中' :
                       syncStatus === 'error' ? '同步錯誤' :
                       '未連接'}
                    </span>
                  </div>
                  {lastSyncTime && (
                    <p className="text-sm text-gray-600">
                      最後同步：{lastSyncTime.toLocaleString('zh-TW')}
                    </p>
                  )}
                </div>

                {/* 登入狀態 */}
                {!firebaseUser ? (
                  <div className="mb-6">
                    <p className="mb-4 text-gray-600">請登入 Google 帳號以啟用雲端同步功能</p>
                    <button
                      onClick={signInWithGoogle}
                      className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2"
                    >
                      <svg className="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                      </svg>
                      使用 Google 登入
                    </button>
                  </div>
                ) : (
                  <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-green-800">
                          已登入為：<strong>{firebaseUser.displayName || firebaseUser.email}</strong>
                        </p>
                        <p className="text-sm text-green-600">
                          {firebaseUser.email}
                        </p>
                      </div>
                      <button
                        onClick={signOutFirebase}
                        className="text-red-500 hover:text-red-600 flex items-center gap-1"
                      >
                        <Icon name="logout" size={16} />
                        登出
                      </button>
                    </div>
                  </div>
                )}

                {/* 自動同步設定 */}
                <div className="mb-6">
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={autoSync}
                      onChange={(e) => setAutoSync(e.target.checked)}
                      className="mr-2"
                    />
                    <span className="font-medium">啟用自動同步</span>
                  </label>
                  <p className="text-sm text-gray-600 mt-1">
                    當資料變更時自動同步到雲端（延遲 2 秒）
                  </p>
                </div>

                {/* 手動同步按鈕 */}
                {firebaseUser && (
                  <div className="flex gap-3">
                    <button
                      onClick={saveToFirebase}
                      disabled={loading || syncStatus === 'syncing'}
                      className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 disabled:opacity-50"
                    >
                      <Icon name="upload" size={18} />
                      {syncStatus === 'syncing' ? '同步中...' : '立即同步'}
                    </button>
                    <button
                      onClick={() => loadFromFirebase(firebaseUser.uid)}
                      disabled={loading}
                      className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex items-center gap-2 disabled:opacity-50"
                    >
                      <Icon name="download" size={18} />
                      重新載入
                    </button>
                  </div>
                )}

                {/* 說明 */}
                <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                  <h4 className="font-medium text-blue-900 mb-2">雲端同步說明</h4>
                  <ul className="text-sm text-blue-800 space-y-1">
                    <li>• 資料會即時同步到 Firebase 雲端資料庫</li>
                    <li>• 可在不同裝置間無縫切換使用</li>
                    <li>• 自動偵測並同步其他裝置的修改</li>
                    <li>• GitHub 備份可作為額外的資料保障</li>
                  </ul>
                </div>

                {/* Firebase 配置狀態 */}
                {!auth && (
                  <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p className="text-yellow-800 text-sm">
                      <strong>注意：</strong>Firebase 初始化失敗，請檢查瀏覽器控制台的錯誤訊息。
                    </p>
                  </div>
                )}
              </div>
            </div>
          );
        } catch (error) {
          console.error('renderSync 錯誤:', error);
          return (
            <div className="max-w-2xl mx-auto">
              <div className="bg-red-50 p-6 rounded-lg border border-red-200">
                <h3 className="text-red-800 font-semibold mb-2">發生錯誤</h3>
                <p className="text-red-600">無法載入雲端同步頁面。請開啟瀏覽器控制台查看詳細錯誤訊息。</p>
                <pre className="mt-4 p-3 bg-red-100 rounded text-xs overflow-auto">
                  {error.toString()}
                </pre>
              </div>
            </div>
          );
        }
      };
    };

    const App = () => {
      // 狀態管理
      const [currentTab, setCurrentTab] = useState('home');
      const [topics, setTopics] = useState([]);
      const [outputs, setOutputs] = useState([]);
      const [selectedTopicId, setSelectedTopicId] = useState(null);
      const [selectedOutputId, setSelectedOutputId] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [message, setMessage] = useState({ type: '', text: '' });
      const [loading, setLoading] = useState(false);

      // 編輯狀態 - 主題
      const [editingFields, setEditingFields] = useState({});
      const [tempValues, setTempValues] = useState({});

      // 編輯狀態 - 輸出條目
      const [editingOutputFields, setEditingOutputFields] = useState({});
      const [tempOutputValues, setTempOutputValues] = useState({});

      // AI助手狀態
      const [selectedTopicsForAI, setSelectedTopicsForAI] = useState([]);
      const [customPrompt, setCustomPrompt] = useState('');

      // GitHub備份狀態
      const [githubRepo, setGithubRepo] = useState('');
      const [githubPath, setGithubPath] = useState('backup.json');
      const [githubToken, setGithubToken] = useState('');
      const [githubUser, setGithubUser] = useState(null);
      const [showTokenInput, setShowTokenInput] = useState(false);

      // Firebase 狀態
      const [firebaseUser, setFirebaseUser] = useState(null);
      const [syncStatus, setSyncStatus] = useState('disconnected'); // 'disconnected', 'syncing', 'synced'
      const [lastSyncTime, setLastSyncTime] = useState(null);
      const [autoSync, setAutoSync] = useState(true);

      // GitHub 備份功能
      const [github] = useState(() => new GitHubService());

      // Firebase 初始化和認證監聽
      useEffect(() => {
        if (!auth || !db) return;

        const unsubscribe = auth.onAuthStateChanged((user) => {
          setFirebaseUser(user);
          if (user) {
            setSyncStatus('synced');
            loadFromFirebase(user.uid);
            setupRealtimeSync(user.uid);
          } else {
            setSyncStatus('disconnected');
          }
        });

        return () => unsubscribe();
      }, []);

      // 載入已儲存的 GitHub token
      useEffect(() => {
        const token = github.loadToken();
        if (token) {
          setGithubToken(token);
          github.getUser()
            .then(user => setGithubUser(user))
            .catch(err => {
              console.error('GitHub 認證失敗:', err);
              github.clearToken();
              setGithubToken('');
            });
        }
      }, []);

      // 顯示訊息
      const showMessage = (type, text) => {
        setMessage({ type, text });
        setTimeout(() => setMessage({ type: '', text: '' }), 3000);
      };

      // 建立新主題
      const createNewTopic = () => {
        const newTopic = {
          id: Date.now().toString(),
          name: '',
          category: '',
          content: '',
          note: '',
          createdAt: new Date().toISOString()
        };
        setTopics([...topics, newTopic]);
        setSelectedTopicId(newTopic.id);
        setCurrentTab('topic');
        setEditingFields({ name: true, category: true, content: true, note: true });
        setTempValues(newTopic);
      };

      // 開始編輯欄位 - 主題
      const startEdit = (field) => {
        const topic = topics.find(t => t.id === selectedTopicId);
        setEditingFields({ ...editingFields, [field]: true });
        setTempValues({ ...tempValues, [field]: topic[field] });
      };

      // 開始編輯欄位 - 輸出條目
      const startEditOutput = (field) => {
        const output = outputs.find(o => o.id === selectedOutputId);
        setEditingOutputFields({ ...editingOutputFields, [field]: true });
        setTempOutputValues({ ...tempOutputValues, [field]: output[field] });
      };

      // 儲存主題
      const saveTopic = () => {
        setLoading(true);
        setTimeout(() => {
          setTopics(topics.map(t => 
            t.id === selectedTopicId ? { ...t, ...tempValues } : t
          ));
          setEditingFields({});
          setLoading(false);
          showMessage('success', '儲存成功！');
        }, 500);
      };

      // 儲存輸出條目
      const saveOutput = () => {
        setLoading(true);
        setTimeout(() => {
          setOutputs(outputs.map(o => 
            o.id === selectedOutputId ? { ...o, ...tempOutputValues } : o
          ));
          setEditingOutputFields({});
          setLoading(false);
          showMessage('success', '儲存成功！');
        }, 500);
      };

      // 刪除主題
      const deleteTopic = () => {
        if (window.confirm('確定要刪除此主題嗎？')) {
          setTopics(topics.filter(t => t.id !== selectedTopicId));
          setCurrentTab('home');
          showMessage('success', '刪除成功！');
        }
      };

      // Firebase 功能
      // Google 登入
      const signInWithGoogle = async () => {
        if (!auth) {
          showMessage('error', 'Firebase 未配置');
          return;
        }

        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await auth.signInWithPopup(provider);
          showMessage('success', `已登入為 ${result.user.displayName}`);
        } catch (error) {
          showMessage('error', '登入失敗：' + error.message);
        }
      };

      // 登出 Firebase
      const signOutFirebase = async () => {
        try {
          await auth.signOut();
          showMessage('success', '已登出');
        } catch (error) {
          showMessage('error', '登出失敗：' + error.message);
        }
      };

      // 從 Firebase 載入資料
      const loadFromFirebase = async (userId) => {
        if (!db) return;

        try {
          const doc = await db.collection('users').doc(userId).get();
          if (doc.exists) {
            const data = doc.data();
            setTopics(data.topics || []);
            setOutputs(data.outputs || []);
            setLastSyncTime(new Date(data.lastModified));
          }
        } catch (error) {
          console.error('載入資料失敗:', error);
        }
      };

      // 儲存到 Firebase
      const saveToFirebase = async () => {
        if (!db || !firebaseUser) return;

        setSyncStatus('syncing');
        try {
          await db.collection('users').doc(firebaseUser.uid).set({
            topics: topics,
            outputs: outputs,
            lastModified: new Date().toISOString()
          });
          setLastSyncTime(new Date());
          setSyncStatus('synced');
        } catch (error) {
          console.error('儲存失敗:', error);
          setSyncStatus('error');
          showMessage('error', '同步失敗：' + error.message);
        }
      };

      // 設定即時同步
      const setupRealtimeSync = (userId) => {
        if (!db) return;

        const unsubscribe = db.collection('users').doc(userId)
          .onSnapshot((doc) => {
            if (doc.exists) {
              const data = doc.data();
              // 檢查是否是來自其他裝置的更新
              const remoteTime = new Date(data.lastModified);
              if (!lastSyncTime || remoteTime > lastSyncTime) {
                setTopics(data.topics || []);
                setOutputs(data.outputs || []);
                setLastSyncTime(remoteTime);
                showMessage('info', '資料已從雲端同步');
              }
            }
          });

        return unsubscribe;
      };

      // 自動同步（當資料改變時）
      useEffect(() => {
        if (autoSync && firebaseUser && (topics.length > 0 || outputs.length > 0)) {
          const timer = setTimeout(() => {
            saveToFirebase();
          }, 2000); // 延遲 2 秒儲存，避免太頻繁

          return () => clearTimeout(timer);
        }
      }, [topics, outputs, autoSync, firebaseUser]);

      // 刪除輸出條目
      const deleteOutput = () => {
        if (window.confirm('確定要刪除此輸出紀錄嗎？')) {
          setOutputs(outputs.filter(o => o.id !== selectedOutputId));
          setSelectedOutputId(null);
          showMessage('success', '刪除成功！');
        }
      };

      // 整合內容
      const getIntegratedContent = () => {
        return selectedTopicsForAI
          .map(topicId => {
            const topic = topics.find(t => t.id === topicId);
            return topic ? `# 主題：${topic.name || '請輸入主題名稱'}\n${topic.content || '請輸入內容'}` : '';
          })
          .filter(content => content)
          .join('\n\n');
      };

      // 輸出到Perplexity
      const outputToPerplexity = () => {
        const content = getIntegratedContent();
        const fullQuery = `${content}\n\n${customPrompt}`;
        const url = `https://www.perplexity.ai/?q=${encodeURIComponent(fullQuery)}`;
        
        // 建立輸出紀錄
        const newOutput = {
          id: Date.now().toString(),
          name: `輸出紀錄_${new Date().toLocaleString('zh-TW')}`,
          note: '',
          time: new Date().toISOString(),
          topicNames: selectedTopicsForAI.map(id => 
            topics.find(t => t.id === id)?.name || ''
          ).filter(name => name),
          customPrompt: customPrompt,
          aiResponse: ''
        };
        
        setOutputs([...outputs, newOutput]);
        window.open(url, '_blank');
        showMessage('success', '已開啟Perplexity並建立輸出紀錄！');
      };

      // 複製內容
      const copyContent = () => {
        const content = getIntegratedContent();
        const fullText = `${content}\n\n${customPrompt}`;
        navigator.clipboard.writeText(fullText);
        
        // 建立輸出紀錄
        const newOutput = {
          id: Date.now().toString(),
          name: `輸出紀錄_${new Date().toLocaleString('zh-TW')}`,
          note: '',
          time: new Date().toISOString(),
          topicNames: selectedTopicsForAI.map(id => 
            topics.find(t => t.id === id)?.name || ''
          ).filter(name => name),
          customPrompt: customPrompt,
          aiResponse: ''
        };
        
        setOutputs([...outputs, newOutput]);
        showMessage('success', '已複製到剪貼簿並建立輸出紀錄！');
      };

      // GitHub 認證
      const authenticateGitHub = async () => {
        if (!githubToken) {
          showMessage('error', '請輸入 Personal Access Token');
          return;
        }

        setLoading(true);
        try {
          github.setToken(githubToken);
          const user = await github.getUser();
          setGithubUser(user);
          setShowTokenInput(false);
          showMessage('success', `已成功登入為 ${user.login}`);
        } catch (err) {
          showMessage('error', '認證失敗：' + err.message);
          github.clearToken();
          setGithubToken('');
        } finally {
          setLoading(false);
        }
      };

      // 登出 GitHub
      const logoutGitHub = () => {
        github.clearToken();
        setGithubToken('');
        setGithubUser(null);
        showMessage('success', '已登出 GitHub');
      };

      // GitHub 備份
      const backupToGitHub = async () => {
        if (!githubUser) {
          showMessage('error', '請先登入 GitHub');
          return;
        }

        if (!githubRepo) {
          showMessage('error', '請輸入儲存庫路徑');
          return;
        }

        setLoading(true);
        try {
          const [owner, repo] = githubRepo.split('/');
          if (!owner || !repo) {
            throw new Error('儲存庫路徑格式錯誤，應為 username/repository');
          }

          const backupData = {
            version: '1.0',
            timestamp: new Date().toISOString(),
            topics: topics,
            outputs: outputs
          };

          const content = JSON.stringify(backupData, null, 2);
          const file = await github.getFile(owner, repo, githubPath);
          
          const message = file.exists 
            ? `更新備份 - ${new Date().toLocaleString('zh-TW')}`
            : `建立備份 - ${new Date().toLocaleString('zh-TW')}`;

          await github.createOrUpdateFile(owner, repo, githubPath, content, message, file.sha);
          showMessage('success', '備份成功！');
        } catch (err) {
          showMessage('error', '備份失敗：' + err.message);
        } finally {
          setLoading(false);
        }
      };

      // GitHub 還原
      const restoreFromGitHub = async () => {
        if (!githubUser) {
          showMessage('error', '請先登入 GitHub');
          return;
        }

        if (!githubRepo) {
          showMessage('error', '請輸入儲存庫路徑');
          return;
        }

        setLoading(true);
        try {
          const [owner, repo] = githubRepo.split('/');
          if (!owner || !repo) {
            throw new Error('儲存庫路徑格式錯誤，應為 username/repository');
          }

          const backupData = await github.readFile(owner, repo, githubPath);
          
          // 處理還原邏輯
          let mergedTopics = [...topics];
          let mergedOutputs = [...outputs];
          
          // 合併主題
          for (const backupTopic of backupData.topics || []) {
            const existing = mergedTopics.find(t => t.name === backupTopic.name);
            if (existing) {
              if (window.confirm(`主題「${backupTopic.name}」已存在，是否覆蓋？`)) {
                mergedTopics = mergedTopics.map(t => 
                  t.id === existing.id ? { ...backupTopic, id: existing.id } : t
                );
              }
            } else {
              mergedTopics.push({ ...backupTopic, id: Date.now().toString() + Math.random() });
            }
          }

          // 合併輸出紀錄
          for (const backupOutput of backupData.outputs || []) {
            const existing = mergedOutputs.find(o => 
              o.time === backupOutput.time && o.name === backupOutput.name
            );
            if (!existing) {
              mergedOutputs.push({ ...backupOutput, id: Date.now().toString() + Math.random() });
            }
          }
          
          setTopics(mergedTopics);
          setOutputs(mergedOutputs);
          showMessage('success', `還原成功！新增 ${backupData.topics?.length || 0} 個主題，${backupData.outputs?.length || 0} 筆輸出紀錄`);
        } catch (err) {
          showMessage('error', '還原失敗：' + err.message);
        } finally {
          setLoading(false);
        }
      };

      // 篩選主題
      const filteredTopics = topics.filter(topic => 
        topic.name.toLowerCase().includes(searchTerm.toLowerCase())
      );

      // 排序主題（按名稱）
      const sortedTopics = [...filteredTopics].sort((a, b) => 
        a.name.localeCompare(b.name, 'zh-TW')
      );

      // 排序輸出條目（按時間倒序）
      const sortedOutputs = [...outputs].sort((a, b) => 
        new Date(b.time) - new Date(a.time)
      );

      // 渲染欄位（統一格式）
      const renderField = (
        field, 
        label, 
        value, 
        isEditing, 
        tempValue, 
        onStartEdit, 
        onTempChange,
        multiline = false
      ) => (
        <div className="mb-4">
          <div className="flex items-center justify-between mb-2">
            <label className="font-medium text-gray-700">{label}</label>
            {!isEditing && (
              <button
                onClick={() => onStartEdit(field)}
                className="text-blue-500 hover:text-blue-600"
              >
                <Icon name="edit" size={18} />
              </button>
            )}
          </div>
          {isEditing ? (
            multiline ? (
              <textarea
                value={tempValue || ''}
                onChange={(e) => onTempChange(e.target.value)}
                placeholder={`請輸入${label}...`}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-400"
                rows={6}
              />
            ) : (
              <input
                type="text"
                value={tempValue || ''}
                onChange={(e) => onTempChange(e.target.value)}
                placeholder={`請輸入${label}...`}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-400"
              />
            )
          ) : (
            <div className={`px-3 py-2 bg-gray-50 rounded-lg ${!value && 'text-gray-400'}`}>
              {value || `請輸入${label}...`}
            </div>
          )}
        </div>
      );

      // 渲染主頁
      const renderHome = () => (
        <div className="max-w-4xl mx-auto">
          <div className="mb-6 flex gap-4">
            <div className="flex-1">
              <input
                type="text"
                placeholder="搜尋主題名稱..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-400"
              />
            </div>
            <button
              onClick={createNewTopic}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2"
            >
              <Icon name="plus" size={20} />
              新增主題
            </button>
          </div>

          <div className="space-y-3">
            {sortedTopics.map(topic => (
              <div
                key={topic.id}
                onClick={() => {
                  setSelectedTopicId(topic.id);
                  setCurrentTab('topic');
                }}
                className="p-4 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
              >
                <h3 className="text-lg font-semibold text-gray-800">
                  {topic.name || '請輸入主題名稱...'}
                </h3>
                <p className="text-gray-600 text-sm mt-1">
                  {topic.note || '請輸入備註...'}
                </p>
              </div>
            ))}
            
            {sortedTopics.length === 0 && (
              <div className="text-center py-12 text-gray-500">
                {searchTerm ? '找不到符合的主題' : '尚未建立任何主題'}
              </div>
            )}
          </div>
        </div>
      );

      // 渲染主題內容分頁
      const renderTopic = () => {
        const topic = topics.find(t => t.id === selectedTopicId);
        if (!topic) return <div>找不到主題</div>;

        return (
          <div className="max-w-2xl mx-auto">
            <div className="bg-white p-6 rounded-lg border border-gray-200">
              {renderField(
                'name', '主題名稱', topic.name, 
                editingFields.name, tempValues.name,
                startEdit,
                (value) => setTempValues({ ...tempValues, name: value })
              )}
              {renderField(
                'category', '分類', topic.category,
                editingFields.category, tempValues.category,
                startEdit,
                (value) => setTempValues({ ...tempValues, category: value })
              )}
              {renderField(
                'content', '內容', topic.content,
                editingFields.content, tempValues.content,
                startEdit,
                (value) => setTempValues({ ...tempValues, content: value }),
                true
              )}
              {renderField(
                'note', '備註', topic.note,
                editingFields.note, tempValues.note,
                startEdit,
                (value) => setTempValues({ ...tempValues, note: value })
              )}

              <div className="flex gap-3 mt-6">
                {Object.keys(editingFields).length > 0 && (
                  <button
                    onClick={saveTopic}
                    disabled={loading}
                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 disabled:opacity-50"
                  >
                    <Icon name="save" size={18} />
                    {loading ? '儲存中...' : '儲存'}
                  </button>
                )}
                <button
                  onClick={deleteTopic}
                  className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2"
                >
                  <Icon name="trash" size={18} />
                  刪除
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 渲染AI助手分頁
      const renderAIHelper = () => (
        <div className="max-w-4xl mx-auto">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <h3 className="text-lg font-semibold mb-4">選擇主題</h3>
              <div className="space-y-2 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-3">
                {topics.map(topic => (
                  <label key={topic.id} className="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input
                      type="checkbox"
                      checked={selectedTopicsForAI.includes(topic.id)}
                      onChange={(e) => {
                        if (e.target.checked) {
                          setSelectedTopicsForAI([...selectedTopicsForAI, topic.id]);
                        } else {
                          setSelectedTopicsForAI(selectedTopicsForAI.filter(id => id !== topic.id));
                        }
                      }}
                      className="mr-3"
                    />
                    <span>{topic.name || '請輸入主題名稱...'}</span>
                  </label>
                ))}
              </div>
            </div>

            <div>
              <h3 className="text-lg font-semibold mb-4">整合內容預覽</h3>
              <textarea
                value={getIntegratedContent()}
                readOnly
                placeholder="請選擇主題..."
                className="w-full h-64 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg"
              />
              
              <div className="mt-4">
                <label className="block font-medium text-gray-700 mb-2">自訂提示詞</label>
                <textarea
                  value={customPrompt}
                  onChange={(e) => setCustomPrompt(e.target.value)}
                  placeholder="請輸入額外的提問或指令..."
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-400"
                  rows={3}
                />
              </div>

              <div className="flex gap-3 mt-4">
                <button
                  onClick={outputToPerplexity}
                  disabled={selectedTopicsForAI.length === 0}
                  className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 disabled:opacity-50"
                >
                  <Icon name="external" size={18} />
                  輸出到 Perplexity
                </button>
                <button
                  onClick={copyContent}
                  disabled={selectedTopicsForAI.length === 0}
                  className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 flex items-center gap-2 disabled:opacity-50"
                >
                  <Icon name="copy" size={18} />
                  複製內容
                </button>
              </div>
            </div>
          </div>
        </div>
      );

      // 渲染已輸出條目
      const renderOutputHistory = () => {
        if (selectedOutputId) {
          const output = outputs.find(o => o.id === selectedOutputId);
          if (!output) return <div>找不到輸出紀錄</div>;

          return (
            <div className="max-w-2xl mx-auto">
              <button
                onClick={() => setSelectedOutputId(null)}
                className="mb-4 text-blue-500 hover:text-blue-600"
              >
                ← 返回列表
              </button>

              <div className="bg-white p-6 rounded-lg border border-gray-200">
                {renderField(
                  'name', '紀錄名稱', output.name,
                  editingOutputFields.name, tempOutputValues.name,
                  startEditOutput,
                  (value) => setTempOutputValues({ ...tempOutputValues, name: value })
                )}
                {renderField(
                  'note', '備註', output.note,
                  editingOutputFields.note, tempOutputValues.note,
                  startEditOutput,
                  (value) => setTempOutputValues({ ...tempOutputValues, note: value })
                )}

                <div className="mb-4">
                  <p className="font-medium text-gray-700">輸出時間</p>
                  <p className="mt-1 text-gray-600">
                    {new Date(output.time).toLocaleString('zh-TW')}
                  </p>
                </div>

                <div className="mb-4">
                  <p className="font-medium text-gray-700">整合主題</p>
                  <p className="mt-1 text-gray-600">
                    {output.topicNames.length > 0 ? output.topicNames.join(', ') : '請選擇主題...'}
                  </p>
                </div>

                <div className="mb-4">
                  <p className="font-medium text-gray-700">自訂提示詞</p>
                  <p className="mt-1 text-gray-600 whitespace-pre-wrap">
                    {output.customPrompt || '請輸入提示詞...'}
                  </p>
                </div>

                {renderField(
                  'aiResponse', 'AI 回覆結果', output.aiResponse,
                  editingOutputFields.aiResponse, tempOutputValues.aiResponse,
                  startEditOutput,
                  (value) => setTempOutputValues({ ...tempOutputValues, aiResponse: value }),
                  true
                )}

                <div className="flex gap-3 mt-6">
                  {Object.keys(editingOutputFields).length > 0 && (
                    <button
                      onClick={saveOutput}
                      disabled={loading}
                      className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 disabled:opacity-50"
                    >
                      <Icon name="save" size={18} />
                      {loading ? '儲存中...' : '儲存'}
                    </button>
                  )}
                  <button
                    onClick={deleteOutput}
                    className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2"
                  >
                    <Icon name="trash" size={18} />
                    刪除
                  </button>
                </div>
              </div>
            </div>
          );
        }

        return (
          <div className="max-w-4xl mx-auto">
            <div className="space-y-3">
              {sortedOutputs.map(output => (
                <div
                  key={output.id}
                  onClick={() => setSelectedOutputId(output.id)}
                  className="p-4 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                >
                  <h3 className="text-lg font-semibold text-gray-800">
                    {output.name || '請輸入紀錄名稱...'}
                  </h3>
                  <p className="text-gray-600 text-sm mt-1">
                    {output.note || '請輸入備註...'}
                  </p>
                  <p className="text-gray-500 text-xs mt-2">
                    {new Date(output.time).toLocaleString('zh-TW')}
                  </p>
                </div>
              ))}
              
              {sortedOutputs.length === 0 && (
                <div className="text-center py-12 text-gray-500">
                  尚未有任何輸出紀錄
                </div>
              )}
            </div>
          </div>
        );
      };

      // 渲染備份分頁
      const renderBackup = () => (
        <div className="max-w-2xl mx-auto">
          <div className="bg-white p-6 rounded-lg border border-gray-200">
            <h3 className="text-lg font-semibold mb-4">GitHub 備份設定</h3>
            
            {/* GitHub 認證狀態 */}
            {!githubUser ? (
              <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p className="text-yellow-800 mb-3">請先登入 GitHub 以使用備份功能</p>
                
                {!showTokenInput ? (
                  <button
                    onClick={() => setShowTokenInput(true)}
                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                  >
                    設定 Personal Access Token
                  </button>
                ) : (
                  <div>
                    <input
                      type="password"
                      value={githubToken}
                      onChange={(e) => setGithubToken(e.target.value)}
                      placeholder="貼上您的 Personal Access Token"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3"
                    />
                    <div className="flex gap-2">
                      <button
                        onClick={authenticateGitHub}
                        disabled={loading || !githubToken}
                        className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50"
                      >
                        {loading ? '認證中...' : '認證'}
                      </button>
                      <button
                        onClick={() => {
                          setShowTokenInput(false);
                          setGithubToken('');
                        }}
                        className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                      >
                        取消
                      </button>
                    </div>
                  </div>
                )}
                
                <div className="mt-4 text-sm text-gray-600">
                  <p className="font-medium mb-1">如何取得 Personal Access Token：</p>
                  <ol className="list-decimal list-inside space-y-1">
                    <li>前往 GitHub Settings → Developer settings → Personal access tokens</li>
                    <li>點擊 "Generate new token (classic)"</li>
                    <li>設定名稱並選擇 "repo" 權限</li>
                    <li>產生並複製 token（請妥善保存，只會顯示一次）</li>
                  </ol>
                </div>
              </div>
            ) : (
              <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div className="flex items-center justify-between">
                  <p className="text-green-800">
                    已登入為：<strong>{githubUser.login}</strong>
                  </p>
                  <button
                    onClick={logoutGitHub}
                    className="text-red-500 hover:text-red-600 flex items-center gap-1"
                  >
                    <Icon name="logout" size={16} />
                    登出
                  </button>
                </div>
              </div>
            )}
            
            {/* 備份設定 */}
            <div className="mb-6">
              <label className="block font-medium text-gray-700 mb-2">儲存庫路徑</label>
              <input
                type="text"
                value={githubRepo}
                onChange={(e) => setGithubRepo(e.target.value)}
                placeholder="請輸入 username/repository..."
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-400"
                disabled={!githubUser}
              />
            </div>

            <div className="mb-6">
              <label className="block font-medium text-gray-700 mb-2">檔案名稱</label>
              <input
                type="text"
                value={githubPath}
                onChange={(e) => setGithubPath(e.target.value)}
                placeholder="請輸入檔案路徑..."
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-400"
                disabled={!githubUser}
              />
            </div>

            <div className="flex gap-3">
              <button
                onClick={backupToGitHub}
                disabled={loading || !githubRepo || !githubUser}
                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 disabled:opacity-50"
              >
                <Icon name="upload" size={18} />
                {loading ? '備份中...' : '備份到 GitHub'}
              </button>
              <button
                onClick={restoreFromGitHub}
                disabled={loading || !githubRepo || !githubUser}
                className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2 disabled:opacity-50"
              >
                <Icon name="download" size={18} />
                {loading ? '還原中...' : '從 GitHub 還原'}
              </button>
            </div>

            {/* 備份資料預覽 */}
            <div className="mt-6">
              <h4 className="font-medium text-gray-700 mb-2">備份資料摘要</h4>
              <pre className="bg-gray-50 p-3 rounded-lg text-xs overflow-x-auto">
{JSON.stringify({
  version: '1.0',
  timestamp: new Date().toISOString(),
  topics: topics.length,
  outputs: outputs.length,
  repository: githubRepo || '未設定',
  path: githubPath,
  user: githubUser?.login || '未登入'
}, null, 2)}
              </pre>
            </div>
          </div>
        </div>
      );

      // 主要渲染
      return (
        <div className="min-h-screen bg-gray-50">
          {/* 頁首 */}
          <header className="bg-white border-b border-gray-200">
            <div className="container mx-auto px-4 py-4 flex items-center justify-between">
              <h1 className="text-2xl font-bold text-gray-800">知識與提示詞管理工具</h1>
              {/* 同步狀態指示器 */}
              {firebaseUser && (
                <div className="flex items-center gap-2 text-sm">
                  <div className={`w-2 h-2 rounded-full ${
                    syncStatus === 'synced' ? 'bg-green-500' :
                    syncStatus === 'syncing' ? 'bg-yellow-500 animate-pulse' :
                    syncStatus === 'error' ? 'bg-red-500' :
                    'bg-gray-500'
                  }`}></div>
                  <span className="text-gray-600">
                    {syncStatus === 'synced' ? '已同步' :
                     syncStatus === 'syncing' ? '同步中' :
                     syncStatus === 'error' ? '同步錯誤' :
                     '未連接'}
                  </span>
                </div>
              )}
            </div>
          </header>

          {/* 分頁導航 */}
          <nav className="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div className="container mx-auto px-4">
              <div className="flex space-x-6">
                <button
                  onClick={() => setCurrentTab('home')}
                  className={`py-3 px-1 border-b-2 font-medium text-sm ${
                    currentTab === 'home'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  主頁
                </button>
                {selectedTopicId && (
                  <button
                    onClick={() => setCurrentTab('topic')}
                    className={`py-3 px-1 border-b-2 font-medium text-sm ${
                      currentTab === 'topic'
                        ? 'border-blue-500 text-blue-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700'
                    }`}
                  >
                    主題內容
                  </button>
                )}
                <button
                  onClick={() => setCurrentTab('ai')}
                  className={`py-3 px-1 border-b-2 font-medium text-sm ${
                    currentTab === 'ai'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  AI 助手
                </button>
                <button
                  onClick={() => setCurrentTab('history')}
                  className={`py-3 px-1 border-b-2 font-medium text-sm ${
                    currentTab === 'history'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  已輸出條目
                </button>
                <button
                  onClick={() => setCurrentTab('backup')}
                  className={`py-3 px-1 border-b-2 font-medium text-sm ${
                    currentTab === 'backup'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  備份管理
                </button>
                <button
                  onClick={() => setCurrentTab('sync')}
                  className={`py-3 px-1 border-b-2 font-medium text-sm flex items-center gap-1 ${
                    currentTab === 'sync'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  <Icon name="cloud" size={16} />
                  雲端同步
                </button>
              </div>
            </div>
          </nav>

          {/* 主要內容 */}
          <main className="container mx-auto px-4 py-6">
            {currentTab === 'home' && renderHome()}
            {currentTab === 'topic' && renderTopic()}
            {currentTab === 'ai' && renderAIHelper()}
            {currentTab === 'history' && renderOutputHistory()}
            {currentTab === 'backup' && renderBackup()}
            {currentTab === 'sync' && renderSync()}
          </main>

          {/* 訊息提示 */}
          {message.text && (
            <div className={`fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white flex items-center gap-2 ${
              message.type === 'success' ? 'bg-green-500' :
              message.type === 'error' ? 'bg-red-500' :
              'bg-blue-500'
            }`}>
              {message.type === 'success' && <Icon name="check" size={18} />}
              {message.type === 'error' && <Icon name="x" size={18} />}
              {message.text}
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
