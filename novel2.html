<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èªªç´ æåº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .main-app {
            display: none;
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #4a5568;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.3s;
            font-weight: 600;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f7fafc;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .items-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .item-content {
            color: #4a5568;
            line-height: 1.6;
        }

        .item-meta {
            font-size: 12px;
            color: #718096;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #718096;
        }

        .close:hover {
            color: #e53e3e;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            /* AIåŠ©æ‰‹éŸ¿æ‡‰å¼ */
            #aihelper > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            #aihelper div[style*="grid-template-columns: repeat"] {
                grid-template-columns: 1fr !important;
            }
        }

        .secret-warning {
            background: #fed7e2;
            color: #97266d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>ğŸ”’ å°èªªç´ æåº«</h1>
            <div class="input-group">
                <label for="password">è«‹è¼¸å…¥å¯†ç¢¼ï¼š</label>
                <input type="password" id="password" placeholder="å¯†ç¢¼">
            </div>
            <button class="btn" onclick="login()" style="width: 100%;">ç™»å…¥</button>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <div class="header">
                <h1>ğŸ“š å°èªªç´ æåº«</h1>
                <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('characters')">è§’è‰²è¨­å®š</div>
                <div class="nav-tab" onclick="switchTab('backgrounds')">æ•…äº‹èƒŒæ™¯</div>
                <div class="nav-tab" onclick="switchTab('secrets')">ç§˜å¯†è¨­å®š</div>
                <div class="nav-tab" onclick="switchTab('novels')">AIå°èªª</div>
                <div class="nav-tab" onclick="switchTab('aihelper')">ğŸ¤– AIåŠ©æ‰‹</div>
            </div>

            <!-- è§’è‰²è¨­å®š -->
            <div id="characters" class="content-section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ‘¤ è§’è‰²è¨­å®š</h2>
                    <button class="btn" onclick="openModal('characterModal')">æ–°å¢è§’è‰²</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="characterSearch" placeholder="æœå°‹è§’è‰²..." onkeyup="searchItems('characters')">
                </div>
                <div id="charactersList" class="items-grid"></div>
            </div>

            <!-- æ•…äº‹èƒŒæ™¯ -->
            <div id="backgrounds" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸŒ æ•…äº‹èƒŒæ™¯</h2>
                    <button class="btn" onclick="openModal('backgroundModal')">æ–°å¢èƒŒæ™¯</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="backgroundSearch" placeholder="æœå°‹èƒŒæ™¯..." onkeyup="searchItems('backgrounds')">
                </div>
                <div id="backgroundsList" class="items-grid"></div>
            </div>

            <!-- ç§˜å¯†è¨­å®š -->
            <div id="secrets" class="content-section">
                <div class="secret-warning">
                    âš ï¸ æ³¨æ„ï¼šæ­¤å€åŸŸåŒ…å«åŠ‡é€å’Œæ•æ„Ÿè¨­å®šï¼Œè«‹è¬¹æ…åˆ†äº«
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ” ç§˜å¯†è¨­å®š</h2>
                    <button class="btn" onclick="openModal('secretModal')">æ–°å¢ç§˜å¯†</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="secretSearch" placeholder="æœå°‹ç§˜å¯†è¨­å®š..." onkeyup="searchItems('secrets')">
                </div>
                <div id="secretsList" class="items-grid"></div>
            </div>

            <!-- AIå°èªª -->
            <div id="novels" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ“– AIå°èªª</h2>
                    <button class="btn" onclick="openModal('novelModal')">æ–°å¢å°èªª</button>
                </div>
                <div class="search-bar">
                    <input type="text" id="novelSearch" placeholder="æœå°‹å°èªª..." onkeyup="searchItems('novels')">
                </div>
                <div id="novelsList" class="items-grid"></div>

                <div class="export-section">
                    <h3>ğŸ“¤ åŒ¯å‡ºåŠŸèƒ½</h3>
                    <p>å°‡æ‰€æœ‰è³‡æ–™åŒ¯å‡ºçµ¦AIä½¿ç”¨ï¼š</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="exportForAI()">åŒ¯å‡ºçµ¦AI</button>
                        <button class="btn btn-secondary" onclick="exportAll()">åŒ¯å‡ºæ‰€æœ‰è³‡æ–™</button>
                    </div>
                </div>
            </div>

            <!-- AIåŠ©æ‰‹ -->
            <div id="aihelper" class="content-section">
                <h2>ğŸ¤– AIåŠ©æ‰‹ - Perplexity æ•´åˆ</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- ç´ æé¸æ“‡ -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 10px;">
                        <h3>ğŸ“‹ é¸æ“‡ç´ æ</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label><strong>è§’è‰²é¸æ“‡ï¼š</strong></label>
                            <div id="characterSelector" style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 5px; background: white;">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label><strong>èƒŒæ™¯é¸æ“‡ï¼š</strong></label>
                            <div id="backgroundSelector" style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; border-radius: 5px; background: white;">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>
                                <input type="checkbox" id="includeSecrets"> åŒ…å«ç§˜å¯†è¨­å®š ğŸ”
                            </label>
                        </div>
                    </div>
                    
                    <!-- æç¤ºè©æ¨¡æ¿ -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 10px;">
                        <h3>ğŸ“ æç¤ºè©æ¨¡æ¿</h3>
                        <select id="promptTemplate" onchange="updatePrompt()" style="width: 100%; margin-bottom: 15px;">
                            <option value="story">å‰µä½œæ•…äº‹</option>
                            <option value="dialogue">å¯«å°è©±</option>
                            <option value="scene">å ´æ™¯æè¿°</option>
                            <option value="character_development">è§’è‰²ç™¼å±•</option>
                            <option value="plot_analysis">åŠ‡æƒ…åˆ†æ</option>
                            <option value="custom">è‡ªè¨‚æç¤ºè©</option>
                        </select>
                        
                        <div id="templateDescription" style="font-size: 14px; color: #718096; margin-bottom: 15px;">
                            æ ¹æ“šä½ çš„ç´ æå‰µä½œä¸€å€‹å®Œæ•´çš„æ•…äº‹
                        </div>
                        
                        <button class="btn" onclick="generatePrompt()" style="width: 100%;">ğŸ¯ ç”Ÿæˆæç¤ºè©</button>
                    </div>
                </div>
                
                <!-- ç”Ÿæˆçš„æç¤ºè© -->
                <div style="background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>ğŸ¯ ç”Ÿæˆçš„æç¤ºè©</h3>
                        <div>
                            <button class="btn btn-small" onclick="copyPrompt()">ğŸ“‹ è¤‡è£½</button>
                            <button class="btn btn-small" onclick="sendToPerplexity()">ğŸš€ ç™¼é€åˆ° Perplexity</button>
                        </div>
                    </div>
                    <textarea id="generatedPrompt" style="width: 100%; min-height: 200px; font-family: monospace; background: #f8f9fa;" placeholder="é»æ“Šã€Œç”Ÿæˆæç¤ºè©ã€æŒ‰éˆ•ä¾†å‰µå»ºé©åˆ Perplexity çš„æç¤ºè©..."></textarea>
                </div>
                
                <!-- å¿«é€Ÿå‹•ä½œ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <button class="btn btn-secondary" onclick="quickPrompt('brainstorm')">ğŸ’¡ åŠ‡æƒ…éˆæ„Ÿ</button>
                    <button class="btn btn-secondary" onclick="quickPrompt('character_chat')">ğŸ’¬ è§’è‰²å°è©±</button>
                    <button class="btn btn-secondary" onclick="quickPrompt('world_expand')">ğŸŒ ä¸–ç•Œæ“´å±•</button>
                    <button class="btn btn-secondary" onclick="quickPrompt('plot_twist')">ğŸ­ åŠ‡æƒ…è½‰æŠ˜</button>
                </div>
                
                <!-- ä½¿ç”¨èªªæ˜ -->
                <div style="background: #e6fffa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <h4>ğŸ“– ä½¿ç”¨èªªæ˜</h4>
                    <ol style="margin-left: 20px; color: #2d3748;">
                        <li>é¸æ“‡ä½ æƒ³è¦ä½¿ç”¨çš„è§’è‰²å’ŒèƒŒæ™¯ç´ æ</li>
                        <li>é¸æ“‡é©åˆçš„æç¤ºè©æ¨¡æ¿</li>
                        <li>é»æ“Šã€Œç”Ÿæˆæç¤ºè©ã€å‰µå»ºå®Œæ•´çš„æç¤º</li>
                        <li>è¤‡è£½æç¤ºè©è²¼åˆ° Perplexityï¼Œæˆ–ç›´æ¥é»æ“Šã€Œç™¼é€åˆ° Perplexityã€</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹è¦–çª— -->
    <!-- è§’è‰²æ¨¡æ…‹ -->
    <div id="characterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="characterModalTitle">æ–°å¢è§’è‰²</h3>
                <span class="close" onclick="closeModal('characterModal')">&times;</span>
            </div>
            <form id="characterForm">
                <div class="input-group">
                    <label for="characterName">è§’è‰²åç¨±ï¼š</label>
                    <input type="text" id="characterName" required>
                </div>
                <div class="input-group">
                    <label for="characterAge">å¹´é½¡ï¼š</label>
                    <input type="text" id="characterAge">
                </div>
                <div class="input-group">
                    <label for="characterAppearance">å¤–è²Œæè¿°ï¼š</label>
                    <textarea id="characterAppearance"></textarea>
                </div>
                <div class="input-group">
                    <label for="characterPersonality">æ€§æ ¼ç‰¹è³ªï¼š</label>
                    <textarea id="characterPersonality"></textarea>
                </div>
                <div class="input-group">
                    <label for="characterBackground">èƒŒæ™¯æ•…äº‹ï¼š</label>
                    <textarea id="characterBackground"></textarea>
                </div>
                <div class="input-group">
                    <label for="characterNotes">é¡å¤–å‚™è¨»ï¼š</label>
                    <textarea id="characterNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('characterModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- èƒŒæ™¯æ¨¡æ…‹ -->
    <div id="backgroundModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="backgroundModalTitle">æ–°å¢æ•…äº‹èƒŒæ™¯</h3>
                <span class="close" onclick="closeModal('backgroundModal')">&times;</span>
            </div>
            <form id="backgroundForm">
                <div class="input-group">
                    <label for="backgroundName">å ´æ™¯åç¨±ï¼š</label>
                    <input type="text" id="backgroundName" required>
                </div>
                <div class="input-group">
                    <label for="backgroundType">é¡å‹ï¼š</label>
                    <select id="backgroundType">
                        <option value="åœ°é»">åœ°é»</option>
                        <option value="æ™‚ä»£">æ™‚ä»£</option>
                        <option value="ä¸–ç•Œè§€">ä¸–ç•Œè§€</option>
                        <option value="æ–‡åŒ–">æ–‡åŒ–</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="backgroundDescription">è©³ç´°æè¿°ï¼š</label>
                    <textarea id="backgroundDescription"></textarea>
                </div>
                <div class="input-group">
                    <label for="backgroundRules">è¦å‰‡/æ³•å‰‡ï¼š</label>
                    <textarea id="backgroundRules"></textarea>
                </div>
                <div class="input-group">
                    <label for="backgroundNotes">å‚™è¨»ï¼š</label>
                    <textarea id="backgroundNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('backgroundModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç§˜å¯†è¨­å®šæ¨¡æ…‹ -->
    <div id="secretModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="secretModalTitle">æ–°å¢ç§˜å¯†è¨­å®š</h3>
                <span class="close" onclick="closeModal('secretModal')">&times;</span>
            </div>
            <form id="secretForm">
                <div class="input-group">
                    <label for="secretTitle">æ¨™é¡Œï¼š</label>
                    <input type="text" id="secretTitle" required>
                </div>
                <div class="input-group">
                    <label for="secretCategory">é¡åˆ¥ï¼š</label>
                    <select id="secretCategory">
                        <option value="åŠ‡æƒ…è½‰æŠ˜">åŠ‡æƒ…è½‰æŠ˜</option>
                        <option value="è§’è‰²ç§˜å¯†">è§’è‰²ç§˜å¯†</option>
                        <option value="ä¸–ç•Œè¨­å®š">ä¸–ç•Œè¨­å®š</option>
                        <option value="ä¼ç­†">ä¼ç­†</option>
                        <option value="çµå±€">çµå±€</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="secretContent">å…§å®¹ï¼š</label>
                    <textarea id="secretContent"></textarea>
                </div>
                <div class="input-group">
                    <label for="secretImpact">å½±éŸ¿/é‡è¦æ€§ï¼š</label>
                    <textarea id="secretImpact"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('secretModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å°èªªæ¨¡æ…‹ -->
    <div id="novelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="novelModalTitle">æ–°å¢å°èªª</h3>
                <span class="close" onclick="closeModal('novelModal')">&times;</span>
            </div>
            <form id="novelForm">
                <div class="input-group">
                    <label for="novelTitle">æ¨™é¡Œï¼š</label>
                    <input type="text" id="novelTitle" required>
                </div>
                <div class="input-group">
                    <label for="novelPrompt">ä½¿ç”¨çš„æç¤ºè©ï¼š</label>
                    <textarea id="novelPrompt"></textarea>
                </div>
                <div class="input-group">
                    <label for="novelContent">å°èªªå…§å®¹ï¼š</label>
                    <textarea id="novelContent" style="min-height: 200px;"></textarea>
                </div>
                <div class="input-group">
                    <label for="novelNotes">å‚™è¨»/è©•åƒ¹ï¼š</label>
                    <textarea id="novelNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('novelModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // è³‡æ–™å„²å­˜
        let data = {
            characters: [],
            backgrounds: [],
            secrets: [],
            novels: []
        };

        let editingId = null;
        let currentEditType = null;

        // é è¨­å¯†ç¢¼ï¼ˆä½ å¯ä»¥ä¿®æ”¹ï¼‰
        const PASSWORD = "123456";

        // åˆå§‹åŒ–
        function init() {
            loadData();
            renderAll();
        }

        // ç™»å…¥åŠŸèƒ½
        function login() {
            const password = document.getElementById('password').value;
            if (password === PASSWORD) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                init();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        function logout() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('password').value = '';
        }

        // è³‡æ–™è¼‰å…¥å’Œå„²å­˜
        function loadData() {
            try {
                const saved = localStorage.getItem('novelMaterials');
                if (saved) {
                    data = JSON.parse(saved);
                }
            } catch (e) {
                console.log('è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨é è¨­è³‡æ–™');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('novelMaterials', JSON.stringify(data));
            } catch (e) {
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
            }
        }

        // åˆ†é åˆ‡æ›
        function switchTab(tab) {
            // ç§»é™¤æ‰€æœ‰active class
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            
            // æ·»åŠ active class
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            // å¦‚æœåˆ‡æ›åˆ° AIåŠ©æ‰‹ï¼Œé‡æ–°æ¸²æŸ“é¸æ“‡å™¨
            if (tab === 'aihelper') {
                renderAIHelperSelectors();
            }
        }

        // æ¨¡æ…‹è¦–çª—
        function openModal(modalId, editId = null) {
            editingId = editId;
            currentEditType = modalId.replace('Modal', '').slice(0, -1); // ç§»é™¤Modalå’Œè¤‡æ•¸s
            
            document.getElementById(modalId).style.display = 'block';
            
            if (editId) {
                fillEditForm(modalId, editId);
            } else {
                clearForm(modalId);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            editingId = null;
            currentEditType = null;
        }

        function clearForm(modalId) {
            const form = document.querySelector(`#${modalId} form`);
            form.reset();
            
            // æ›´æ–°æ¨™é¡Œ
            const titleMap = {
                'characterModal': 'æ–°å¢è§’è‰²',
                'backgroundModal': 'æ–°å¢æ•…äº‹èƒŒæ™¯',
                'secretModal': 'æ–°å¢ç§˜å¯†è¨­å®š',
                'novelModal': 'æ–°å¢å°èªª'
            };
            document.querySelector(`#${modalId} h3`).textContent = titleMap[modalId];
        }

        function fillEditForm(modalId, editId) {
            const type = modalId.replace('Modal', '').slice(0, -1);
            const item = data[type + 's'].find(i => i.id === editId);
            
            if (!item) return;
            
            // æ›´æ–°æ¨™é¡Œ
            const titleMap = {
                'characterModal': 'ç·¨è¼¯è§’è‰²',
                'backgroundModal': 'ç·¨è¼¯æ•…äº‹èƒŒæ™¯',
                'secretModal': 'ç·¨è¼¯ç§˜å¯†è¨­å®š',
                'novelModal': 'ç·¨è¼¯å°èªª'
            };
            document.querySelector(`#${modalId} h3`).textContent = titleMap[modalId];
            
            // å¡«å…¥è³‡æ–™
            switch(type) {
                case 'character':
                    document.getElementById('characterName').value = item.name || '';
                    document.getElementById('characterAge').value = item.age || '';
                    document.getElementById('characterAppearance').value = item.appearance || '';
                    document.getElementById('characterPersonality').value = item.personality || '';
                    document.getElementById('characterBackground').value = item.background || '';
                    document.getElementById('characterNotes').value = item.notes || '';
                    break;
                case 'background':
                    document.getElementById('backgroundName').value = item.name || '';
                    document.getElementById('backgroundType').value = item.type || '';
                    document.getElementById('backgroundDescription').value = item.description || '';
                    document.getElementById('backgroundRules').value = item.rules || '';
                    document.getElementById('backgroundNotes').value = item.notes || '';
                    break;
                case 'secret':
                    document.getElementById('secretTitle').value = item.title || '';
                    document.getElementById('secretCategory').value = item.category || '';
                    document.getElementById('secretContent').value = item.content || '';
                    document.getElementById('secretImpact').value = item.impact || '';
                    break;
                case 'novel':
                    document.getElementById('novelTitle').value = item.title || '';
                    document.getElementById('novelPrompt').value = item.prompt || '';
                    document.getElementById('novelContent').value = item.content || '';
                    document.getElementById('novelNotes').value = item.notes || '';
                    break;
            }
        }

        // è¡¨å–®æäº¤
        document.getElementById('characterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveCharacter();
        });

        document.getElementById('backgroundForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveBackground();
        });

        document.getElementById('secretForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSecret();
        });

        document.getElementById('novelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveNovel();
        });

        function saveCharacter() {
            const character = {
                id: editingId || Date.now(),
                name: document.getElementById('characterName').value,
                age: document.getElementById('characterAge').value,
                appearance: document.getElementById('characterAppearance').value,
                personality: document.getElementById('characterPersonality').value,
                background: document.getElementById('characterBackground').value,
                notes: document.getElementById('characterNotes').value,
                createdAt: editingId ? data.characters.find(c => c.id === editingId).createdAt : new Date().toLocaleString(),
                updatedAt: new Date().toLocaleString()
            };

            if (editingId) {
                const index = data.characters.findIndex(c => c.id === editingId);
                data.characters[index] = character;
            } else {
                data.characters.push(character);
            }

            saveData();
            renderCharacters();
            closeModal('characterModal');
        }

        function saveBackground() {
            const background = {
                id: editingId || Date.now(),
                name: document.getElementById('backgroundName').value,
                type: document.getElementById('backgroundType').value,
                description: document.getElementById('backgroundDescription').value,
                rules: document.getElementById('backgroundRules').value,
                notes: document.getElementById('backgroundNotes').value,
                createdAt: editingId ? data.backgrounds.find(b => b.id === editingId).createdAt : new Date().toLocaleString(),
                updatedAt: new Date().toLocaleString()
            };

            if (editingId) {
                const index = data.backgrounds.findIndex(b => b.id === editingId);
                data.backgrounds[index] = background;
            } else {
                data.backgrounds.push(background);
            }

            saveData();
            renderBackgrounds();
            closeModal('backgroundModal');
        }

        function saveSecret() {
            const secret = {
                id: editingId || Date.now(),
                title: document.getElementById('secretTitle').value,
                category: document.getElementById('secretCategory').value,
                content: document.getElementById('secretContent').value,
                impact: document.getElementById('secretImpact').value,
                createdAt: editingId ? data.secrets.find(s => s.id === editingId).createdAt : new Date().toLocaleString(),
                updatedAt: new Date().toLocaleString()
            };

            if (editingId) {
                const index = data.secrets.findIndex(s => s.id === editingId);
                data.secrets[index] = secret;
            } else {
                data.secrets.push(secret);
            }

            saveData();
            renderSecrets();
            closeModal('secretModal');
        }

        function saveNovel() {
            const novel = {
                id: editingId || Date.now(),
                title: document.getElementById('novelTitle').value,
                prompt: document.getElementById('novelPrompt').value,
                content: document.getElementById('novelContent').value,
                notes: document.getElementById('novelNotes').value,
                createdAt: editingId ? data.novels.find(n => n.id === editingId).createdAt : new Date().toLocaleString(),
                updatedAt: new Date().toLocaleString()
            };

            if (editingId) {
                const index = data.novels.findIndex(n => n.id === editingId);
                data.novels[index] = novel;
            } else {
                data.novels.push(novel);
            }

            saveData();
            renderNovels();
            closeModal('novelModal');
        }

        // åˆªé™¤åŠŸèƒ½
        function deleteItem(type, id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) {
                const index = data[type].findIndex(item => item.id === id);
                if (index > -1) {
                    data[type].splice(index, 1);
                    saveData();
                    renderAll();
                }
            }
        }

        // æ¸²æŸ“åŠŸèƒ½
        function renderAll() {
            renderCharacters();
            renderBackgrounds();
            renderSecrets();
            renderNovels();
            renderAIHelperSelectors();
        }

        function renderCharacters() {
            const container = document.getElementById('charactersList');
            container.innerHTML = '';

            data.characters.forEach(character => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">${character.name}</div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="openModal('characterModal', ${character.id})">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('characters', ${character.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="item-content">
                        ${character.age ? `<strong>å¹´é½¡ï¼š</strong>${character.age}<br>` : ''}
                        ${character.appearance ? `<strong>å¤–è²Œï¼š</strong>${character.appearance}<br>` : ''}
                        ${character.personality ? `<strong>æ€§æ ¼ï¼š</strong>${character.personality}<br>` : ''}
                        ${character.background ? `<strong>èƒŒæ™¯ï¼š</strong>${character.background.substring(0, 100)}${character.background.length > 100 ? '...' : ''}<br>` : ''}
                        ${character.notes ? `<strong>å‚™è¨»ï¼š</strong>${character.notes.substring(0, 100)}${character.notes.length > 100 ? '...' : ''}` : ''}
                    </div>
                    <div class="item-meta">
                        å»ºç«‹ï¼š${character.createdAt} | æ›´æ–°ï¼š${character.updatedAt}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderBackgrounds() {
            const container = document.getElementById('backgroundsList');
            container.innerHTML = '';

            data.backgrounds.forEach(background => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">${background.name} <span style="font-size: 14px; color: #718096;">[${background.type}]</span></div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="openModal('backgroundModal', ${background.id})">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('backgrounds', ${background.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="item-content">
                        ${background.description ? `<strong>æè¿°ï¼š</strong>${background.description.substring(0, 150)}${background.description.length > 150 ? '...' : ''}<br>` : ''}
                        ${background.rules ? `<strong>è¦å‰‡ï¼š</strong>${background.rules.substring(0, 100)}${background.rules.length > 100 ? '...' : ''}<br>` : ''}
                        ${background.notes ? `<strong>å‚™è¨»ï¼š</strong>${background.notes.substring(0, 100)}${background.notes.length > 100 ? '...' : ''}` : ''}
                    </div>
                    <div class="item-meta">
                        å»ºç«‹ï¼š${background.createdAt} | æ›´æ–°ï¼š${background.updatedAt}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderSecrets() {
            const container = document.getElementById('secretsList');
            container.innerHTML = '';

            data.secrets.forEach(secret => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">ğŸ” ${secret.title} <span style="font-size: 14px; color: #718096;">[${secret.category}]</span></div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="openModal('secretModal', ${secret.id})">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('secrets', ${secret.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="item-content">
                        ${secret.content ? `<strong>å…§å®¹ï¼š</strong>${secret.content.substring(0, 150)}${secret.content.length > 150 ? '...' : ''}<br>` : ''}
                        ${secret.impact ? `<strong>å½±éŸ¿ï¼š</strong>${secret.impact.substring(0, 100)}${secret.impact.length > 100 ? '...' : ''}` : ''}
                    </div>
                    <div class="item-meta">
                        å»ºç«‹ï¼š${secret.createdAt} | æ›´æ–°ï¼š${secret.updatedAt}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderNovels() {
            const container = document.getElementById('novelsList');
            container.innerHTML = '';

            data.novels.forEach(novel => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">ğŸ“– ${novel.title}</div>
                        <div class="item-actions">
                            <button class="btn btn-small" onclick="openModal('novelModal', ${novel.id})">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="deleteItem('novels', ${novel.id})">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="item-content">
                        ${novel.prompt ? `<strong>æç¤ºè©ï¼š</strong>${novel.prompt.substring(0, 100)}${novel.prompt.length > 100 ? '...' : ''}<br>` : ''}
                        ${novel.content ? `<strong>å…§å®¹ï¼š</strong>${novel.content.substring(0, 200)}${novel.content.length > 200 ? '...' : ''}<br>` : ''}
                        ${novel.notes ? `<strong>å‚™è¨»ï¼š</strong>${novel.notes.substring(0, 100)}${novel.notes.length > 100 ? '...' : ''}` : ''}
                    </div>
                    <div class="item-meta">
                        å»ºç«‹ï¼š${novel.createdAt} | æ›´æ–°ï¼š${novel.updatedAt}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // æœå°‹åŠŸèƒ½
        function searchItems(type) {
            const searchInput = document.getElementById(type.slice(0, -1) + 'Search');
            const searchTerm = searchInput.value.toLowerCase();
            const cards = document.querySelectorAll(`#${type}List .item-card`);
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function exportForAI() {
            const exportData = {
                è§’è‰²è¨­å®š: data.characters.map(c => ({
                    åç¨±: c.name,
                    å¹´é½¡: c.age,
                    å¤–è²Œ: c.appearance,
                    æ€§æ ¼: c.personality,
                    èƒŒæ™¯: c.background,
                    å‚™è¨»: c.notes
                })),
                æ•…äº‹èƒŒæ™¯: data.backgrounds.map(b => ({
                    åç¨±: b.name,
                    é¡å‹: b.type,
                    æè¿°: b.description,
                    è¦å‰‡: b.rules,
                    å‚™è¨»: b.notes
                }))
            };

            const text = "=== å°èªªç´ æåº« ===\n\n" + JSON.stringify(exportData, null, 2);
            
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼å¯ä»¥ç›´æ¥è²¼çµ¦AIä½¿ç”¨');
            }).catch(() => {
                // å¦‚æœå‰ªè²¼ç°¿APIå¤±æ•—ï¼Œé¡¯ç¤ºåœ¨æ–°è¦–çª—
                const newWindow = window.open();
                newWindow.document.write(`<pre>${text}</pre>`);
            });
        }

        function exportAll() {
            const text = "=== å®Œæ•´å°èªªç´ æåº« ===\n\n" + JSON.stringify(data, null, 2);
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'å°èªªç´ æåº«_' + new Date().toISOString().split('T')[0] + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // é—œé–‰æ‰€æœ‰æ¨¡æ…‹è¦–çª—
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // é»æ“Šæ¨¡æ…‹èƒŒæ™¯é—œé–‰
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // åˆå§‹è¼‰å…¥
        window.addEventListener('load', function() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn === 'true') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                init();
            }
        });

        // ä¿®æ”¹ç™»å…¥å‡½æ•¸ä»¥è¨˜ä½ç™»å…¥ç‹€æ…‹
        function login() {
            const password = document.getElementById('password').value;
            if (password === PASSWORD) {
                localStorage.setItem('isLoggedIn', 'true');
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                init();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        // ä¿®æ”¹ç™»å‡ºå‡½æ•¸
        function logout() {
            localStorage.removeItem('isLoggedIn');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('password').value = '';
        }

        // AIåŠ©æ‰‹ç›¸é—œåŠŸèƒ½
        const promptTemplates = {
            story: {
                name: "å‰µä½œæ•…äº‹",
                description: "æ ¹æ“šä½ çš„ç´ æå‰µä½œä¸€å€‹å®Œæ•´çš„æ•…äº‹",
                template: "è«‹æ ¹æ“šä»¥ä¸‹å°èªªç´ æï¼Œå‰µä½œä¸€å€‹å¼•äººå…¥å‹çš„æ•…äº‹ã€‚è«‹æ³¨æ„è§’è‰²æ€§æ ¼çš„ä¸€è‡´æ€§å’Œä¸–ç•Œè§€çš„é‚è¼¯æ€§ã€‚\n\nç´ æè³‡æ–™ï¼š\n{materials}\n\nè«‹å‰µä½œï¼š\n1. ä¸€å€‹å®Œæ•´çš„æ•…äº‹æƒ…ç¯€\n2. ç”Ÿå‹•çš„è§’è‰²äº’å‹•\n3. è±å¯Œçš„å ´æ™¯æè¿°\n4. ç¬¦åˆè¨­å®šçš„å°è©±"
            },
            dialogue: {
                name: "å¯«å°è©±",
                description: "å‰µä½œè§’è‰²ä¹‹é–“çš„å°è©±",
                template: "è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è¨­å®šï¼Œå‰µä½œä»–å€‘ä¹‹é–“çš„å°è©±ã€‚è«‹ç¢ºä¿å°è©±ç¬¦åˆæ¯å€‹è§’è‰²çš„æ€§æ ¼ç‰¹é»ã€‚\n\nè§’è‰²è³‡æ–™ï¼š\n{materials}\n\nè«‹å‰µä½œï¼š\n1. ç¬¦åˆè§’è‰²æ€§æ ¼çš„å°è©±\n2. æ¨é€²åŠ‡æƒ…çš„å°è©±å…§å®¹\n3. è‡ªç„¶æµæš¢çš„å°è©±ç¯€å¥\n4. é©ç•¶çš„å‹•ä½œå’Œå¿ƒç†æè¿°"
            },
            scene: {
                name: "å ´æ™¯æè¿°",
                description: "è©³ç´°æè¿°æ•…äº‹å ´æ™¯",
                template: "è«‹æ ¹æ“šä»¥ä¸‹èƒŒæ™¯è¨­å®šï¼Œå‰µä½œè©³ç´°çš„å ´æ™¯æè¿°ã€‚\n\nèƒŒæ™¯è³‡æ–™ï¼š\n{materials}\n\nè«‹æè¿°ï¼š\n1. ç’°å¢ƒçš„è¦–è¦ºç´°ç¯€\n2. æ°›åœå’Œæƒ…èª¿\n3. æ„Ÿå®˜é«”é©—ï¼ˆè²éŸ³ã€æ°£å‘³ã€è§¸è¦ºç­‰ï¼‰\n4. è§’è‰²åœ¨æ­¤ç’°å¢ƒä¸­çš„æ„Ÿå—"
            },
            character_development: {
                name: "è§’è‰²ç™¼å±•",
                description: "æ·±å…¥åˆ†æå’Œç™¼å±•è§’è‰²",
                template: "è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è¨­å®šï¼Œé€²ä¸€æ­¥ç™¼å±•é€™å€‹è§’è‰²ã€‚\n\nè§’è‰²è³‡æ–™ï¼š\n{materials}\n\nè«‹æä¾›ï¼š\n1. è§’è‰²çš„æ·±å±¤å‹•æ©Ÿå’Œç›®æ¨™\n2. è§’è‰²çš„æˆé•·è»Œè·¡\n3. è§’è‰²çš„å…§å¿ƒè¡çª\n4. è§’è‰²é—œä¿‚çš„ç™¼å±•å¯èƒ½æ€§"
            },
            plot_analysis: {
                name: "åŠ‡æƒ…åˆ†æ",
                description: "åˆ†æåŠ‡æƒ…çµæ§‹å’Œç™¼å±•",
                template: "è«‹æ ¹æ“šä»¥ä¸‹ç´ æï¼Œåˆ†æå¯èƒ½çš„åŠ‡æƒ…ç™¼å±•ã€‚\n\nç´ æè³‡æ–™ï¼š\n{materials}\n\nè«‹åˆ†æï¼š\n1. ä¸»è¦è¡çªé»\n2. åŠ‡æƒ…è½‰æŠ˜çš„å¯èƒ½æ€§\n3. è§’è‰²é—œä¿‚çš„ç™¼å±•\n4. å¯èƒ½çš„çµå±€æ–¹å‘"
            },
            custom: {
                name: "è‡ªè¨‚æç¤ºè©",
                description: "è‡ªè¨‚ä½ çš„æç¤ºè©å…§å®¹",
                template: ""
            }
        };

        function renderAIHelperSelectors() {
            // æ¸²æŸ“è§’è‰²é¸æ“‡å™¨
            const characterSelector = document.getElementById('characterSelector');
            characterSelector.innerHTML = '';
            
            if (data.characters.length === 0) {
                characterSelector.innerHTML = '<p style="color: #718096;">é‚„æ²’æœ‰è§’è‰²è³‡æ–™</p>';
            } else {
                data.characters.forEach(character => {
                    const item = document.createElement('div');
                    item.innerHTML = `
                        <label style="display: block; margin-bottom: 5px;">
                            <input type="checkbox" value="${character.id}" class="character-checkbox"> 
                            ${character.name}${character.age ? ` (${character.age})` : ''}
                        </label>
                    `;
                    characterSelector.appendChild(item);
                });
            }

            // æ¸²æŸ“èƒŒæ™¯é¸æ“‡å™¨
            const backgroundSelector = document.getElementById('backgroundSelector');
            backgroundSelector.innerHTML = '';
            
            if (data.backgrounds.length === 0) {
                backgroundSelector.innerHTML = '<p style="color: #718096;">é‚„æ²’æœ‰èƒŒæ™¯è³‡æ–™</p>';
            } else {
                data.backgrounds.forEach(background => {
                    const item = document.createElement('div');
                    item.innerHTML = `
                        <label style="display: block; margin-bottom: 5px;">
                            <input type="checkbox" value="${background.id}" class="background-checkbox"> 
                            ${background.name} [${background.type}]
                        </label>
                    `;
                    backgroundSelector.appendChild(item);
                });
            }
        }

        function updatePrompt() {
            const template = document.getElementById('promptTemplate').value;
            const description = document.getElementById('templateDescription');
            description.textContent = promptTemplates[template].description;
        }

        function generatePrompt() {
            const template = document.getElementById('promptTemplate').value;
            const includeSecrets = document.getElementById('includeSecrets').checked;
            
            // æ”¶é›†é¸ä¸­çš„ç´ æ
            const selectedCharacters = Array.from(document.querySelectorAll('.character-checkbox:checked'))
                .map(cb => data.characters.find(c => c.id == cb.value));
            
            const selectedBackgrounds = Array.from(document.querySelectorAll('.background-checkbox:checked'))
                .map(cb => data.backgrounds.find(b => b.id == cb.value));
            
            const selectedSecrets = includeSecrets ? data.secrets : [];

            // çµ„ç¹”ç´ ææ–‡å­—
            let materialsText = '';
            
            if (selectedCharacters.length > 0) {
                materialsText += 'ã€è§’è‰²è¨­å®šã€‘\n';
                selectedCharacters.forEach(char => {
                    materialsText += `${char.name}ï¼š\n`;
                    if (char.age) materialsText += `- å¹´é½¡ï¼š${char.age}\n`;
                    if (char.appearance) materialsText += `- å¤–è²Œï¼š${char.appearance}\n`;
                    if (char.personality) materialsText += `- æ€§æ ¼ï¼š${char.personality}\n`;
                    if (char.background) materialsText += `- èƒŒæ™¯ï¼š${char.background}\n`;
                    if (char.notes) materialsText += `- å‚™è¨»ï¼š${char.notes}\n`;
                    materialsText += '\n';
                });
            }

            if (selectedBackgrounds.length > 0) {
                materialsText += 'ã€æ•…äº‹èƒŒæ™¯ã€‘\n';
                selectedBackgrounds.forEach(bg => {
                    materialsText += `${bg.name} [${bg.type}]ï¼š\n`;
                    if (bg.description) materialsText += `- æè¿°ï¼š${bg.description}\n`;
                    if (bg.rules) materialsText += `- è¦å‰‡ï¼š${bg.rules}\n`;
                    if (bg.notes) materialsText += `- å‚™è¨»ï¼š${bg.notes}\n`;
                    materialsText += '\n';
                });
            }

            if (selectedSecrets.length > 0) {
                materialsText += 'ã€ç§˜å¯†è¨­å®šã€‘\n';
                selectedSecrets.forEach(secret => {
                    materialsText += `${secret.title} [${secret.category}]ï¼š\n`;
                    if (secret.content) materialsText += `- å…§å®¹ï¼š${secret.content}\n`;
                    if (secret.impact) materialsText += `- å½±éŸ¿ï¼š${secret.impact}\n`;
                    materialsText += '\n';
                });
            }

            if (!materialsText) {
                materialsText = 'ï¼ˆè«‹å…ˆé¸æ“‡ä¸€äº›ç´ æï¼‰';
            }

            // ç”Ÿæˆæœ€çµ‚æç¤ºè©
            let finalPrompt = '';
            if (template === 'custom') {
                finalPrompt = `è«‹æ ¹æ“šä»¥ä¸‹å°èªªç´ æé€²è¡Œå‰µä½œï¼š\n\n${materialsText}\n\nè«‹åœ¨é€™è£¡è¼¸å…¥ä½ çš„è‡ªè¨‚è¦æ±‚...`;
            } else {
                finalPrompt = promptTemplates[template].template.replace('{materials}', materialsText);
            }

            document.getElementById('generatedPrompt').value = finalPrompt;
        }

        function copyPrompt() {
            const prompt = document.getElementById('generatedPrompt').value;
            if (!prompt.trim()) {
                alert('è«‹å…ˆç”Ÿæˆæç¤ºè©ï¼');
                return;
            }

            navigator.clipboard.writeText(prompt).then(() => {
                alert('âœ… æç¤ºè©å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }).catch(() => {
                // å‚™ç”¨æ–¹æ¡ˆ
                const textarea = document.getElementById('generatedPrompt');
                textarea.select();
                document.execCommand('copy');
                alert('âœ… æç¤ºè©å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }

        function sendToPerplexity() {
            const prompt = document.getElementById('generatedPrompt').value;
            if (!prompt.trim()) {
                alert('è«‹å…ˆç”Ÿæˆæç¤ºè©ï¼');
                return;
            }

            // ä½¿ç”¨ URL åƒæ•¸ç™¼é€åˆ° Perplexity
            const perplexityUrl = `https://www.perplexity.ai/?q=${encodeURIComponent(prompt)}`;
            window.open(perplexityUrl, '_blank');
        }

        function quickPrompt(type) {
            const quickTemplates = {
                brainstorm: `è«‹æ ¹æ“šæˆ‘çš„å°èªªç´ æï¼Œæä¾›5å€‹å‰µæ„åŠ‡æƒ…ç™¼å±•æ–¹å‘ï¼š\n\nã€ç¾æœ‰ç´ æã€‘\n{allMaterials}\n\nè«‹çµ¦æˆ‘ï¼š\n1. æ„æƒ³ä¸åˆ°çš„åŠ‡æƒ…è½‰æŠ˜\n2. è§’è‰²é—œä¿‚çš„æ–°ç™¼å±•\n3. è¡çªå‡ç´šçš„å¯èƒ½\n4. æƒ…æ„Ÿç·šçš„ç™¼å±•\n5. ä¸–ç•Œè§€çš„æ“´å±•`,
                
                character_chat: `è®“æˆ‘çš„è§’è‰²é€²è¡Œä¸€å ´å°è©±ï¼Œå±•ç¾ä»–å€‘çš„æ€§æ ¼ç‰¹é»ï¼š\n\nã€è§’è‰²è³‡æ–™ã€‘\n{characters}\n\nè«‹å‰µä½œä¸€æ®µå°è©±ï¼Œè¦æ±‚ï¼š\n1. é«”ç¾æ¯å€‹è§’è‰²çš„ç¨ç‰¹æ€§æ ¼\n2. åŒ…å«é©ç•¶çš„è¡çªæˆ–äº’å‹•\n3. æ¨é€²åŠ‡æƒ…ç™¼å±•\n4. è‡ªç„¶æµæš¢çš„å°è©±ç¯€å¥`,
                
                world_expand: `è«‹å¹«æˆ‘æ“´å±•å°èªªçš„ä¸–ç•Œè§€è¨­å®šï¼š\n\nã€ç¾æœ‰èƒŒæ™¯ã€‘\n{backgrounds}\n\nè«‹æä¾›ï¼š\n1. æ›´è©³ç´°çš„ç’°å¢ƒæè¿°\n2. ç¤¾æœƒçµæ§‹å’Œè¦å‰‡\n3. æ­·å²èƒŒæ™¯\n4. æ–‡åŒ–ç‰¹è‰²\n5. å¯èƒ½çš„æ–°å ´æ™¯`,
                
                plot_twist: `è«‹ç‚ºæˆ‘çš„æ•…äº‹è¨­è¨ˆåŠ‡æƒ…è½‰æŠ˜ï¼š\n\nã€ç´ æè³‡æ–™ã€‘\n{allMaterials}\n\nè«‹è¨­è¨ˆï¼š\n1. æ„å¤–çš„çœŸç›¸æ­éœ²\n2. è§’è‰²èº«ä»½çš„åè½‰\n3. éš±è—ä¿¡æ¯çš„æ›å…‰\n4. æ–°å¨è„…çš„å‡ºç¾\n5. é—œä¿‚çš„é‡å¤§è®ŠåŒ–`
            };

            // çµ„ç¹”æ‰€æœ‰ç´ æ
            let allMaterials = '';
            let charactersOnly = '';
            let backgroundsOnly = '';

            if (data.characters.length > 0) {
                charactersOnly += 'ã€è§’è‰²ã€‘\n';
                allMaterials += 'ã€è§’è‰²ã€‘\n';
                data.characters.forEach(char => {
                    const charText = `${char.name}ï¼š${char.personality || ''}${char.background ? ` - ${char.background}` : ''}\n`;
                    charactersOnly += charText;
                    allMaterials += charText;
                });
            }

            if (data.backgrounds.length > 0) {
                backgroundsOnly += 'ã€èƒŒæ™¯ã€‘\n';
                allMaterials += '\nã€èƒŒæ™¯ã€‘\n';
                data.backgrounds.forEach(bg => {
                    const bgText = `${bg.name}ï¼š${bg.description || ''}\n`;
                    backgroundsOnly += bgText;
                    allMaterials += bgText;
                });
            }

            if (data.secrets.length > 0) {
                allMaterials += '\nã€ç§˜å¯†è¨­å®šã€‘\n';
                data.secrets.forEach(secret => {
                    allMaterials += `${secret.title}ï¼š${secret.content || ''}\n`;
                });
            }

            let template = quickTemplates[type];
            template = template.replace('{allMaterials}', allMaterials || 'ï¼ˆæš«ç„¡ç´ æï¼‰');
            template = template.replace('{characters}', charactersOnly || 'ï¼ˆæš«ç„¡è§’è‰²ï¼‰');
            template = template.replace('{backgrounds}', backgroundsOnly || 'ï¼ˆæš«ç„¡èƒŒæ™¯ï¼‰');

            document.getElementById('generatedPrompt').value = template;
        }
    </script>
</body>
</html>
