<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èªªç´ æåº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ç™»å…¥é é¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 350px;
        }

        .login-box h1 {
            margin-bottom: 30px;
            color: #667eea;
            font-size: 2.5em;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-box button:hover {
            background: #5a67d8;
        }

        /* ä¸»æ‡‰ç”¨ç¨‹å¼ */
        .app-container {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* é é¢æ¨£å¼ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .page-title {
            font-size: 1.5em;
            color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        /* æœå°‹å’Œç¯©é¸ */
        .search-filter {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 200px;
        }

        .tag {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .tag:hover {
            background: #bbdefb;
            color: #0d47a1;
        }
        
        .tag.selected {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }


        /* è³‡æ–™å¡ç‰‡ */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .data-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .data-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .card-actions {
            display: flex;
            gap: 5px;
        }

        .card-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .card-content {
            margin-bottom: 15px;
            color: #666;
            line-height: 1.5;
        }

        .card-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .large-textarea {
            min-height: 300px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-col {
            flex: 1;
        }

        /* æ¨™ç±¤é¸æ“‡å™¨ */
        .tag-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag-option {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .tag-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        /* çµ±è¨ˆé¢æ¿ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        /* AIåŠ©æ‰‹ */
        .ai-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .material-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .material-category {
            margin-bottom: 20px;
        }

        .material-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .material-item {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .material-item.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .prompt-template {
            margin-bottom: 20px;
        }

        .template-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .auto-resize-textarea {
            min-height: 200px;
            resize: none;
            overflow: hidden;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .content-area {
                order: 1;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            .search-row {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        /* éš±è—é¡åˆ¥ */
        .hidden {
            display: none !important;
        }

        /* è­¦å‘Šæç¤º */
        .spoiler-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>ğŸ“š å°èªªç´ æåº«</h1>
            <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
            <button onclick="login()">ç™»å…¥</button>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <div id="appContainer" class="container app-container">
        <div class="header">
            <h1>ğŸ“š å°èªªç´ æåº«</h1>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>

        <div class="main-content">
            <!-- å´é‚Šå°èˆª -->
            <div class="sidebar">
                <div class="nav-item active" data-page="dashboard">
                    ğŸ“Š ä¸»æ§å°
                </div>
                <div class="nav-item" data-page="characters">
                    ğŸ‘¤ è§’è‰²è¨­å®š
                </div>
                <div class="nav-item" data-page="backgrounds">
                    ğŸŒ æ•…äº‹èƒŒæ™¯
                </div>
                <div class="nav-item" data-page="secrets">
                    ğŸ” ç§˜å¯†è¨­å®š
                </div>
                <div class="nav-item" data-page="novels">
                    ğŸ“– å·²ç”Ÿæˆå°èªª
                </div>
                <div class="nav-item" data-page="ai-assistant">
                    ğŸ¤– AIå‰µä½œåŠ©æ‰‹
                </div>
                <div class="nav-item" data-page="settings">
                    âš™ï¸ è¨­å®š/å‚™ä»½
                </div>
            </div>

            <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
            <div class="content-area">
                <!-- ä¸»æ§å° -->
                <div id="dashboard" class="page active">
                    <div class="page-header">
                        <h2 class="page-title">ğŸ“Š ä¸»æ§å°</h2>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="characterCount">0</div>
                            <div class="stat-label">è§’è‰²è¨­å®š</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="backgroundCount">0</div>
                            <div class="stat-label">æ•…äº‹èƒŒæ™¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="secretCount">0</div>
                            <div class="stat-label">ç§˜å¯†è¨­å®š</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="novelCount">0</div>
                            <div class="stat-label">å·²ç”Ÿæˆå°èªª</div>
                        </div>
                    </div>

                    <div class="recent-activity">
                        <h3>æœ€è¿‘æ´»å‹•</h3>
                        <div id="recentItems" class="data-grid">
                            <!-- æœ€è¿‘é …ç›®å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                </div>

                <!-- è§’è‰²è¨­å®šé é¢ -->
                <div id="characters" class="page">
                    <div class="page-header">
                        <h2 class="page-title">ğŸ‘¤ è§’è‰²è¨­å®š</h2>
                        <button class="btn btn-primary" onclick="showCharacterForm()">æ–°å¢è§’è‰²</button>
                    </div>

                    <div class="search-filter">
                        <div class="search-row">
                            <input type="text" class="search-input" id="characterSearch" placeholder="æœå°‹è§’è‰²..." />
                            <button class="btn btn-secondary" onclick="searchCharacters()">æœå°‹</button>
                        </div>
                        <div class="tag-filter" id="characterTagFilter">
                            <!-- æ¨™ç±¤ç¯©é¸å™¨å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div id="characterList" class="data-grid">
                        <!-- è§’è‰²å¡ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>

                <!-- æ•…äº‹èƒŒæ™¯é é¢ -->
                <div id="backgrounds" class="page">
                    <div class="page-header">
                        <h2 class="page-title">ğŸŒ æ•…äº‹èƒŒæ™¯</h2>
                        <button class="btn btn-primary" onclick="showBackgroundForm()">æ–°å¢èƒŒæ™¯</button>
                    </div>

                    <div class="search-filter">
                        <div class="search-row">
                            <input type="text" class="search-input" id="backgroundSearch" placeholder="æœå°‹èƒŒæ™¯..." />
                            <button class="btn btn-secondary" onclick="searchBackgrounds()">æœå°‹</button>
                        </div>
                        <div class="tag-filter" id="backgroundTagFilter">
                            <!-- æ¨™ç±¤ç¯©é¸å™¨å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div id="backgroundList" class="data-grid">
                        <!-- èƒŒæ™¯å¡ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>

                <!-- ç§˜å¯†è¨­å®šé é¢ -->
                <div id="secrets" class="page">
                    <div class="page-header">
                        <h2 class="page-title">ğŸ” ç§˜å¯†è¨­å®š</h2>
                        <button class="btn btn-primary" onclick="showSecretForm()">æ–°å¢ç§˜å¯†</button>
                    </div>

                    <div class="search-filter">
                        <div class="search-row">
                            <input type="text" class="search-input" id="secretSearch" placeholder="æœå°‹ç§˜å¯†è¨­å®š..." />
                            <button class="btn btn-secondary" onclick="searchSecrets()">æœå°‹</button>
                        </div>
                        <div class="tag-filter" id="secretTagFilter">
                            <!-- æ¨™ç±¤ç¯©é¸å™¨å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div id="secretList" class="data-grid">
                        <!-- ç§˜å¯†è¨­å®šå¡ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>

                <!-- å·²ç”Ÿæˆå°èªªé é¢ -->
                <div id="novels" class="page">
                    <div class="page-header">
                        <h2 class="page-title">ğŸ“– å·²ç”Ÿæˆå°èªª</h2>
                    </div>

                    <div class="search-filter">
                        <div class="search-row">
                            <input type="text" class="search-input" id="novelSearch" placeholder="æœå°‹å°èªª..." />
                            <button class="btn btn-secondary" onclick="searchNovels()">æœå°‹</button>
                            <select id="novelSort" onchange="sortNovels()">
                                <option value="date">æŒ‰æ—¥æœŸæ’åº</option>
                                <option value="title">æŒ‰æ¨™é¡Œæ’åº</option>
                                <option value="length">æŒ‰å­—æ•¸æ’åº</option>
                            </select>
                        </div>
                    </div>

                    <div id="novelList" class="data-grid">
                        <!-- å°èªªå¡ç‰‡å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>

                <!-- AIå‰µä½œåŠ©æ‰‹é é¢ -->
                <div id="ai-assistant" class="page">
                    <div class="page-header">
                        <h2 class="page-title">ğŸ¤– AIå‰µä½œåŠ©æ‰‹</h2>
                    </div>

                    <div class="ai-container">
                        <!-- ç´ æé¸æ“‡å™¨ -->
                        <div class="material-selector">
                            <h3>ğŸ“‹ é¸æ“‡ç´ æ</h3>
                            
                            <div class="material-category">
                                <h4>ğŸ‘¤ è§’è‰²</h4>
                                <div id="aiCharacterList" class="material-list">
                                    <!-- è§’è‰²é¸æ“‡é …ç›® -->
                                </div>
                            </div>

                            <div class="material-category">
                                <h4>ğŸŒ èƒŒæ™¯</h4>
                                <div id="aiBackgroundList" class="material-list">
                                    <!-- èƒŒæ™¯é¸æ“‡é …ç›® -->
                                </div>
                            </div>

                            <div class="material-category">
                                <h4>ğŸ” ç§˜å¯†è¨­å®š</h4>
                                <div id="aiSecretList" class="material-list">
                                    <!-- ç§˜å¯†è¨­å®šé¸æ“‡é …ç›® -->
                                </div>
                            </div>
                        </div>

                        <!-- æ™ºæ…§æ¨¡æ¿ -->
                        <div class="prompt-template">
                            <h3>ğŸ“ æ™ºæ…§æ¨¡æ¿</h3>
                            <div class="template-buttons">
                                <button class="btn btn-secondary" onclick="useTemplate('story')">å®Œæ•´æ•…äº‹</button>
                                <button class="btn btn-secondary" onclick="useTemplate('dialogue')">è§’è‰²å°è©±</button>
                                <button class="btn btn-secondary" onclick="useTemplate('scene')">å ´æ™¯æè¿°</button>
                                <button class="btn btn-secondary" onclick="useTemplate('analysis')">åŠ‡æƒ…åˆ†æ</button>
                                <button class="btn btn-secondary" onclick="useTemplate('dnd')">DNDè§’è‰²</button>
                            </div>
                        </div>

                        <!-- ğŸ†• é¡å¤–è¦æ±‚è¼¸å…¥æ¡† -->
                        <div class="form-group">
                            <label class="form-label">ğŸ’­ é¡å¤–è¦æ±‚</label>
                            <textarea id="additionalRequirements" class="form-textarea auto-resize-textarea" 
                                placeholder="è¼¸å…¥æ‚¨çš„é¡å¤–è¦æ±‚ã€ç‰¹æ®ŠæŒ‡ç¤ºæˆ–å‰µä½œæ–¹å‘..."></textarea>
                        </div>

                        <!-- è‡ªè¨‚æç¤ºè© -->
                        <div class="form-group">
                            <label class="form-label">è‡ªè¨‚æç¤ºè©</label>
                            <textarea id="customPrompt" class="form-textarea auto-resize-textarea" 
                                placeholder="è¼¸å…¥æ‚¨çš„è‡ªè¨‚æç¤ºè©..."></textarea>
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="generatePrompt()">ç”Ÿæˆå®Œæ•´æç¤ºè©</button>
                            <button class="btn btn-success" onclick="sendToPerplexity()">ç™¼é€åˆ° Perplexity</button>
                            <button class="btn btn-secondary" onclick="copyPrompt()">è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
                            <button class="btn btn-secondary" onclick="savePromptTemplate()">å„²å­˜æ¨¡æ¿</button>
                        </div>

                        <!-- æç¤ºè©æ­·å² -->
                        <div style="margin-top: 30px;">
                            <h3>ğŸ“š æç¤ºè©æ­·å²</h3>
                            <div id="promptHistory" class="data-grid">
                                <!-- æ­·å²æç¤ºè© -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¨­å®š/å‚™ä»½é é¢ -->
                <div id="settings" class="page">
                    <div class="page-header">
                        <h2 class="page-title">âš™ï¸ è¨­å®š/å‚™ä»½</h2>
                    </div>

                    <!-- åŸºæœ¬è¨­å®š -->
                    <div style="margin-bottom: 30px;">
                        <h3>ğŸ” åŸºæœ¬è¨­å®š</h3>
                        <div class="form-group">
                            <label class="form-label">ä¿®æ”¹å¯†ç¢¼</label>
                            <input type="password" id="newPassword" class="form-input" placeholder="è¼¸å…¥æ–°å¯†ç¢¼" />
                            <button class="btn btn-primary" onclick="changePassword()" style="margin-top: 10px;">æ›´æ–°å¯†ç¢¼</button>
                        </div>
                    </div>

                    <!-- æ¨¡æ¿è¨­å®š -->
                    <div style="margin-bottom: 30px;">
                        <h3>ğŸ“ é è¨­æ¨¡æ¿è¨­å®š</h3>
                        <div class="form-group">
                            <label class="form-label">å®Œæ•´æ•…äº‹æ¨¡æ¿</label>
                            <textarea id="storyTemplate" class="form-textarea">æ ¹æ“šä»¥ä¸‹ç´ æï¼Œå‰µä½œä¸€å€‹å®Œæ•´çš„æ•…äº‹ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

æ•…äº‹èƒŒæ™¯ï¼š
{backgrounds}

ç§˜å¯†è¨­å®šï¼š
{secrets}

è«‹å‰µä½œä¸€å€‹å¼•äººå…¥å‹çš„æ•…äº‹ï¼Œæ³¨æ„è§’è‰²ç™¼å±•å’ŒåŠ‡æƒ…è½‰æŠ˜ã€‚</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">è§’è‰²å°è©±æ¨¡æ¿</label>
                            <textarea id="dialogueTemplate" class="form-textarea">åŸºæ–¼ä»¥ä¸‹è§’è‰²è¨­å®šï¼Œå‰µä½œä¸€æ®µå°è©±ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

å ´æ™¯èƒŒæ™¯ï¼š
{backgrounds}

è«‹å‰µä½œç¬¦åˆè§’è‰²æ€§æ ¼çš„è‡ªç„¶å°è©±ã€‚</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">å ´æ™¯æè¿°æ¨¡æ¿</label>
                            <textarea id="sceneTemplate" class="form-textarea">æ ¹æ“šä»¥ä¸‹èƒŒæ™¯è¨­å®šï¼Œå‰µä½œè©³ç´°çš„å ´æ™¯æè¿°ï¼š

èƒŒæ™¯è¨­å®šï¼š
{backgrounds}

è«‹å‰µä½œç”Ÿå‹•ç´°ç·»çš„å ´æ™¯æè¿°ã€‚</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">åŠ‡æƒ…åˆ†ææ¨¡æ¿</label>
                            <textarea id="analysisTemplate" class="form-textarea">åˆ†æä»¥ä¸‹æ•…äº‹ç´ æï¼Œæä¾›åŠ‡æƒ…å»ºè­°ï¼š

æ‰€æœ‰ç´ æï¼š
{characters}
{backgrounds}
{secrets}

è«‹åˆ†æé€™äº›ç´ æçš„æ½›åœ¨åŠ‡æƒ…ç™¼å±•å¯èƒ½æ€§ã€‚</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">DNDè§’è‰²æ¨¡æ¿</label>
                            <textarea id="dndTemplate" class="form-textarea">åŸºæ–¼ä»¥ä¸‹è§’è‰²è¨­å®šï¼Œå‰µå»ºä¸€å€‹DNDè§’è‰²ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

è«‹åŒ…å«è·æ¥­ã€ç¨®æ—ã€å±¬æ€§ã€èƒŒæ™¯æ•…äº‹ç­‰å®Œæ•´è³‡è¨Šã€‚</textarea>
                        </div>

                        <button class="btn btn-success" onclick="saveTemplates()">å„²å­˜æ‰€æœ‰æ¨¡æ¿</button>
                    </div>

                    <!-- å‚™ä»½åŠŸèƒ½ -->
                    <div style="margin-bottom: 30px;">
                        <h3>â˜ï¸ è³‡æ–™å‚™ä»½</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="exportData()">åŒ¯å‡ºè³‡æ–™</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">åŒ¯å…¥è³‡æ–™</button>
                            <button class="btn btn-success" onclick="connectGoogleDrive()">é€£æ¥Google Drive</button>
                        </div>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this)" />
                    </div>

                    <!-- Google Drive ç‹€æ…‹ -->
                    <div id="googleDriveStatus" style="margin-top: 20px;">
                        <!-- Google Drive é€£æ¥ç‹€æ…‹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¡¨å–®å½ˆå‡ºå±¤ -->
    <div id="formOverlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;">
            <div id="formContent">
                <!-- å‹•æ…‹è¡¨å–®å…§å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentUser = null;
        let currentPage = 'dashboard';
        let appData = {
            characters: [],
            backgrounds: [],
            secrets: [],
            novels: [],
            promptHistory: [],
            settings: {
                password: '1234',
                templates: {}
            }
        };

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        function initApp() {
            loadData();
            checkLogin();
            initEventListeners();
            loadTemplates();
        }

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkLogin() {
            const savedLogin = localStorage.getItem('novelLibraryLogin');
            if (savedLogin) {
                showApp();
            } else {
                showLogin();
            }
        }

        // ç™»å…¥åŠŸèƒ½
        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === appData.settings.password) {
                localStorage.setItem('novelLibraryLogin', 'true');
                showApp();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            localStorage.removeItem('novelLibraryLogin');
            showLogin();
        }

        // é¡¯ç¤ºç™»å…¥é é¢
        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        // é¡¯ç¤ºä¸»æ‡‰ç”¨ç¨‹å¼
        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            updateDashboard();
            renderAllPages();
        }

        // è¼‰å…¥è³‡æ–™
        function loadData() {
            const savedData = localStorage.getItem('novelLibraryData');
            if (savedData) {
                appData = { ...appData, ...JSON.parse(savedData) };
            }
        }

        // å„²å­˜è³‡æ–™
        function saveData() {
            localStorage.setItem('novelLibraryData', JSON.stringify(appData));
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
        function initEventListeners() {
            // å°èˆªé»æ“Š
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    switchPage(page);
                });
            });

            // è‡ªå‹•èª¿æ•´æ–‡å­—æ¡†å¤§å°
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('auto-resize-textarea')) {
                    autoResizeTextarea(e.target);
                }
            });

            // æŒ‰Enteréµæœå°‹
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('search-input')) {
                    const page = getCurrentPage();
                    if (page === 'characters') searchCharacters();
                    else if (page === 'backgrounds') searchBackgrounds();
                    else if (page === 'secrets') searchSecrets();
                    else if (page === 'novels') searchNovels();
                }
            });
        }

        // é é¢åˆ‡æ›
        function switchPage(page) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // é¡¯ç¤ºç›®æ¨™é é¢
            document.getElementById(page).classList.add('active');
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            currentPage = page;

            // æ›´æ–°é é¢å…§å®¹
            if (page === 'dashboard') updateDashboard();
            else if (page === 'characters') renderCharacters();
            else if (page === 'backgrounds') renderBackgrounds();
            else if (page === 'secrets') renderSecrets();
            else if (page === 'novels') renderNovels();
            else if (page === 'ai-assistant') renderAIAssistant();
        }

        // å–å¾—ç•¶å‰é é¢
        function getCurrentPage() {
            return currentPage;
        }

        // æ›´æ–°ä¸»æ§å°
        function updateDashboard() {
            document.getElementById('characterCount').textContent = appData.characters.length;
            document.getElementById('backgroundCount').textContent = appData.backgrounds.length;
            document.getElementById('secretCount').textContent = appData.secrets.length;
            document.getElementById('novelCount').textContent = appData.novels.length;

            // é¡¯ç¤ºæœ€è¿‘é …ç›®
            const recentItems = [
                ...appData.characters.map(item => ({ ...item, type: 'character' })),
                ...appData.backgrounds.map(item => ({ ...item, type: 'background' })),
                ...appData.secrets.map(item => ({ ...item, type: 'secret' })),
                ...appData.novels.map(item => ({ ...item, type: 'novel' }))
            ].sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt))
             .slice(0, 6);

            const recentContainer = document.getElementById('recentItems');
            recentContainer.innerHTML = recentItems.map(item => createRecentItemCard(item)).join('');
        }

        // å‰µå»ºæœ€è¿‘é …ç›®å¡ç‰‡
        function createRecentItemCard(item) {
            const typeEmoji = {
                character: 'ğŸ‘¤',
                background: 'ğŸŒ',
                secret: 'ğŸ”',
                novel: 'ğŸ“–'
            };

            return `
                <div class="data-card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${typeEmoji[item.type]} ${item.name || item.title}</div>
                            <div style="font-size: 0.8em; color: #666;">
                                ${new Date(item.updatedAt || item.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        ${truncateText(item.description || item.content || '', 100)}
                    </div>
                </div>
            `;
        }

        // è§’è‰²ç›¸é—œåŠŸèƒ½
        function renderCharacters() {
            renderTagFilter('character');
            renderCharacterList();
        }

        function renderCharacterList(filteredData = null) {
            const data = filteredData || appData.characters;
            const container = document.getElementById('characterList');
            
            container.innerHTML = data.map(character => createCharacterCard(character)).join('');
        }

        function createCharacterCard(character) {
            return `
                <div class="data-card" onclick="viewCharacter('${character.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${character.name}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${character.age ? `${character.age}æ­²` : ''} ${character.race || ''}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-primary" onclick="event.stopPropagation(); editCharacter('${character.id}')">ç·¨è¼¯</button>
                            <button class="card-btn btn-danger" onclick="event.stopPropagation(); deleteCharacter('${character.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div><strong>å¤–è²Œï¼š</strong>${truncateText(character.appearance || '', 50)}</div>
                        <div><strong>æ€§æ ¼ï¼š</strong>${truncateText(character.personality || '', 50)}</div>
                        <div><strong>èƒŒæ™¯ï¼š</strong>${truncateText(character.background || '', 50)}</div>
                    </div>
                    <div class="card-tags">
                        ${(character.tags || []).map(tag => `<span class="tag character">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function showCharacterForm(id = null) {
            const character = id ? appData.characters.find(c => c.id === id) : {};
            const isEdit = !!id;

            const formHTML = `
                <h2>${isEdit ? 'ç·¨è¼¯è§’è‰²' : 'æ–°å¢è§’è‰²'}</h2>
                <form onsubmit="saveCharacter(event, '${id || ''}')">
                    <div class="form-group">
                        <label class="form-label">è§’è‰²åç¨± *</label>
                        <input type="text" class="form-input" name="name" value="${character.name || ''}" required />
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">å¹´é½¡</label>
                            <input type="text" class="form-input" name="age" value="${character.age || ''}" />
                        </div>
                        <div class="form-col">
                            <label class="form-label">ç¨®æ—</label>
                            <input type="text" class="form-input" name="race" value="${character.race || ''}" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å¤–è²Œæè¿°</label>
                        <textarea class="form-textarea" name="appearance">${character.appearance || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ€§æ ¼ç‰¹è³ª</label>
                        <textarea class="form-textarea" name="personality">${character.personality || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">èƒŒæ™¯æ•…äº‹</label>
                        <textarea class="form-textarea large-textarea" name="background">${character.background || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é¡å¤–å‚™è¨»</label>
                        <textarea class="form-textarea" name="notes">${character.notes || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨™ç±¤</label>
                        <div class="tag-selector">
                            ${generateTagSelector(['ä¸»è§’', 'é…è§’', 'åæ´¾', 'é‡è¦', 'æ¬¡è¦'], character.tags || [])}
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">å–æ¶ˆ</button>
                    </div>
                </form>
            `;

            showForm(formHTML);
        }

        function saveCharacter(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedTags = Array.from(document.querySelectorAll('.tag-option.selected')).map(el => el.textContent);

            const character = {
                id: id || generateId(),
                name: formData.get('name'),
                age: formData.get('age'),
                race: formData.get('race'),
                appearance: formData.get('appearance'),
                personality: formData.get('personality'),
                background: formData.get('background'),
                notes: formData.get('notes'),
                tags: selectedTags,
                createdAt: id ? appData.characters.find(c => c.id === id).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (id) {
                const index = appData.characters.findIndex(c => c.id === id);
                appData.characters[index] = character;
            } else {
                appData.characters.push(character);
            }

            saveData();
            hideForm();
            renderCharacters();
            if (currentPage === 'dashboard') updateDashboard();
        }

        function editCharacter(id) {
            showCharacterForm(id);
        }

        function deleteCharacter(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è§’è‰²å—ï¼Ÿ')) {
                appData.characters = appData.characters.filter(c => c.id !== id);
                saveData();
                renderCharacters();
                if (currentPage === 'dashboard') updateDashboard();
            }
        }

        function viewCharacter(id) {
            const character = appData.characters.find(c => c.id === id);
            if (!character) return;

            const viewHTML = `
                <h2>ğŸ‘¤ ${character.name}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>å¹´é½¡ï¼š</strong>${character.age || 'æœªè¨­å®š'}<br>
                    <strong>ç¨®æ—ï¼š</strong>${character.race || 'æœªè¨­å®š'}<br>
                    <strong>æ¨™ç±¤ï¼š</strong>${(character.tags || []).join(', ') || 'ç„¡'}
                </div>
                
                ${character.appearance ? `<div style="margin-bottom: 15px;"><strong>å¤–è²Œæè¿°ï¼š</strong><br>${character.appearance}</div>` : ''}
                ${character.personality ? `<div style="margin-bottom: 15px;"><strong>æ€§æ ¼ç‰¹è³ªï¼š</strong><br>${character.personality}</div>` : ''}
                ${character.background ? `<div style="margin-bottom: 15px;"><strong>èƒŒæ™¯æ•…äº‹ï¼š</strong><br>${character.background}</div>` : ''}
                ${character.notes ? `<div style="margin-bottom: 15px;"><strong>é¡å¤–å‚™è¨»ï¼š</strong><br>${character.notes}</div>` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editCharacter('${character.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-secondary" onclick="hideForm()">é—œé–‰</button>
                </div>
            `;

            showForm(viewHTML);
        }

        function searchCharacters() {
            const query = document.getElementById('characterSearch').value.toLowerCase();
            const selectedTags = getSelectedTags('characterTagFilter');
            
            let filtered = appData.characters;

            if (query) {
                filtered = filtered.filter(character => 
                    character.name.toLowerCase().includes(query) ||
                    (character.personality && character.personality.toLowerCase().includes(query)) ||
                    (character.background && character.background.toLowerCase().includes(query))
                );
            }

            if (selectedTags.length > 0) {
                filtered = filtered.filter(character => 
                    selectedTags.some(tag => (character.tags || []).includes(tag))
                );
            }

            renderCharacterList(filtered);
        }

        // æ•…äº‹èƒŒæ™¯ç›¸é—œåŠŸèƒ½
        function renderBackgrounds() {
            renderTagFilter('background');
            renderBackgroundList();
        }

        function renderBackgroundList(filteredData = null) {
            const data = filteredData || appData.backgrounds;
            const container = document.getElementById('backgroundList');
            
            container.innerHTML = data.map(background => createBackgroundCard(background)).join('');
        }

        function createBackgroundCard(background) {
            return `
                <div class="data-card" onclick="viewBackground('${background.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${background.name}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${background.type || ''}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-primary" onclick="event.stopPropagation(); editBackground('${background.id}')">ç·¨è¼¯</button>
                            <button class="card-btn btn-danger" onclick="event.stopPropagation(); deleteBackground('${background.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div><strong>æè¿°ï¼š</strong>${truncateText(background.description || '', 100)}</div>
                        ${background.rules ? `<div><strong>è¦å‰‡ï¼š</strong>${truncateText(background.rules, 50)}</div>` : ''}
                    </div>
                    <div class="card-tags">
                        ${(background.tags || []).map(tag => `<span class="tag location">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function showBackgroundForm(id = null) {
            const background = id ? appData.backgrounds.find(b => b.id === id) : {};
            const isEdit = !!id;

            const formHTML = `
                <h2>${isEdit ? 'ç·¨è¼¯èƒŒæ™¯' : 'æ–°å¢èƒŒæ™¯'}</h2>
                <form onsubmit="saveBackground(event, '${id || ''}')">
                    <div class="form-group">
                        <label class="form-label">å ´æ™¯åç¨± *</label>
                        <input type="text" class="form-input" name="name" value="${background.name || ''}" required />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é¡å‹</label>
                        <select class="form-select" name="type">
                            <option value="">é¸æ“‡é¡å‹</option>
                            <option value="åœ°é»" ${background.type === 'åœ°é»' ? 'selected' : ''}>åœ°é»</option>
                            <option value="æ™‚ä»£" ${background.type === 'æ™‚ä»£' ? 'selected' : ''}>æ™‚ä»£</option>
                            <option value="ä¸–ç•Œè§€" ${background.type === 'ä¸–ç•Œè§€' ? 'selected' : ''}>ä¸–ç•Œè§€</option>
                            <option value="æ–‡åŒ–" ${background.type === 'æ–‡åŒ–' ? 'selected' : ''}>æ–‡åŒ–</option>
                            <option value="å…¶ä»–" ${background.type === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è©³ç´°æè¿°</label>
                        <textarea class="form-textarea large-textarea" name="description">${background.description || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è¦å‰‡/æ³•å‰‡</label>
                        <textarea class="form-textarea" name="rules">${background.rules || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‚™è¨»</label>
                        <textarea class="form-textarea" name="notes">${background.notes || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨™ç±¤</label>
                        <div class="tag-selector">
                            ${generateTagSelector(['åœ°é»', 'æ™‚ä»£', 'ä¸–ç•Œè§€', 'æ–‡åŒ–', 'é‡è¦', 'æ¬¡è¦'], background.tags || [])}
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">å–æ¶ˆ</button>
                    </div>
                </form>
            `;

            showForm(formHTML);
        }

        function saveBackground(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedTags = Array.from(document.querySelectorAll('.tag-option.selected')).map(el => el.textContent);

            const background = {
                id: id || generateId(),
                name: formData.get('name'),
                type: formData.get('type'),
                description: formData.get('description'),
                rules: formData.get('rules'),
                notes: formData.get('notes'),
                tags: selectedTags,
                createdAt: id ? appData.backgrounds.find(b => b.id === id).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (id) {
                const index = appData.backgrounds.findIndex(b => b.id === id);
                appData.backgrounds[index] = background;
            } else {
                appData.backgrounds.push(background);
            }

            saveData();
            hideForm();
            renderBackgrounds();
            if (currentPage === 'dashboard') updateDashboard();
        }

        function editBackground(id) {
            showBackgroundForm(id);
        }

        function deleteBackground(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹èƒŒæ™¯è¨­å®šå—ï¼Ÿ')) {
                appData.backgrounds = appData.backgrounds.filter(b => b.id !== id);
                saveData();
                renderBackgrounds();
                if (currentPage === 'dashboard') updateDashboard();
            }
        }

        function viewBackground(id) {
            const background = appData.backgrounds.find(b => b.id === id);
            if (!background) return;

            const viewHTML = `
                <h2>ğŸŒ ${background.name}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>é¡å‹ï¼š</strong>${background.type || 'æœªè¨­å®š'}<br>
                    <strong>æ¨™ç±¤ï¼š</strong>${(background.tags || []).join(', ') || 'ç„¡'}
                </div>
                
                ${background.description ? `<div style="margin-bottom: 15px;"><strong>è©³ç´°æè¿°ï¼š</strong><br>${background.description}</div>` : ''}
                ${background.rules ? `<div style="margin-bottom: 15px;"><strong>è¦å‰‡/æ³•å‰‡ï¼š</strong><br>${background.rules}</div>` : ''}
                ${background.notes ? `<div style="margin-bottom: 15px;"><strong>å‚™è¨»ï¼š</strong><br>${background.notes}</div>` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editBackground('${background.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-secondary" onclick="hideForm()">é—œé–‰</button>
                </div>
            `;

            showForm(viewHTML);
        }

        function searchBackgrounds() {
            const query = document.getElementById('backgroundSearch').value.toLowerCase();
            const selectedTags = getSelectedTags('backgroundTagFilter');
            
            let filtered = appData.backgrounds;

            if (query) {
                filtered = filtered.filter(background => 
                    background.name.toLowerCase().includes(query) ||
                    (background.description && background.description.toLowerCase().includes(query)) ||
                    (background.type && background.type.toLowerCase().includes(query))
                );
            }

            if (selectedTags.length > 0) {
                filtered = filtered.filter(background => 
                    selectedTags.some(tag => (background.tags || []).includes(tag))
                );
            }

            renderBackgroundList(filtered);
        }

        // ç§˜å¯†è¨­å®šç›¸é—œåŠŸèƒ½
        function renderSecrets() {
            renderTagFilter('secret');
            renderSecretList();
        }

        function renderSecretList(filteredData = null) {
            const data = filteredData || appData.secrets;
            const container = document.getElementById('secretList');
            
            container.innerHTML = data.map(secret => createSecretCard(secret)).join('');
        }

        function createSecretCard(secret) {
            return `
                <div class="data-card" onclick="viewSecret('${secret.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${secret.title}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${secret.category || ''}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-primary" onclick="event.stopPropagation(); editSecret('${secret.id}')">ç·¨è¼¯</button>
                            <button class="card-btn btn-danger" onclick="event.stopPropagation(); deleteSecret('${secret.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="spoiler-warning">âš ï¸ åŠ‡é€å…§å®¹ï¼Œé»æ“ŠæŸ¥çœ‹è©³æƒ…</div>
                        ${secret.impact ? `<div><strong>é‡è¦æ€§ï¼š</strong>${truncateText(secret.impact, 50)}</div>` : ''}
                    </div>
                    <div class="card-tags">
                        ${(secret.tags || []).map(tag => `<span class="tag secret">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function showSecretForm(id = null) {
            const secret = id ? appData.secrets.find(s => s.id === id) : {};
            const isEdit = !!id;

            const formHTML = `
                <h2>${isEdit ? 'ç·¨è¼¯ç§˜å¯†è¨­å®š' : 'æ–°å¢ç§˜å¯†è¨­å®š'}</h2>
                <form onsubmit="saveSecret(event, '${id || ''}')">
                    <div class="form-group">
                        <label class="form-label">æ¨™é¡Œ *</label>
                        <input type="text" class="form-input" name="title" value="${secret.title || ''}" required />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é¡åˆ¥</label>
                        <select class="form-select" name="category">
                            <option value="">é¸æ“‡é¡åˆ¥</option>
                            <option value="åŠ‡æƒ…è½‰æŠ˜" ${secret.category === 'åŠ‡æƒ…è½‰æŠ˜' ? 'selected' : ''}>åŠ‡æƒ…è½‰æŠ˜</option>
                            <option value="è§’è‰²ç§˜å¯†" ${secret.category === 'è§’è‰²ç§˜å¯†' ? 'selected' : ''}>è§’è‰²ç§˜å¯†</option>
                            <option value="ä¸–ç•Œè¨­å®š" ${secret.category === 'ä¸–ç•Œè¨­å®š' ? 'selected' : ''}>ä¸–ç•Œè¨­å®š</option>
                            <option value="ä¼ç­†" ${secret.category === 'ä¼ç­†' ? 'selected' : ''}>ä¼ç­†</option>
                            <option value="çµå±€" ${secret.category === 'çµå±€' ? 'selected' : ''}>çµå±€</option>
                            <option value="å…¶ä»–" ${secret.category === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å…§å®¹</label>
                        <textarea class="form-textarea large-textarea" name="content">${secret.content || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å½±éŸ¿/é‡è¦æ€§</label>
                        <textarea class="form-textarea" name="impact">${secret.impact || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çŸ¥æƒ…äºº</label>
                        <input type="text" class="form-input" name="knownBy" value="${secret.knownBy || ''}" placeholder="èª°çŸ¥é“é€™å€‹ç§˜å¯†ï¼Ÿ" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨™ç±¤</label>
                        <div class="tag-selector">
                            ${generateTagSelector(['åŠ‡æƒ…', 'è§’è‰²', 'ä¸–ç•Œ', 'ä¼ç­†', 'é‡è¦', 'æ¬¡è¦'], secret.tags || [])}
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">å–æ¶ˆ</button>
                    </div>
                </form>
            `;

            showForm(formHTML);
        }

        function saveSecret(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedTags = Array.from(document.querySelectorAll('.tag-option.selected')).map(el => el.textContent);

            const secret = {
                id: id || generateId(),
                title: formData.get('title'),
                category: formData.get('category'),
                content: formData.get('content'),
                impact: formData.get('impact'),
                knownBy: formData.get('knownBy'),
                tags: selectedTags,
                createdAt: id ? appData.secrets.find(s => s.id === id).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (id) {
                const index = appData.secrets.findIndex(s => s.id === id);
                appData.secrets[index] = secret;
            } else {
                appData.secrets.push(secret);
            }

            saveData();
            hideForm();
            renderSecrets();
            if (currentPage === 'dashboard') updateDashboard();
        }

        function editSecret(id) {
            showSecretForm(id);
        }

        function deleteSecret(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç§˜å¯†è¨­å®šå—ï¼Ÿ')) {
                appData.secrets = appData.secrets.filter(s => s.id !== id);
                saveData();
                renderSecrets();
                if (currentPage === 'dashboard') updateDashboard();
            }
        }

        function viewSecret(id) {
            const secret = appData.secrets.find(s => s.id === id);
            if (!secret) return;

            const viewHTML = `
                <h2>ğŸ” ${secret.title}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>é¡åˆ¥ï¼š</strong>${secret.category || 'æœªè¨­å®š'}<br>
                    <strong>çŸ¥æƒ…äººï¼š</strong>${secret.knownBy || 'æœªè¨­å®š'}<br>
                    <strong>æ¨™ç±¤ï¼š</strong>${(secret.tags || []).join(', ') || 'ç„¡'}
                </div>
                
                <div class="spoiler-warning">âš ï¸ ä»¥ä¸‹åŒ…å«åŠ‡é€å…§å®¹</div>
                
                ${secret.content ? `<div style="margin-bottom: 15px;"><strong>å…§å®¹ï¼š</strong><br>${secret.content}</div>` : ''}
                ${secret.impact ? `<div style="margin-bottom: 15px;"><strong>å½±éŸ¿/é‡è¦æ€§ï¼š</strong><br>${secret.impact}</div>` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editSecret('${secret.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-secondary" onclick="hideForm()">é—œé–‰</button>
                </div>
            `;

            showForm(viewHTML);
        }

        function searchSecrets() {
            const query = document.getElementById('secretSearch').value.toLowerCase();
            const selectedTags = getSelectedTags('secretTagFilter');
            
            let filtered = appData.secrets;

            if (query) {
                filtered = filtered.filter(secret => 
                    secret.title.toLowerCase().includes(query) ||
                    (secret.content && secret.content.toLowerCase().includes(query)) ||
                    (secret.category && secret.category.toLowerCase().includes(query))
                );
            }

            if (selectedTags.length > 0) {
                filtered = filtered.filter(secret => 
                    selectedTags.some(tag => (secret.tags || []).includes(tag))
                );
            }

            renderSecretList(filtered);
        }

        // å°èªªç›¸é—œåŠŸèƒ½
        function renderNovels() {
            renderNovelList();
        }

        function renderNovelList(filteredData = null) {
            const data = filteredData || appData.novels;
            const container = document.getElementById('novelList');
            
            container.innerHTML = data.map(novel => createNovelCard(novel)).join('');
        }

        function createNovelCard(novel) {
            const wordCount = (novel.content || '').length;
            return `
                <div class="data-card" onclick="viewNovel('${novel.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${novel.title}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${wordCount} å­— | ${new Date(novel.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-primary" onclick="event.stopPropagation(); editNovel('${novel.id}')">ç·¨è¼¯</button>
                            <button class="card-btn btn-danger" onclick="event.stopPropagation(); deleteNovel('${novel.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div><strong>æç¤ºè©ï¼š</strong>${truncateText(novel.prompt || '', 100)}</div>
                        <div><strong>å…§å®¹ï¼š</strong>${truncateText(novel.content || '', 100)}</div>
                        ${novel.rating ? `<div><strong>è©•åƒ¹ï¼š</strong>${novel.rating}</div>` : ''}
                    </div>
                    <div class="card-tags">
                        ${(novel.relatedMaterials || []).map(material => `<span class="tag character">${material}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function saveNovel(title, prompt, content, relatedMaterials = []) {
            const novel = {
                id: generateId(),
                title,
                prompt,
                content,
                relatedMaterials,
                rating: '',
                notes: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            appData.novels.push(novel);
            saveData();
            
            if (currentPage === 'novels') renderNovels();
            if (currentPage === 'dashboard') updateDashboard();

            return novel.id;
        }

        function editNovel(id) {
            const novel = appData.novels.find(n => n.id === id);
            if (!novel) return;

            const formHTML = `
                <h2>ç·¨è¼¯å°èªª</h2>
                <form onsubmit="updateNovel(event, '${id}')">
                    <div class="form-group">
                        <label class="form-label">æ¨™é¡Œ</label>
                        <input type="text" class="form-input" name="title" value="${novel.title}" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">æç¤ºè©</label>
                        <textarea class="form-textarea" name="prompt">${novel.prompt || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å°èªªå…§å®¹</label>
                        <textarea class="form-textarea large-textarea" name="content">${novel.content || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è©•åƒ¹/å‚™è¨»</label>
                        <textarea class="form-textarea" name="notes">${novel.notes || ''}</textarea>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">å–æ¶ˆ</button>
                    </div>
                </form>
            `;

            showForm(formHTML);
        }

        function updateNovel(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);

            const index = appData.novels.findIndex(n => n.id === id);
            if (index !== -1) {
                appData.novels[index] = {
                    ...appData.novels[index],
                    title: formData.get('title'),
                    prompt: formData.get('prompt'),
                    content: formData.get('content'),
                    notes: formData.get('notes'),
                    updatedAt: new Date().toISOString()
                };

                saveData();
                hideForm();
                renderNovels();
            }
        }

        function deleteNovel(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡å°èªªå—ï¼Ÿ')) {
                appData.novels = appData.novels.filter(n => n.id !== id);
                saveData();
                renderNovels();
                if (currentPage === 'dashboard') updateDashboard();
            }
        }

        function viewNovel(id) {
            const novel = appData.novels.find(n => n.id === id);
            if (!novel) return;

            const wordCount = (novel.content || '').length;
            const viewHTML = `
                <h2>ğŸ“– ${novel.title}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>å­—æ•¸ï¼š</strong>${wordCount}<br>
                    <strong>å‰µå»ºæ™‚é–“ï¼š</strong>${new Date(novel.createdAt).toLocaleString()}<br>
                    <strong>æœ€å¾Œä¿®æ”¹ï¼š</strong>${new Date(novel.updatedAt).toLocaleString()}
                </div>

                ${novel.prompt ? `<div style="margin-bottom: 15px;"><strong>ä½¿ç”¨çš„æç¤ºè©ï¼š</strong><br><div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">${novel.prompt}</div></div>` : ''}
                
                <div style="margin-bottom: 15px;"><strong>å°èªªå…§å®¹ï¼š</strong><br>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; white-space: pre-wrap;">${novel.content || ''}</div></div>

                ${novel.notes ? `<div style="margin-bottom: 15px;"><strong>å‚™è¨»/è©•åƒ¹ï¼š</strong><br>${novel.notes}</div>` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editNovel('${novel.id}')">ç·¨è¼¯</button>
                    <button class="btn btn-secondary" onclick="copyNovelContent('${novel.id}')">è¤‡è£½å…§å®¹</button>
                    <button class="btn btn-secondary" onclick="hideForm()">é—œé–‰</button>
                </div>
            `;

            showForm(viewHTML);
        }

        function copyNovelContent(id) {
            const novel = appData.novels.find(n => n.id === id);
            if (novel && novel.content) {
                navigator.clipboard.writeText(novel.content).then(() => {
                    alert('å°èªªå…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                });
            }
        }

        function searchNovels() {
            const query = document.getElementById('novelSearch').value.toLowerCase();
            
            let filtered = appData.novels;

            if (query) {
                filtered = filtered.filter(novel => 
                    novel.title.toLowerCase().includes(query) ||
                    (novel.content && novel.content.toLowerCase().includes(query)) ||
                    (novel.prompt && novel.prompt.toLowerCase().includes(query))
                );
            }

            renderNovelList(filtered);
        }

        function sortNovels() {
            const sortType = document.getElementById('novelSort').value;
            let sorted = [...appData.novels];

            switch(sortType) {
                case 'date':
                    sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'title':
                    sorted.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'length':
                    sorted.sort((a, b) => (b.content || '').length - (a.content || '').length);
                    break;
            }

            renderNovelList(sorted);
        }

        // AIåŠ©æ‰‹ç›¸é—œåŠŸèƒ½
        function renderAIAssistant() {
            updateMaterialSelectors();
            loadPromptHistory();
        }

        function updateMaterialSelectors() {
            // è§’è‰²é¸æ“‡å™¨
            const characterContainer = document.getElementById('aiCharacterList');
            characterContainer.innerHTML = appData.characters.map(character => 
                `<div class="material-item" data-type="character" data-id="${character.id}">${character.name}</div>`
            ).join('');

            // èƒŒæ™¯é¸æ“‡å™¨
            const backgroundContainer = document.getElementById('aiBackgroundList');
            backgroundContainer.innerHTML = appData.backgrounds.map(background => 
                `<div class="material-item" data-type="background" data-id="${background.id}">${background.name}</div>`
            ).join('');

            // ç§˜å¯†è¨­å®šé¸æ“‡å™¨
            const secretContainer = document.getElementById('aiSecretList');
            secretContainer.innerHTML = appData.secrets.map(secret => 
                `<div class="material-item" data-type="secret" data-id="${secret.id}">${secret.title}</div>`
            ).join('');

            // æ·»åŠ é»æ“Šäº‹ä»¶
            document.querySelectorAll('.material-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('selected');
                });
            });
        }

        function useTemplate(type) {
            const templates = {
                story: appData.settings.templates.story || `æ ¹æ“šä»¥ä¸‹ç´ æï¼Œå‰µä½œä¸€å€‹å®Œæ•´çš„æ•…äº‹ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

æ•…äº‹èƒŒæ™¯ï¼š
{backgrounds}

ç§˜å¯†è¨­å®šï¼š
{secrets}

è«‹å‰µä½œä¸€å€‹å¼•äººå…¥å‹çš„æ•…äº‹ï¼Œæ³¨æ„è§’è‰²ç™¼å±•å’ŒåŠ‡æƒ…è½‰æŠ˜ã€‚`,

                dialogue: appData.settings.templates.dialogue || `åŸºæ–¼ä»¥ä¸‹è§’è‰²è¨­å®šï¼Œå‰µä½œä¸€æ®µå°è©±ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

å ´æ™¯èƒŒæ™¯ï¼š
{backgrounds}

è«‹å‰µä½œç¬¦åˆè§’è‰²æ€§æ ¼çš„è‡ªç„¶å°è©±ã€‚`,

                scene: appData.settings.templates.scene || `æ ¹æ“šä»¥ä¸‹èƒŒæ™¯è¨­å®šï¼Œå‰µä½œè©³ç´°çš„å ´æ™¯æè¿°ï¼š

èƒŒæ™¯è¨­å®šï¼š
{backgrounds}

è«‹å‰µä½œç”Ÿå‹•ç´°ç·»çš„å ´æ™¯æè¿°ã€‚`,

                analysis: appData.settings.templates.analysis || `åˆ†æä»¥ä¸‹æ•…äº‹ç´ æï¼Œæä¾›åŠ‡æƒ…å»ºè­°ï¼š

æ‰€æœ‰ç´ æï¼š
{characters}
{backgrounds}
{secrets}

è«‹åˆ†æé€™äº›ç´ æçš„æ½›åœ¨åŠ‡æƒ…ç™¼å±•å¯èƒ½æ€§ã€‚`,

                dnd: appData.settings.templates.dnd || `åŸºæ–¼ä»¥ä¸‹è§’è‰²è¨­å®šï¼Œå‰µå»ºä¸€å€‹DNDè§’è‰²ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

è«‹åŒ…å«è·æ¥­ã€ç¨®æ—ã€å±¬æ€§ã€èƒŒæ™¯æ•…äº‹ç­‰å®Œæ•´è³‡è¨Šã€‚`
            };

            document.getElementById('customPrompt').value = templates[type];
            autoResizeTextarea(document.getElementById('customPrompt'));
        }

        function generatePrompt() {
            const selectedMaterials = getSelectedMaterials();
            const additionalReq = document.getElementById('additionalRequirements').value.trim();
            let prompt = document.getElementById('customPrompt').value;
        
            // ä¿®æ­£è§’è‰²è³‡è¨Šçµ„åˆ
            prompt = prompt.replace('{characters}', selectedMaterials.characters.map(c => {
                let charInfo = `${c.name}:`;
                if (c.age) charInfo += ` å¹´é½¡${c.age}æ­²`;
                if (c.race) charInfo += ` (${c.race})`;
                if (c.appearance) charInfo += `\n  å¤–è²Œ: ${c.appearance}`;
                if (c.personality) charInfo += `\n  æ€§æ ¼: ${c.personality}`;
                if (c.background) charInfo += `\n  èƒŒæ™¯: ${c.background}`;
                if (c.notes) charInfo += `\n  å‚™è¨»: ${c.notes}`;
                return charInfo;
            }).join('\n\n'));
        
            prompt = prompt.replace('{backgrounds}', selectedMaterials.backgrounds.map(b => {
                let bgInfo = `${b.name}:`;
                if (b.type) bgInfo += ` (${b.type})`;
                if (b.description) bgInfo += `\n  æè¿°: ${b.description}`;
                if (b.rules) bgInfo += `\n  è¦å‰‡: ${b.rules}`;
                if (b.notes) bgInfo += `\n  å‚™è¨»: ${b.notes}`;
                return bgInfo;
            }).join('\n\n'));
        
            prompt = prompt.replace('{secrets}', selectedMaterials.secrets.map(s => {
                let secretInfo = `${s.title}:`;
                if (s.category) secretInfo += ` (${s.category})`;
                if (s.content) secretInfo += `\n  å…§å®¹: ${s.content}`;
                if (s.impact) secretInfo += `\n  å½±éŸ¿: ${s.impact}`;
                return secretInfo;
            }).join('\n\n'));
        
            // ğŸ†• æ·»åŠ é¡å¤–è¦æ±‚
            if (additionalReq) {
                prompt += '\n\né¡å¤–è¦æ±‚ï¼š\n' + additionalReq;
            }
        
            document.getElementById('customPrompt').value = prompt;
            autoResizeTextarea(document.getElementById('customPrompt'));
        }



        function getSelectedMaterials() {
            const selectedItems = document.querySelectorAll('.material-item.selected');
            const materials = { characters: [], backgrounds: [], secrets: [] };

            selectedItems.forEach(item => {
                const type = item.dataset.type;
                const id = item.dataset.id;

                if (type === 'character') {
                    const character = appData.characters.find(c => c.id === id);
                    if (character) materials.characters.push(character);
                } else if (type === 'background') {
                    const background = appData.backgrounds.find(b => b.id === id);
                    if (background) materials.backgrounds.push(background);
                } else if (type === 'secret') {
                    const secret = appData.secrets.find(s => s.id === id);
                    if (secret) materials.secrets.push(secret);
                }
            });

            return materials;
        }

        function sendToPerplexity() {
            const prompt = document.getElementById('customPrompt').value;
            if (!prompt.trim()) {
                alert('è«‹å…ˆè¼¸å…¥æˆ–ç”Ÿæˆæç¤ºè©ï¼');
                return;
            }

            // å„²å­˜åˆ°æ­·å²è¨˜éŒ„
            savePromptToHistory(prompt);

            // é–‹å•Ÿ Perplexity
            const encodedPrompt = encodeURIComponent(prompt);
            window.open(`https://www.perplexity.ai/?q=${encodedPrompt}`, '_blank');
        }

        function copyPrompt() {
            const prompt = document.getElementById('customPrompt').value;
            if (prompt.trim()) {
                navigator.clipboard.writeText(prompt).then(() => {
                    alert('æç¤ºè©å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                });
            }
        }

        function savePromptTemplate() {
            const prompt = document.getElementById('customPrompt').value;
            const title = prompt('è«‹è¼¸å…¥æ¨¡æ¿åç¨±ï¼š');
            
            if (title && prompt.trim()) {
                if (!appData.settings.customTemplates) {
                    appData.settings.customTemplates = [];
                }
                
                appData.settings.customTemplates.push({
                    id: generateId(),
                    title,
                    content: prompt,
                    createdAt: new Date().toISOString()
                });
                
                saveData();
                alert('æ¨¡æ¿å·²å„²å­˜ï¼');
            }
        }

        function savePromptToHistory(prompt) {
            const selectedMaterials = getSelectedMaterials();
            const historyItem = {
                id: generateId(),
                prompt,
                materials: selectedMaterials,
                createdAt: new Date().toISOString()
            };

            appData.promptHistory.unshift(historyItem);
            
            // åªä¿ç•™æœ€è¿‘50å€‹
            if (appData.promptHistory.length > 50) {
                appData.promptHistory = appData.promptHistory.slice(0, 50);
            }

            saveData();
            loadPromptHistory();
        }

        function loadPromptHistory() {
            const container = document.getElementById('promptHistory');
            container.innerHTML = appData.promptHistory.slice(0, 10).map(item => 
                createPromptHistoryCard(item)
            ).join('');
        }

        function createPromptHistoryCard(item) {
            const materialCount = 
                item.materials.characters.length + 
                item.materials.backgrounds.length + 
                item.materials.secrets.length;

            return `
                <div class="data-card" onclick="usePromptFromHistory('${item.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">æ­·å²æç¤ºè©</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${new Date(item.createdAt).toLocaleString()} | ${materialCount} å€‹ç´ æ
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        ${truncateText(item.prompt, 150)}
                    </div>
                </div>
            `;
        }

        function usePromptFromHistory(id) {
            const item = appData.promptHistory.find(h => h.id === id);
            if (item) {
                document.getElementById('customPrompt').value = item.prompt;
                autoResizeTextarea(document.getElementById('customPrompt'));

                // é‡æ–°é¸æ“‡ç›¸é—œç´ æ
                document.querySelectorAll('.material-item').forEach(el => {
                    el.classList.remove('selected');
                });

                item.materials.characters.forEach(character => {
                    const el = document.querySelector(`[data-type="character"][data-id="${character.id}"]`);
                    if (el) el.classList.add('selected');
                });

                item.materials.backgrounds.forEach(background => {
                    const el = document.querySelector(`[data-type="background"][data-id="${background.id}"]`);
                    if (el) el.classList.add('selected');
                });

                item.materials.secrets.forEach(secret => {
                    const el = document.querySelector(`[data-type="secret"][data-id="${secret.id}"]`);
                    if (el) el.classList.add('selected');
                });
            }
        }

        // è¨­å®šç›¸é—œåŠŸèƒ½
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (newPassword.trim()) {
                appData.settings.password = newPassword;
                saveData();
                alert('å¯†ç¢¼å·²æ›´æ–°ï¼');
                document.getElementById('newPassword').value = '';
            }
        }

        function loadTemplates() {
            // è¼‰å…¥é è¨­æ¨¡æ¿åˆ°è¨­å®š
            if (!appData.settings.templates) {
                appData.settings.templates = {
                    story: `æ ¹æ“šä»¥ä¸‹ç´ æï¼Œå‰µä½œä¸€å€‹å®Œæ•´çš„æ•…äº‹ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

æ•…äº‹èƒŒæ™¯ï¼š
{backgrounds}

ç§˜å¯†è¨­å®šï¼š
{secrets}

è«‹å‰µä½œä¸€å€‹å¼•äººå…¥å‹çš„æ•…äº‹ï¼Œæ³¨æ„è§’è‰²ç™¼å±•å’ŒåŠ‡æƒ…è½‰æŠ˜ã€‚`,
                    dialogue: `åŸºæ–¼ä»¥ä¸‹è§’è‰²è¨­å®šï¼Œå‰µä½œä¸€æ®µå°è©±ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

å ´æ™¯èƒŒæ™¯ï¼š
{backgrounds}

è«‹å‰µä½œç¬¦åˆè§’è‰²æ€§æ ¼çš„è‡ªç„¶å°è©±ã€‚`,
                    scene: `æ ¹æ“šä»¥ä¸‹èƒŒæ™¯è¨­å®šï¼Œå‰µä½œè©³ç´°çš„å ´æ™¯æè¿°ï¼š

èƒŒæ™¯è¨­å®šï¼š
{backgrounds}

è«‹å‰µä½œç”Ÿå‹•ç´°ç·»çš„å ´æ™¯æè¿°ã€‚`,
                    analysis: `åˆ†æä»¥ä¸‹æ•…äº‹ç´ æï¼Œæä¾›åŠ‡æƒ…å»ºè­°ï¼š

æ‰€æœ‰ç´ æï¼š
{characters}
{backgrounds}
{secrets}

è«‹åˆ†æé€™äº›ç´ æçš„æ½›åœ¨åŠ‡æƒ…ç™¼å±•å¯èƒ½æ€§ã€‚`,
                    dnd: `åŸºæ–¼ä»¥ä¸‹è§’è‰²è¨­å®šï¼Œå‰µå»ºä¸€å€‹DNDè§’è‰²ï¼š

è§’è‰²è¨­å®šï¼š
{characters}

è«‹åŒ…å«è·æ¥­ã€ç¨®æ—ã€å±¬æ€§ã€èƒŒæ™¯æ•…äº‹ç­‰å®Œæ•´è³‡è¨Šã€‚`
                };
                saveData();
            }

            // æ›´æ–°è¨­å®šé é¢çš„æ¨¡æ¿å…§å®¹
            if (document.getElementById('storyTemplate')) {
                document.getElementById('storyTemplate').value = appData.settings.templates.story || '';
                document.getElementById('dialogueTemplate').value = appData.settings.templates.dialogue || '';
                document.getElementById('sceneTemplate').value = appData.settings.templates.scene || '';
                document.getElementById('analysisTemplate').value = appData.settings.templates.analysis || '';
                document.getElementById('dndTemplate').value = appData.settings.templates.dnd || '';
            }
        }

        function saveTemplates() {
            appData.settings.templates = {
                story: document.getElementById('storyTemplate').value,
                dialogue: document.getElementById('dialogueTemplate').value,
                scene: document.getElementById('sceneTemplate').value,
                analysis: document.getElementById('analysisTemplate').value,
                dnd: document.getElementById('dndTemplate').value
            };
            saveData();
            alert('æ‰€æœ‰æ¨¡æ¿å·²å„²å­˜ï¼');
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `novel-library-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼')) {
                        appData = { ...appData, ...importedData };
                        saveData();
                        alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                        location.reload(); // é‡æ–°è¼‰å…¥é é¢
                    }
                } catch (error) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼');
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©ºinput
            input.value = '';
        }

        function connectGoogleDrive() {
            alert('Google Drive æ•´åˆåŠŸèƒ½éœ€è¦é€²ä¸€æ­¥é–‹ç™¼ï¼Œç›®å‰è«‹ä½¿ç”¨åŒ¯å‡º/åŒ¯å…¥åŠŸèƒ½é€²è¡Œå‚™ä»½ã€‚');
        }

        // é€šç”¨å·¥å…·å‡½æ•¸
        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function generateTagSelector(availableTags, selectedTags = []) {
            return availableTags.map(tag => 
                `<div class="tag-option ${selectedTags.includes(tag) ? 'selected' : ''}" onclick="toggleTag(this)">${tag}</div>`
            ).join('');
        }

        function toggleTag(element) {
            element.classList.toggle('selected');
        }

        function renderTagFilter(type) {
            const filterId = type + 'TagFilter';
            const container = document.getElementById(filterId);
            
            let allTags = [];
            if (type === 'character') {
                allTags = ['ä¸»è§’', 'é…è§’', 'åæ´¾', 'é‡è¦', 'æ¬¡è¦'];
            } else if (type === 'background') {
                allTags = ['åœ°é»', 'æ™‚ä»£', 'ä¸–ç•Œè§€', 'æ–‡åŒ–', 'é‡è¦', 'æ¬¡è¦'];
            } else if (type === 'secret') {
                allTags = ['åŠ‡æƒ…', 'è§’è‰²', 'ä¸–ç•Œ', 'ä¼ç­†', 'é‡è¦', 'æ¬¡è¦'];
            }

            container.innerHTML = allTags.map(tag => 
                `<span class="tag ${type}" onclick="toggleFilterTag(this, '${type}')">${tag}</span>`
            ).join('');
        }

        function toggleFilterTag(element, type) {
            element.classList.toggle('selected');
            
            // è§¸ç™¼ç›¸æ‡‰çš„æœå°‹å‡½æ•¸
            if (type === 'character') searchCharacters();
            else if (type === 'background') searchBackgrounds();
            else if (type === 'secret') searchSecrets();
        }

        function getSelectedTags(containerId) {
            const container = document.getElementById(containerId);
            return Array.from(container.querySelectorAll('.tag.selected')).map(el => el.textContent);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function showForm(html) {
            document.getElementById('formContent').innerHTML = html;
            document.getElementById('formOverlay').classList.remove('hidden');
        }

        function hideForm() {
            document.getElementById('formOverlay').classList.add('hidden');
        }

        function renderAllPages() {
            renderCharacters();
            renderBackgrounds();
            renderSecrets();
            renderNovels();
            renderAIAssistant();
            loadTemplates();
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', initApp);

        // é»æ“Šè¡¨å–®å¤–éƒ¨é—œé–‰è¡¨å–®
        document.getElementById('formOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                hideForm();
            }
        });
    </script>
</body>
</html>
