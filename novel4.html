<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小說素材庫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 登入頁面 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 350px;
        }

        .login-box h1 {
            margin-bottom: 30px;
            color: #667eea;
            font-size: 2.5em;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-box button:hover {
            background: #5a67d8;
        }

        /* 主應用程式 */
        .app-container {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            padding: 20px 0;
        }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* 頁面樣式 */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .page-title {
            font-size: 1.5em;
            color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        /* 搜尋和篩選 */
        .search-filter {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 200px;
        }

        .tag {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .tag:hover {
            background: #bbdefb;
            color: #0d47a1;
        }
        
        .tag.selected {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }


        /* 資料卡片 */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .data-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .data-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .card-actions {
            display: flex;
            gap: 5px;
        }

        .card-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .card-content {
            margin-bottom: 15px;
            color: #666;
            line-height: 1.5;
        }

        .card-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* 表單樣式 */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .large-textarea {
            min-height: 300px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-col {
            flex: 1;
        }

        /* 標籤選擇器 */
        .tag-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag-option {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .tag-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        /* 統計面板 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        /* AI助手 */
        .ai-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .material-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .material-category {
            margin-bottom: 20px;
        }

        .material-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .material-item {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .material-item.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .prompt-template {
            margin-bottom: 20px;
        }

        .template-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .auto-resize-textarea {
            min-height: 200px;
            resize: none;
            overflow: hidden;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .content-area {
                order: 1;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            .search-row {
                flex-direction: column;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        /* 隱藏類別 */
        .hidden {
            display: none !important;
        }

        /* 警告提示 */
        .spoiler-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* 載入動畫 */
        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 登入頁面 -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>📚 小說素材庫</h1>
            <input type="password" id="passwordInput" placeholder="請輸入密碼" />
            <button onclick="login()">登入</button>
        </div>
    </div>

    <!-- 主應用程式 -->
    <div id="appContainer" class="container app-container">
        <div class="header">
            <h1>📚 小說素材庫</h1>
            <button class="logout-btn" onclick="logout()">登出</button>
        </div>

        <div class="main-content">
            <!-- 側邊導航 -->
            <div class="sidebar">
                <div class="nav-item active" data-page="dashboard">
                    📊 主控台
                </div>
                <div class="nav-item" data-page="characters">
                    👤 角色設定
                </div>
                <div class="nav-item" data-page="backgrounds">
                    🌍 故事背景
                </div>
                <div class="nav-item" data-page="secrets">
                    🔐 秘密設定
                </div>
                <div class="nav-item" data-page="novels">
                    📖 已生成小說
                </div>
                <div class="nav-item" data-page="ai-assistant">
                    🤖 AI創作助手
                </div>
                <div class="nav-item" data-page="settings">
                    ⚙️ 設定/備份
                </div>
            </div>

            <!-- 主要內容區域 -->
            <div class="content-area">
                <!-- 主控台 -->
                <div id="dashboard" class="page active">
                    <div class="page-header">
                        <h2 class="page-title">📊 主控台</h2>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="characterCount">0</div>
                            <div class="stat-label">角色設定</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="backgroundCount">0</div>
                            <div class="stat-label">故事背景</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="secretCount">0</div>
                            <div class="stat-label">秘密設定</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="novelCount">0</div>
                            <div class="stat-label">已生成小說</div>
                        </div>
                    </div>

                    <div class="recent-activity">
                        <h3>最近活動</h3>
                        <div id="recentItems" class="data-grid">
                            <!-- 最近項目將在這裡顯示 -->
                        </div>
                    </div>
                </div>

                <!-- 角色設定頁面 -->
                <div id="characters" class="page">
                    <div class="page-header">
                        <h2 class="page-title">👤 角色設定</h2>
                        <button class="btn btn-primary" onclick="showCharacterForm()">新增角色</button>
                    </div>

                    <div class="search-filter">
                        <div class="search-row">
                            <input type="text" class="search-input" id="characterSearch" placeholder="搜尋角色..." />
                            <button class="btn btn-secondary" onclick="searchCharacters()">搜尋</button>
                        </div>
                        <div class="tag-filter" id="characterTagFilter">
                            <!-- 標籤篩選器將在這裡生成 -->
                        </div>
                    </div>

                    <div id="characterList" class="data-grid">
                        <!-- 角色卡片將在這裡顯示 -->
                    </div>
                </div>

                <!-- 故事背景頁面 -->
                <div id="backgrounds" class="page">
                    <div class="page-header">
                        <h2 class="page-title">🌍 故事背景</h2>
                        <button class="btn btn-primary" onclick="showBackgroundForm()">新增背景</button>
                    </div>

                    <div class="search-filter">
                        <div class="search-row">
                            <input type="text" class="search-input" id="backgroundSearch" placeholder="搜尋背景..." />
                            <button class="btn btn-secondary" onclick="searchBackgrounds()">搜尋</button>
                        </div>
                        <div class="tag-filter" id="backgroundTagFilter">
                            <!-- 標籤篩選器將在這裡生成 -->
                        </div>
                    </div>

                    <div id="backgroundList" class="data-grid">
                        <!-- 背景卡片將在這裡顯示 -->
                    </div>
                </div>

                <!-- 秘密設定頁面 -->
                <div id="secrets" class="page">
                    <div class="page-header">
                        <h2 class="page-title">🔐 秘密設定</h2>
                        <button class="btn btn-primary" onclick="showSecretForm()">新增秘密</button>
                    </div>

                    <div class="search-filter">
                        <div class="search-row">
                            <input type="text" class="search-input" id="secretSearch" placeholder="搜尋秘密設定..." />
                            <button class="btn btn-secondary" onclick="searchSecrets()">搜尋</button>
                        </div>
                        <div class="tag-filter" id="secretTagFilter">
                            <!-- 標籤篩選器將在這裡生成 -->
                        </div>
                    </div>

                    <div id="secretList" class="data-grid">
                        <!-- 秘密設定卡片將在這裡顯示 -->
                    </div>
                </div>

                <!-- 已生成小說頁面 -->
                <div id="novels" class="page">
                    <div class="page-header">
                        <h2 class="page-title">📖 已生成小說</h2>
                    </div>

                    <div class="search-filter">
                        <div class="search-row">
                            <input type="text" class="search-input" id="novelSearch" placeholder="搜尋小說..." />
                            <button class="btn btn-secondary" onclick="searchNovels()">搜尋</button>
                            <select id="novelSort" onchange="sortNovels()">
                                <option value="date">按日期排序</option>
                                <option value="title">按標題排序</option>
                                <option value="length">按字數排序</option>
                            </select>
                        </div>
                    </div>

                    <div id="novelList" class="data-grid">
                        <!-- 小說卡片將在這裡顯示 -->
                    </div>
                </div>

                <!-- AI創作助手頁面 -->
                <div id="ai-assistant" class="page">
                    <div class="page-header">
                        <h2 class="page-title">🤖 AI創作助手</h2>
                    </div>

                    <div class="ai-container">
                        <!-- 素材選擇器 -->
                        <div class="material-selector">
                            <h3>📋 選擇素材</h3>
                            
                            <div class="material-category">
                                <h4>👤 角色</h4>
                                <div id="aiCharacterList" class="material-list">
                                    <!-- 角色選擇項目 -->
                                </div>
                            </div>

                            <div class="material-category">
                                <h4>🌍 背景</h4>
                                <div id="aiBackgroundList" class="material-list">
                                    <!-- 背景選擇項目 -->
                                </div>
                            </div>

                            <div class="material-category">
                                <h4>🔐 秘密設定</h4>
                                <div id="aiSecretList" class="material-list">
                                    <!-- 秘密設定選擇項目 -->
                                </div>
                            </div>
                        </div>

                        <!-- 智慧模板 -->
                        <div class="prompt-template">
                            <h3>📝 智慧模板</h3>
                            <div class="template-buttons">
                                <button class="btn btn-secondary" onclick="useTemplate('story')">完整故事</button>
                                <button class="btn btn-secondary" onclick="useTemplate('dialogue')">角色對話</button>
                                <button class="btn btn-secondary" onclick="useTemplate('scene')">場景描述</button>
                                <button class="btn btn-secondary" onclick="useTemplate('analysis')">劇情分析</button>
                                <button class="btn btn-secondary" onclick="useTemplate('dnd')">DND角色</button>
                            </div>
                        </div>

                        <!-- 🆕 額外要求輸入框 -->
                        <div class="form-group">
                            <label class="form-label">💭 額外要求</label>
                            <textarea id="additionalRequirements" class="form-textarea auto-resize-textarea" 
                                placeholder="輸入您的額外要求、特殊指示或創作方向..."></textarea>
                        </div>

                        <!-- 自訂提示詞 -->
                        <div class="form-group">
                            <label class="form-label">自訂提示詞</label>
                            <textarea id="customPrompt" class="form-textarea auto-resize-textarea" 
                                placeholder="輸入您的自訂提示詞..."></textarea>
                        </div>

                        <!-- 操作按鈕 -->
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="generatePrompt()">生成完整提示詞</button>
                            <button class="btn btn-success" onclick="sendToPerplexity()">發送到 Perplexity</button>
                            <button class="btn btn-secondary" onclick="copyPrompt()">複製到剪貼簿</button>
                            <button class="btn btn-secondary" onclick="savePromptTemplate()">儲存模板</button>
                        </div>

                        <!-- 提示詞歷史 -->
                        <div style="margin-top: 30px;">
                            <h3>📚 提示詞歷史</h3>
                            <div id="promptHistory" class="data-grid">
                                <!-- 歷史提示詞 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 設定/備份頁面 -->
                <div id="settings" class="page">
                    <div class="page-header">
                        <h2 class="page-title">⚙️ 設定/備份</h2>
                    </div>

                    <!-- 基本設定 -->
                    <div style="margin-bottom: 30px;">
                        <h3>🔐 基本設定</h3>
                        <div class="form-group">
                            <label class="form-label">修改密碼</label>
                            <input type="password" id="newPassword" class="form-input" placeholder="輸入新密碼" />
                            <button class="btn btn-primary" onclick="changePassword()" style="margin-top: 10px;">更新密碼</button>
                        </div>
                    </div>

                    <!-- 模板設定 -->
                    <div style="margin-bottom: 30px;">
                        <h3>📝 預設模板設定</h3>
                        <div class="form-group">
                            <label class="form-label">完整故事模板</label>
                            <textarea id="storyTemplate" class="form-textarea">根據以下素材，創作一個完整的故事：

角色設定：
{characters}

故事背景：
{backgrounds}

秘密設定：
{secrets}

請創作一個引人入勝的故事，注意角色發展和劇情轉折。</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">角色對話模板</label>
                            <textarea id="dialogueTemplate" class="form-textarea">基於以下角色設定，創作一段對話：

角色設定：
{characters}

場景背景：
{backgrounds}

請創作符合角色性格的自然對話。</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">場景描述模板</label>
                            <textarea id="sceneTemplate" class="form-textarea">根據以下背景設定，創作詳細的場景描述：

背景設定：
{backgrounds}

請創作生動細緻的場景描述。</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">劇情分析模板</label>
                            <textarea id="analysisTemplate" class="form-textarea">分析以下故事素材，提供劇情建議：

所有素材：
{characters}
{backgrounds}
{secrets}

請分析這些素材的潛在劇情發展可能性。</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">DND角色模板</label>
                            <textarea id="dndTemplate" class="form-textarea">基於以下角色設定，創建一個DND角色：

角色設定：
{characters}

請包含職業、種族、屬性、背景故事等完整資訊。</textarea>
                        </div>

                        <button class="btn btn-success" onclick="saveTemplates()">儲存所有模板</button>
                    </div>

                    <!-- 備份功能 -->
                    <div style="margin-bottom: 30px;">
                        <h3>☁️ 資料備份</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="exportData()">匯出資料</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">匯入資料</button>
                            <button class="btn btn-success" onclick="connectGoogleDrive()">連接Google Drive</button>
                        </div>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this)" />
                    </div>

                    <!-- Google Drive 狀態 -->
                    <div id="googleDriveStatus" style="margin-top: 20px;">
                        <!-- Google Drive 連接狀態 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 表單彈出層 -->
    <div id="formOverlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 90%; overflow-y: auto;">
            <div id="formContent">
                <!-- 動態表單內容 -->
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentUser = null;
        let currentPage = 'dashboard';
        let appData = {
            characters: [],
            backgrounds: [],
            secrets: [],
            novels: [],
            promptHistory: [],
            settings: {
                password: '1234',
                templates: {}
            }
        };

        // 初始化應用程式
        function initApp() {
            loadData();
            checkLogin();
            initEventListeners();
            loadTemplates();
        }

        // 檢查登入狀態
        function checkLogin() {
            const savedLogin = localStorage.getItem('novelLibraryLogin');
            if (savedLogin) {
                showApp();
            } else {
                showLogin();
            }
        }

        // 登入功能
        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === appData.settings.password) {
                localStorage.setItem('novelLibraryLogin', 'true');
                showApp();
            } else {
                alert('密碼錯誤！');
            }
        }

        // 登出功能
        function logout() {
            localStorage.removeItem('novelLibraryLogin');
            showLogin();
        }

        // 顯示登入頁面
        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        // 顯示主應用程式
        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            updateDashboard();
            renderAllPages();
        }

        // 載入資料
        function loadData() {
            const savedData = localStorage.getItem('novelLibraryData');
            if (savedData) {
                appData = { ...appData, ...JSON.parse(savedData) };
            }
        }

        // 儲存資料
        function saveData() {
            localStorage.setItem('novelLibraryData', JSON.stringify(appData));
        }

        // 初始化事件監聽器
        function initEventListeners() {
            // 導航點擊
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    switchPage(page);
                });
            });

            // 自動調整文字框大小
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('auto-resize-textarea')) {
                    autoResizeTextarea(e.target);
                }
            });

            // 按Enter鍵搜尋
            document.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('search-input')) {
                    const page = getCurrentPage();
                    if (page === 'characters') searchCharacters();
                    else if (page === 'backgrounds') searchBackgrounds();
                    else if (page === 'secrets') searchSecrets();
                    else if (page === 'novels') searchNovels();
                }
            });
        }

        // 頁面切換
        function switchPage(page) {
            // 隱藏所有頁面
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // 顯示目標頁面
            document.getElementById(page).classList.add('active');
            document.querySelector(`[data-page="${page}"]`).classList.add('active');

            currentPage = page;

            // 更新頁面內容
            if (page === 'dashboard') updateDashboard();
            else if (page === 'characters') renderCharacters();
            else if (page === 'backgrounds') renderBackgrounds();
            else if (page === 'secrets') renderSecrets();
            else if (page === 'novels') renderNovels();
            else if (page === 'ai-assistant') renderAIAssistant();
        }

        // 取得當前頁面
        function getCurrentPage() {
            return currentPage;
        }

        // 更新主控台
        function updateDashboard() {
            document.getElementById('characterCount').textContent = appData.characters.length;
            document.getElementById('backgroundCount').textContent = appData.backgrounds.length;
            document.getElementById('secretCount').textContent = appData.secrets.length;
            document.getElementById('novelCount').textContent = appData.novels.length;

            // 顯示最近項目
            const recentItems = [
                ...appData.characters.map(item => ({ ...item, type: 'character' })),
                ...appData.backgrounds.map(item => ({ ...item, type: 'background' })),
                ...appData.secrets.map(item => ({ ...item, type: 'secret' })),
                ...appData.novels.map(item => ({ ...item, type: 'novel' }))
            ].sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt))
             .slice(0, 6);

            const recentContainer = document.getElementById('recentItems');
            recentContainer.innerHTML = recentItems.map(item => createRecentItemCard(item)).join('');
        }

        // 創建最近項目卡片
        function createRecentItemCard(item) {
            const typeEmoji = {
                character: '👤',
                background: '🌍',
                secret: '🔐',
                novel: '📖'
            };

            return `
                <div class="data-card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${typeEmoji[item.type]} ${item.name || item.title}</div>
                            <div style="font-size: 0.8em; color: #666;">
                                ${new Date(item.updatedAt || item.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        ${truncateText(item.description || item.content || '', 100)}
                    </div>
                </div>
            `;
        }

        // 角色相關功能
        function renderCharacters() {
            renderTagFilter('character');
            renderCharacterList();
        }

        function renderCharacterList(filteredData = null) {
            const data = filteredData || appData.characters;
            const container = document.getElementById('characterList');
            
            container.innerHTML = data.map(character => createCharacterCard(character)).join('');
        }

        function createCharacterCard(character) {
            return `
                <div class="data-card" onclick="viewCharacter('${character.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${character.name}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${character.age ? `${character.age}歲` : ''} ${character.race || ''}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-primary" onclick="event.stopPropagation(); editCharacter('${character.id}')">編輯</button>
                            <button class="card-btn btn-danger" onclick="event.stopPropagation(); deleteCharacter('${character.id}')">刪除</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div><strong>外貌：</strong>${truncateText(character.appearance || '', 50)}</div>
                        <div><strong>性格：</strong>${truncateText(character.personality || '', 50)}</div>
                        <div><strong>背景：</strong>${truncateText(character.background || '', 50)}</div>
                    </div>
                    <div class="card-tags">
                        ${(character.tags || []).map(tag => `<span class="tag character">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function showCharacterForm(id = null) {
            const character = id ? appData.characters.find(c => c.id === id) : {};
            const isEdit = !!id;

            const formHTML = `
                <h2>${isEdit ? '編輯角色' : '新增角色'}</h2>
                <form onsubmit="saveCharacter(event, '${id || ''}')">
                    <div class="form-group">
                        <label class="form-label">角色名稱 *</label>
                        <input type="text" class="form-input" name="name" value="${character.name || ''}" required />
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label class="form-label">年齡</label>
                            <input type="text" class="form-input" name="age" value="${character.age || ''}" />
                        </div>
                        <div class="form-col">
                            <label class="form-label">種族</label>
                            <input type="text" class="form-input" name="race" value="${character.race || ''}" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">外貌描述</label>
                        <textarea class="form-textarea" name="appearance">${character.appearance || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">性格特質</label>
                        <textarea class="form-textarea" name="personality">${character.personality || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">背景故事</label>
                        <textarea class="form-textarea large-textarea" name="background">${character.background || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">額外備註</label>
                        <textarea class="form-textarea" name="notes">${character.notes || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">標籤</label>
                        <div class="tag-selector">
                            ${generateTagSelector(['主角', '配角', '反派', '重要', '次要'], character.tags || [])}
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">儲存</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">取消</button>
                    </div>
                </form>
            `;

            showForm(formHTML);
        }

        function saveCharacter(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedTags = Array.from(document.querySelectorAll('.tag-option.selected')).map(el => el.textContent);

            const character = {
                id: id || generateId(),
                name: formData.get('name'),
                age: formData.get('age'),
                race: formData.get('race'),
                appearance: formData.get('appearance'),
                personality: formData.get('personality'),
                background: formData.get('background'),
                notes: formData.get('notes'),
                tags: selectedTags,
                createdAt: id ? appData.characters.find(c => c.id === id).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (id) {
                const index = appData.characters.findIndex(c => c.id === id);
                appData.characters[index] = character;
            } else {
                appData.characters.push(character);
            }

            saveData();
            hideForm();
            renderCharacters();
            if (currentPage === 'dashboard') updateDashboard();
        }

        function editCharacter(id) {
            showCharacterForm(id);
        }

        function deleteCharacter(id) {
            if (confirm('確定要刪除這個角色嗎？')) {
                appData.characters = appData.characters.filter(c => c.id !== id);
                saveData();
                renderCharacters();
                if (currentPage === 'dashboard') updateDashboard();
            }
        }

        function viewCharacter(id) {
            const character = appData.characters.find(c => c.id === id);
            if (!character) return;

            const viewHTML = `
                <h2>👤 ${character.name}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>年齡：</strong>${character.age || '未設定'}<br>
                    <strong>種族：</strong>${character.race || '未設定'}<br>
                    <strong>標籤：</strong>${(character.tags || []).join(', ') || '無'}
                </div>
                
                ${character.appearance ? `<div style="margin-bottom: 15px;"><strong>外貌描述：</strong><br>${character.appearance}</div>` : ''}
                ${character.personality ? `<div style="margin-bottom: 15px;"><strong>性格特質：</strong><br>${character.personality}</div>` : ''}
                ${character.background ? `<div style="margin-bottom: 15px;"><strong>背景故事：</strong><br>${character.background}</div>` : ''}
                ${character.notes ? `<div style="margin-bottom: 15px;"><strong>額外備註：</strong><br>${character.notes}</div>` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editCharacter('${character.id}')">編輯</button>
                    <button class="btn btn-secondary" onclick="hideForm()">關閉</button>
                </div>
            `;

            showForm(viewHTML);
        }

        function searchCharacters() {
            const query = document.getElementById('characterSearch').value.toLowerCase();
            const selectedTags = getSelectedTags('characterTagFilter');
            
            let filtered = appData.characters;

            if (query) {
                filtered = filtered.filter(character => 
                    character.name.toLowerCase().includes(query) ||
                    (character.personality && character.personality.toLowerCase().includes(query)) ||
                    (character.background && character.background.toLowerCase().includes(query))
                );
            }

            if (selectedTags.length > 0) {
                filtered = filtered.filter(character => 
                    selectedTags.some(tag => (character.tags || []).includes(tag))
                );
            }

            renderCharacterList(filtered);
        }

        // 故事背景相關功能
        function renderBackgrounds() {
            renderTagFilter('background');
            renderBackgroundList();
        }

        function renderBackgroundList(filteredData = null) {
            const data = filteredData || appData.backgrounds;
            const container = document.getElementById('backgroundList');
            
            container.innerHTML = data.map(background => createBackgroundCard(background)).join('');
        }

        function createBackgroundCard(background) {
            return `
                <div class="data-card" onclick="viewBackground('${background.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${background.name}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${background.type || ''}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-primary" onclick="event.stopPropagation(); editBackground('${background.id}')">編輯</button>
                            <button class="card-btn btn-danger" onclick="event.stopPropagation(); deleteBackground('${background.id}')">刪除</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div><strong>描述：</strong>${truncateText(background.description || '', 100)}</div>
                        ${background.rules ? `<div><strong>規則：</strong>${truncateText(background.rules, 50)}</div>` : ''}
                    </div>
                    <div class="card-tags">
                        ${(background.tags || []).map(tag => `<span class="tag location">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function showBackgroundForm(id = null) {
            const background = id ? appData.backgrounds.find(b => b.id === id) : {};
            const isEdit = !!id;

            const formHTML = `
                <h2>${isEdit ? '編輯背景' : '新增背景'}</h2>
                <form onsubmit="saveBackground(event, '${id || ''}')">
                    <div class="form-group">
                        <label class="form-label">場景名稱 *</label>
                        <input type="text" class="form-input" name="name" value="${background.name || ''}" required />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">類型</label>
                        <select class="form-select" name="type">
                            <option value="">選擇類型</option>
                            <option value="地點" ${background.type === '地點' ? 'selected' : ''}>地點</option>
                            <option value="時代" ${background.type === '時代' ? 'selected' : ''}>時代</option>
                            <option value="世界觀" ${background.type === '世界觀' ? 'selected' : ''}>世界觀</option>
                            <option value="文化" ${background.type === '文化' ? 'selected' : ''}>文化</option>
                            <option value="其他" ${background.type === '其他' ? 'selected' : ''}>其他</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">詳細描述</label>
                        <textarea class="form-textarea large-textarea" name="description">${background.description || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">規則/法則</label>
                        <textarea class="form-textarea" name="rules">${background.rules || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <textarea class="form-textarea" name="notes">${background.notes || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">標籤</label>
                        <div class="tag-selector">
                            ${generateTagSelector(['地點', '時代', '世界觀', '文化', '重要', '次要'], background.tags || [])}
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">儲存</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">取消</button>
                    </div>
                </form>
            `;

            showForm(formHTML);
        }

        function saveBackground(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedTags = Array.from(document.querySelectorAll('.tag-option.selected')).map(el => el.textContent);

            const background = {
                id: id || generateId(),
                name: formData.get('name'),
                type: formData.get('type'),
                description: formData.get('description'),
                rules: formData.get('rules'),
                notes: formData.get('notes'),
                tags: selectedTags,
                createdAt: id ? appData.backgrounds.find(b => b.id === id).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (id) {
                const index = appData.backgrounds.findIndex(b => b.id === id);
                appData.backgrounds[index] = background;
            } else {
                appData.backgrounds.push(background);
            }

            saveData();
            hideForm();
            renderBackgrounds();
            if (currentPage === 'dashboard') updateDashboard();
        }

        function editBackground(id) {
            showBackgroundForm(id);
        }

        function deleteBackground(id) {
            if (confirm('確定要刪除這個背景設定嗎？')) {
                appData.backgrounds = appData.backgrounds.filter(b => b.id !== id);
                saveData();
                renderBackgrounds();
                if (currentPage === 'dashboard') updateDashboard();
            }
        }

        function viewBackground(id) {
            const background = appData.backgrounds.find(b => b.id === id);
            if (!background) return;

            const viewHTML = `
                <h2>🌍 ${background.name}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>類型：</strong>${background.type || '未設定'}<br>
                    <strong>標籤：</strong>${(background.tags || []).join(', ') || '無'}
                </div>
                
                ${background.description ? `<div style="margin-bottom: 15px;"><strong>詳細描述：</strong><br>${background.description}</div>` : ''}
                ${background.rules ? `<div style="margin-bottom: 15px;"><strong>規則/法則：</strong><br>${background.rules}</div>` : ''}
                ${background.notes ? `<div style="margin-bottom: 15px;"><strong>備註：</strong><br>${background.notes}</div>` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editBackground('${background.id}')">編輯</button>
                    <button class="btn btn-secondary" onclick="hideForm()">關閉</button>
                </div>
            `;

            showForm(viewHTML);
        }

        function searchBackgrounds() {
            const query = document.getElementById('backgroundSearch').value.toLowerCase();
            const selectedTags = getSelectedTags('backgroundTagFilter');
            
            let filtered = appData.backgrounds;

            if (query) {
                filtered = filtered.filter(background => 
                    background.name.toLowerCase().includes(query) ||
                    (background.description && background.description.toLowerCase().includes(query)) ||
                    (background.type && background.type.toLowerCase().includes(query))
                );
            }

            if (selectedTags.length > 0) {
                filtered = filtered.filter(background => 
                    selectedTags.some(tag => (background.tags || []).includes(tag))
                );
            }

            renderBackgroundList(filtered);
        }

        // 秘密設定相關功能
        function renderSecrets() {
            renderTagFilter('secret');
            renderSecretList();
        }

        function renderSecretList(filteredData = null) {
            const data = filteredData || appData.secrets;
            const container = document.getElementById('secretList');
            
            container.innerHTML = data.map(secret => createSecretCard(secret)).join('');
        }

        function createSecretCard(secret) {
            return `
                <div class="data-card" onclick="viewSecret('${secret.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${secret.title}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${secret.category || ''}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-primary" onclick="event.stopPropagation(); editSecret('${secret.id}')">編輯</button>
                            <button class="card-btn btn-danger" onclick="event.stopPropagation(); deleteSecret('${secret.id}')">刪除</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="spoiler-warning">⚠️ 劇透內容，點擊查看詳情</div>
                        ${secret.impact ? `<div><strong>重要性：</strong>${truncateText(secret.impact, 50)}</div>` : ''}
                    </div>
                    <div class="card-tags">
                        ${(secret.tags || []).map(tag => `<span class="tag secret">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function showSecretForm(id = null) {
            const secret = id ? appData.secrets.find(s => s.id === id) : {};
            const isEdit = !!id;

            const formHTML = `
                <h2>${isEdit ? '編輯秘密設定' : '新增秘密設定'}</h2>
                <form onsubmit="saveSecret(event, '${id || ''}')">
                    <div class="form-group">
                        <label class="form-label">標題 *</label>
                        <input type="text" class="form-input" name="title" value="${secret.title || ''}" required />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">類別</label>
                        <select class="form-select" name="category">
                            <option value="">選擇類別</option>
                            <option value="劇情轉折" ${secret.category === '劇情轉折' ? 'selected' : ''}>劇情轉折</option>
                            <option value="角色秘密" ${secret.category === '角色秘密' ? 'selected' : ''}>角色秘密</option>
                            <option value="世界設定" ${secret.category === '世界設定' ? 'selected' : ''}>世界設定</option>
                            <option value="伏筆" ${secret.category === '伏筆' ? 'selected' : ''}>伏筆</option>
                            <option value="結局" ${secret.category === '結局' ? 'selected' : ''}>結局</option>
                            <option value="其他" ${secret.category === '其他' ? 'selected' : ''}>其他</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">內容</label>
                        <textarea class="form-textarea large-textarea" name="content">${secret.content || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">影響/重要性</label>
                        <textarea class="form-textarea" name="impact">${secret.impact || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">知情人</label>
                        <input type="text" class="form-input" name="knownBy" value="${secret.knownBy || ''}" placeholder="誰知道這個秘密？" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">標籤</label>
                        <div class="tag-selector">
                            ${generateTagSelector(['劇情', '角色', '世界', '伏筆', '重要', '次要'], secret.tags || [])}
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">儲存</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">取消</button>
                    </div>
                </form>
            `;

            showForm(formHTML);
        }

        function saveSecret(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const selectedTags = Array.from(document.querySelectorAll('.tag-option.selected')).map(el => el.textContent);

            const secret = {
                id: id || generateId(),
                title: formData.get('title'),
                category: formData.get('category'),
                content: formData.get('content'),
                impact: formData.get('impact'),
                knownBy: formData.get('knownBy'),
                tags: selectedTags,
                createdAt: id ? appData.secrets.find(s => s.id === id).createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (id) {
                const index = appData.secrets.findIndex(s => s.id === id);
                appData.secrets[index] = secret;
            } else {
                appData.secrets.push(secret);
            }

            saveData();
            hideForm();
            renderSecrets();
            if (currentPage === 'dashboard') updateDashboard();
        }

        function editSecret(id) {
            showSecretForm(id);
        }

        function deleteSecret(id) {
            if (confirm('確定要刪除這個秘密設定嗎？')) {
                appData.secrets = appData.secrets.filter(s => s.id !== id);
                saveData();
                renderSecrets();
                if (currentPage === 'dashboard') updateDashboard();
            }
        }

        function viewSecret(id) {
            const secret = appData.secrets.find(s => s.id === id);
            if (!secret) return;

            const viewHTML = `
                <h2>🔐 ${secret.title}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>類別：</strong>${secret.category || '未設定'}<br>
                    <strong>知情人：</strong>${secret.knownBy || '未設定'}<br>
                    <strong>標籤：</strong>${(secret.tags || []).join(', ') || '無'}
                </div>
                
                <div class="spoiler-warning">⚠️ 以下包含劇透內容</div>
                
                ${secret.content ? `<div style="margin-bottom: 15px;"><strong>內容：</strong><br>${secret.content}</div>` : ''}
                ${secret.impact ? `<div style="margin-bottom: 15px;"><strong>影響/重要性：</strong><br>${secret.impact}</div>` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editSecret('${secret.id}')">編輯</button>
                    <button class="btn btn-secondary" onclick="hideForm()">關閉</button>
                </div>
            `;

            showForm(viewHTML);
        }

        function searchSecrets() {
            const query = document.getElementById('secretSearch').value.toLowerCase();
            const selectedTags = getSelectedTags('secretTagFilter');
            
            let filtered = appData.secrets;

            if (query) {
                filtered = filtered.filter(secret => 
                    secret.title.toLowerCase().includes(query) ||
                    (secret.content && secret.content.toLowerCase().includes(query)) ||
                    (secret.category && secret.category.toLowerCase().includes(query))
                );
            }

            if (selectedTags.length > 0) {
                filtered = filtered.filter(secret => 
                    selectedTags.some(tag => (secret.tags || []).includes(tag))
                );
            }

            renderSecretList(filtered);
        }

        // 小說相關功能
        function renderNovels() {
            renderNovelList();
        }

        function renderNovelList(filteredData = null) {
            const data = filteredData || appData.novels;
            const container = document.getElementById('novelList');
            
            container.innerHTML = data.map(novel => createNovelCard(novel)).join('');
        }

        function createNovelCard(novel) {
            const wordCount = (novel.content || '').length;
            return `
                <div class="data-card" onclick="viewNovel('${novel.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${novel.title}</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${wordCount} 字 | ${new Date(novel.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-btn btn-primary" onclick="event.stopPropagation(); editNovel('${novel.id}')">編輯</button>
                            <button class="card-btn btn-danger" onclick="event.stopPropagation(); deleteNovel('${novel.id}')">刪除</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div><strong>提示詞：</strong>${truncateText(novel.prompt || '', 100)}</div>
                        <div><strong>內容：</strong>${truncateText(novel.content || '', 100)}</div>
                        ${novel.rating ? `<div><strong>評價：</strong>${novel.rating}</div>` : ''}
                    </div>
                    <div class="card-tags">
                        ${(novel.relatedMaterials || []).map(material => `<span class="tag character">${material}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function saveNovel(title, prompt, content, relatedMaterials = []) {
            const novel = {
                id: generateId(),
                title,
                prompt,
                content,
                relatedMaterials,
                rating: '',
                notes: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            appData.novels.push(novel);
            saveData();
            
            if (currentPage === 'novels') renderNovels();
            if (currentPage === 'dashboard') updateDashboard();

            return novel.id;
        }

        function editNovel(id) {
            const novel = appData.novels.find(n => n.id === id);
            if (!novel) return;

            const formHTML = `
                <h2>編輯小說</h2>
                <form onsubmit="updateNovel(event, '${id}')">
                    <div class="form-group">
                        <label class="form-label">標題</label>
                        <input type="text" class="form-input" name="title" value="${novel.title}" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">提示詞</label>
                        <textarea class="form-textarea" name="prompt">${novel.prompt || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">小說內容</label>
                        <textarea class="form-textarea large-textarea" name="content">${novel.content || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">評價/備註</label>
                        <textarea class="form-textarea" name="notes">${novel.notes || ''}</textarea>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">儲存</button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">取消</button>
                    </div>
                </form>
            `;

            showForm(formHTML);
        }

        function updateNovel(event, id) {
            event.preventDefault();
            const formData = new FormData(event.target);

            const index = appData.novels.findIndex(n => n.id === id);
            if (index !== -1) {
                appData.novels[index] = {
                    ...appData.novels[index],
                    title: formData.get('title'),
                    prompt: formData.get('prompt'),
                    content: formData.get('content'),
                    notes: formData.get('notes'),
                    updatedAt: new Date().toISOString()
                };

                saveData();
                hideForm();
                renderNovels();
            }
        }

        function deleteNovel(id) {
            if (confirm('確定要刪除這篇小說嗎？')) {
                appData.novels = appData.novels.filter(n => n.id !== id);
                saveData();
                renderNovels();
                if (currentPage === 'dashboard') updateDashboard();
            }
        }

        function viewNovel(id) {
            const novel = appData.novels.find(n => n.id === id);
            if (!novel) return;

            const wordCount = (novel.content || '').length;
            const viewHTML = `
                <h2>📖 ${novel.title}</h2>
                <div style="margin-bottom: 20px;">
                    <strong>字數：</strong>${wordCount}<br>
                    <strong>創建時間：</strong>${new Date(novel.createdAt).toLocaleString()}<br>
                    <strong>最後修改：</strong>${new Date(novel.updatedAt).toLocaleString()}
                </div>

                ${novel.prompt ? `<div style="margin-bottom: 15px;"><strong>使用的提示詞：</strong><br><div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">${novel.prompt}</div></div>` : ''}
                
                <div style="margin-bottom: 15px;"><strong>小說內容：</strong><br>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; white-space: pre-wrap;">${novel.content || ''}</div></div>

                ${novel.notes ? `<div style="margin-bottom: 15px;"><strong>備註/評價：</strong><br>${novel.notes}</div>` : ''}

                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editNovel('${novel.id}')">編輯</button>
                    <button class="btn btn-secondary" onclick="copyNovelContent('${novel.id}')">複製內容</button>
                    <button class="btn btn-secondary" onclick="hideForm()">關閉</button>
                </div>
            `;

            showForm(viewHTML);
        }

        function copyNovelContent(id) {
            const novel = appData.novels.find(n => n.id === id);
            if (novel && novel.content) {
                navigator.clipboard.writeText(novel.content).then(() => {
                    alert('小說內容已複製到剪貼簿！');
                });
            }
        }

        function searchNovels() {
            const query = document.getElementById('novelSearch').value.toLowerCase();
            
            let filtered = appData.novels;

            if (query) {
                filtered = filtered.filter(novel => 
                    novel.title.toLowerCase().includes(query) ||
                    (novel.content && novel.content.toLowerCase().includes(query)) ||
                    (novel.prompt && novel.prompt.toLowerCase().includes(query))
                );
            }

            renderNovelList(filtered);
        }

        function sortNovels() {
            const sortType = document.getElementById('novelSort').value;
            let sorted = [...appData.novels];

            switch(sortType) {
                case 'date':
                    sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'title':
                    sorted.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'length':
                    sorted.sort((a, b) => (b.content || '').length - (a.content || '').length);
                    break;
            }

            renderNovelList(sorted);
        }

        // AI助手相關功能
        function renderAIAssistant() {
            updateMaterialSelectors();
            loadPromptHistory();
        }

        function updateMaterialSelectors() {
            // 角色選擇器
            const characterContainer = document.getElementById('aiCharacterList');
            characterContainer.innerHTML = appData.characters.map(character => 
                `<div class="material-item" data-type="character" data-id="${character.id}">${character.name}</div>`
            ).join('');

            // 背景選擇器
            const backgroundContainer = document.getElementById('aiBackgroundList');
            backgroundContainer.innerHTML = appData.backgrounds.map(background => 
                `<div class="material-item" data-type="background" data-id="${background.id}">${background.name}</div>`
            ).join('');

            // 秘密設定選擇器
            const secretContainer = document.getElementById('aiSecretList');
            secretContainer.innerHTML = appData.secrets.map(secret => 
                `<div class="material-item" data-type="secret" data-id="${secret.id}">${secret.title}</div>`
            ).join('');

            // 添加點擊事件
            document.querySelectorAll('.material-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('selected');
                });
            });
        }

        function useTemplate(type) {
            const templates = {
                story: appData.settings.templates.story || `根據以下素材，創作一個完整的故事：

角色設定：
{characters}

故事背景：
{backgrounds}

秘密設定：
{secrets}

請創作一個引人入勝的故事，注意角色發展和劇情轉折。`,

                dialogue: appData.settings.templates.dialogue || `基於以下角色設定，創作一段對話：

角色設定：
{characters}

場景背景：
{backgrounds}

請創作符合角色性格的自然對話。`,

                scene: appData.settings.templates.scene || `根據以下背景設定，創作詳細的場景描述：

背景設定：
{backgrounds}

請創作生動細緻的場景描述。`,

                analysis: appData.settings.templates.analysis || `分析以下故事素材，提供劇情建議：

所有素材：
{characters}
{backgrounds}
{secrets}

請分析這些素材的潛在劇情發展可能性。`,

                dnd: appData.settings.templates.dnd || `基於以下角色設定，創建一個DND角色：

角色設定：
{characters}

請包含職業、種族、屬性、背景故事等完整資訊。`
            };

            document.getElementById('customPrompt').value = templates[type];
            autoResizeTextarea(document.getElementById('customPrompt'));
        }

        function generatePrompt() {
            const selectedMaterials = getSelectedMaterials();
            const additionalReq = document.getElementById('additionalRequirements').value.trim();
            let prompt = document.getElementById('customPrompt').value;
        
            // 修正角色資訊組合
            prompt = prompt.replace('{characters}', selectedMaterials.characters.map(c => {
                let charInfo = `${c.name}:`;
                if (c.age) charInfo += ` 年齡${c.age}歲`;
                if (c.race) charInfo += ` (${c.race})`;
                if (c.appearance) charInfo += `\n  外貌: ${c.appearance}`;
                if (c.personality) charInfo += `\n  性格: ${c.personality}`;
                if (c.background) charInfo += `\n  背景: ${c.background}`;
                if (c.notes) charInfo += `\n  備註: ${c.notes}`;
                return charInfo;
            }).join('\n\n'));
        
            prompt = prompt.replace('{backgrounds}', selectedMaterials.backgrounds.map(b => {
                let bgInfo = `${b.name}:`;
                if (b.type) bgInfo += ` (${b.type})`;
                if (b.description) bgInfo += `\n  描述: ${b.description}`;
                if (b.rules) bgInfo += `\n  規則: ${b.rules}`;
                if (b.notes) bgInfo += `\n  備註: ${b.notes}`;
                return bgInfo;
            }).join('\n\n'));
        
            prompt = prompt.replace('{secrets}', selectedMaterials.secrets.map(s => {
                let secretInfo = `${s.title}:`;
                if (s.category) secretInfo += ` (${s.category})`;
                if (s.content) secretInfo += `\n  內容: ${s.content}`;
                if (s.impact) secretInfo += `\n  影響: ${s.impact}`;
                return secretInfo;
            }).join('\n\n'));
        
            // 🆕 添加額外要求
            if (additionalReq) {
                prompt += '\n\n額外要求：\n' + additionalReq;
            }
        
            document.getElementById('customPrompt').value = prompt;
            autoResizeTextarea(document.getElementById('customPrompt'));
        }



        function getSelectedMaterials() {
            const selectedItems = document.querySelectorAll('.material-item.selected');
            const materials = { characters: [], backgrounds: [], secrets: [] };

            selectedItems.forEach(item => {
                const type = item.dataset.type;
                const id = item.dataset.id;

                if (type === 'character') {
                    const character = appData.characters.find(c => c.id === id);
                    if (character) materials.characters.push(character);
                } else if (type === 'background') {
                    const background = appData.backgrounds.find(b => b.id === id);
                    if (background) materials.backgrounds.push(background);
                } else if (type === 'secret') {
                    const secret = appData.secrets.find(s => s.id === id);
                    if (secret) materials.secrets.push(secret);
                }
            });

            return materials;
        }

        function sendToPerplexity() {
            const prompt = document.getElementById('customPrompt').value;
            if (!prompt.trim()) {
                alert('請先輸入或生成提示詞！');
                return;
            }

            // 儲存到歷史記錄
            savePromptToHistory(prompt);

            // 開啟 Perplexity
            const encodedPrompt = encodeURIComponent(prompt);
            window.open(`https://www.perplexity.ai/?q=${encodedPrompt}`, '_blank');
        }

        function copyPrompt() {
            const prompt = document.getElementById('customPrompt').value;
            if (prompt.trim()) {
                navigator.clipboard.writeText(prompt).then(() => {
                    alert('提示詞已複製到剪貼簿！');
                });
            }
        }

        function savePromptTemplate() {
            const prompt = document.getElementById('customPrompt').value;
            const title = prompt('請輸入模板名稱：');
            
            if (title && prompt.trim()) {
                if (!appData.settings.customTemplates) {
                    appData.settings.customTemplates = [];
                }
                
                appData.settings.customTemplates.push({
                    id: generateId(),
                    title,
                    content: prompt,
                    createdAt: new Date().toISOString()
                });
                
                saveData();
                alert('模板已儲存！');
            }
        }

        function savePromptToHistory(prompt) {
            const selectedMaterials = getSelectedMaterials();
            const historyItem = {
                id: generateId(),
                prompt,
                materials: selectedMaterials,
                createdAt: new Date().toISOString()
            };

            appData.promptHistory.unshift(historyItem);
            
            // 只保留最近50個
            if (appData.promptHistory.length > 50) {
                appData.promptHistory = appData.promptHistory.slice(0, 50);
            }

            saveData();
            loadPromptHistory();
        }

        function loadPromptHistory() {
            const container = document.getElementById('promptHistory');
            container.innerHTML = appData.promptHistory.slice(0, 10).map(item => 
                createPromptHistoryCard(item)
            ).join('');
        }

        function createPromptHistoryCard(item) {
            const materialCount = 
                item.materials.characters.length + 
                item.materials.backgrounds.length + 
                item.materials.secrets.length;

            return `
                <div class="data-card" onclick="usePromptFromHistory('${item.id}')">
                    <div class="card-header">
                        <div>
                            <div class="card-title">歷史提示詞</div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${new Date(item.createdAt).toLocaleString()} | ${materialCount} 個素材
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        ${truncateText(item.prompt, 150)}
                    </div>
                </div>
            `;
        }

        function usePromptFromHistory(id) {
            const item = appData.promptHistory.find(h => h.id === id);
            if (item) {
                document.getElementById('customPrompt').value = item.prompt;
                autoResizeTextarea(document.getElementById('customPrompt'));

                // 重新選擇相關素材
                document.querySelectorAll('.material-item').forEach(el => {
                    el.classList.remove('selected');
                });

                item.materials.characters.forEach(character => {
                    const el = document.querySelector(`[data-type="character"][data-id="${character.id}"]`);
                    if (el) el.classList.add('selected');
                });

                item.materials.backgrounds.forEach(background => {
                    const el = document.querySelector(`[data-type="background"][data-id="${background.id}"]`);
                    if (el) el.classList.add('selected');
                });

                item.materials.secrets.forEach(secret => {
                    const el = document.querySelector(`[data-type="secret"][data-id="${secret.id}"]`);
                    if (el) el.classList.add('selected');
                });
            }
        }

        // 設定相關功能
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (newPassword.trim()) {
                appData.settings.password = newPassword;
                saveData();
                alert('密碼已更新！');
                document.getElementById('newPassword').value = '';
            }
        }

        function loadTemplates() {
            // 載入預設模板到設定
            if (!appData.settings.templates) {
                appData.settings.templates = {
                    story: `根據以下素材，創作一個完整的故事：

角色設定：
{characters}

故事背景：
{backgrounds}

秘密設定：
{secrets}

請創作一個引人入勝的故事，注意角色發展和劇情轉折。`,
                    dialogue: `基於以下角色設定，創作一段對話：

角色設定：
{characters}

場景背景：
{backgrounds}

請創作符合角色性格的自然對話。`,
                    scene: `根據以下背景設定，創作詳細的場景描述：

背景設定：
{backgrounds}

請創作生動細緻的場景描述。`,
                    analysis: `分析以下故事素材，提供劇情建議：

所有素材：
{characters}
{backgrounds}
{secrets}

請分析這些素材的潛在劇情發展可能性。`,
                    dnd: `基於以下角色設定，創建一個DND角色：

角色設定：
{characters}

請包含職業、種族、屬性、背景故事等完整資訊。`
                };
                saveData();
            }

            // 更新設定頁面的模板內容
            if (document.getElementById('storyTemplate')) {
                document.getElementById('storyTemplate').value = appData.settings.templates.story || '';
                document.getElementById('dialogueTemplate').value = appData.settings.templates.dialogue || '';
                document.getElementById('sceneTemplate').value = appData.settings.templates.scene || '';
                document.getElementById('analysisTemplate').value = appData.settings.templates.analysis || '';
                document.getElementById('dndTemplate').value = appData.settings.templates.dnd || '';
            }
        }

        function saveTemplates() {
            appData.settings.templates = {
                story: document.getElementById('storyTemplate').value,
                dialogue: document.getElementById('dialogueTemplate').value,
                scene: document.getElementById('sceneTemplate').value,
                analysis: document.getElementById('analysisTemplate').value,
                dnd: document.getElementById('dndTemplate').value
            };
            saveData();
            alert('所有模板已儲存！');
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `novel-library-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('確定要匯入資料嗎？這將覆蓋現有資料！')) {
                        appData = { ...appData, ...importedData };
                        saveData();
                        alert('資料匯入成功！');
                        location.reload(); // 重新載入頁面
                    }
                } catch (error) {
                    alert('匯入失敗：檔案格式錯誤！');
                }
            };
            reader.readAsText(file);
            
            // 清空input
            input.value = '';
        }

        function connectGoogleDrive() {
            alert('Google Drive 整合功能需要進一步開發，目前請使用匯出/匯入功能進行備份。');
        }

        // 通用工具函數
        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function generateTagSelector(availableTags, selectedTags = []) {
            return availableTags.map(tag => 
                `<div class="tag-option ${selectedTags.includes(tag) ? 'selected' : ''}" onclick="toggleTag(this)">${tag}</div>`
            ).join('');
        }

        function toggleTag(element) {
            element.classList.toggle('selected');
        }

        function renderTagFilter(type) {
            const filterId = type + 'TagFilter';
            const container = document.getElementById(filterId);
            
            let allTags = [];
            if (type === 'character') {
                allTags = ['主角', '配角', '反派', '重要', '次要'];
            } else if (type === 'background') {
                allTags = ['地點', '時代', '世界觀', '文化', '重要', '次要'];
            } else if (type === 'secret') {
                allTags = ['劇情', '角色', '世界', '伏筆', '重要', '次要'];
            }

            container.innerHTML = allTags.map(tag => 
                `<span class="tag ${type}" onclick="toggleFilterTag(this, '${type}')">${tag}</span>`
            ).join('');
        }

        function toggleFilterTag(element, type) {
            element.classList.toggle('selected');
            
            // 觸發相應的搜尋函數
            if (type === 'character') searchCharacters();
            else if (type === 'background') searchBackgrounds();
            else if (type === 'secret') searchSecrets();
        }

        function getSelectedTags(containerId) {
            const container = document.getElementById(containerId);
            return Array.from(container.querySelectorAll('.tag.selected')).map(el => el.textContent);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function showForm(html) {
            document.getElementById('formContent').innerHTML = html;
            document.getElementById('formOverlay').classList.remove('hidden');
        }

        function hideForm() {
            document.getElementById('formOverlay').classList.add('hidden');
        }

        function renderAllPages() {
            renderCharacters();
            renderBackgrounds();
            renderSecrets();
            renderNovels();
            renderAIAssistant();
            loadTemplates();
        }

        // 啟動應用程式
        document.addEventListener('DOMContentLoaded', initApp);

        // 點擊表單外部關閉表單
        document.getElementById('formOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                hideForm();
            }
        });
    </script>
</body>
</html>
